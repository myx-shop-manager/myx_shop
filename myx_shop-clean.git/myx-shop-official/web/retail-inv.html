<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BursaæŠ•èµ„è®¡ç®—å™¨ - ä½¿ç”¨çœŸå®AIæ•°æ®</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2196F3;
            --primary-dark: #1976D2;
            --secondary: #4CAF50;
            --secondary-dark: #388E3C;
            --warning: #FF9800;
            --danger: #F44336;
            --success: #4CAF50;
            --light: #F5F7FA;
            --dark: #333333;
            --gray: #666666;
            --light-gray: #EEEEEE;
            --white: #FFFFFF;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --warrant-color: #9C27B0;
            --warrant-bg: #F3E5F5;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.5;
            min-height: 100vh;
            padding: 0;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: var(--white);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-title i {
            font-size: 20px;
        }
        
        .app-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* æ ‡ç­¾é¡µåˆ‡æ¢ */
        .tab-bar {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 90px;
            z-index: 99;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        
        .tab i {
            margin-right: 5px;
            font-size: 16px;
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .content {
            padding: 15px;
            min-height: calc(100vh - 180px);
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-gray);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title i {
            font-size: 18px;
        }
        
        /* æ—¥æœŸé€‰æ‹©å™¨ */
        .date-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--light);
            border-radius: var(--radius-sm);
        }
        
        .date-picker label {
            font-weight: 500;
            color: var(--gray);
            white-space: nowrap;
        }
        
        #dateSelect {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            background: white;
            font-size: 14px;
        }
        
        /* è‚¡ç¥¨åˆ—è¡¨ */
        .stocks-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .stock-item {
            padding: 15px;
            margin-bottom: 10px;
            background: var(--light);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--primary);
            position: relative;
            transition: all 0.3s;
        }
        
        .stock-item.warrant {
            border-left-color: var(--warrant-color);
            background: var(--warrant-bg);
        }
        
        .stock-item.high-risk {
            border-left-color: var(--danger);
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
        }
        
        .stock-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stock-item.selected {
            background: #E8F5E9;
            border-left-color: var(--success);
        }
        
        .stock-rank {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .stock-rank.warrant {
            background: var(--warrant-color);
        }
        
        .stock-rank.high-risk {
            background: var(--danger);
        }
        
        .stock-basic {
            margin-bottom: 10px;
        }
        
        .stock-code {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stock-code.warrant {
            color: var(--warrant-color);
        }
        
        .stock-code.high-risk {
            color: var(--danger);
        }
        
        .stock-name {
            font-size: 13px;
            color: var(--gray);
            margin-top: 2px;
        }
        
        .stock-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 8px 0;
        }
        
        .tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tag.strong-buy {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        .tag.buy {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }
        
        .tag.caution {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }
        
        .tag.warrant {
            background: rgba(156, 39, 176, 0.1);
            color: var(--warrant-color);
        }
        
        .tag.stock {
            background: rgba(33, 150, 243, 0.1);
            color: var(--primary);
        }
        
        .stock-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .price {
            font-size: 18px;
            font-weight: bold;
            color: var(--success);
        }
        
        .price-change {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .price-change.positive {
            background: #E8F5E9;
            color: var(--success);
        }
        
        .price-change.negative {
            background: #FFEBEE;
            color: var(--danger);
        }
        
        .stock-ai-score {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .score-item {
            flex: 1;
            text-align: center;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }
        
        .score-label {
            color: var(--gray);
            font-size: 10px;
            margin-bottom: 2px;
        }
        
        .score-value {
            font-weight: bold;
        }
        
        .select-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .select-btn.warrant {
            background: var(--warrant-color);
        }
        
        .select-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .select-btn.selected {
            background: var(--success);
        }
        
        .select-btn i {
            font-size: 14px;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-label i {
            color: var(--primary);
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group .form-input {
            flex: 1;
        }
        
        /* è´¹ç”¨è®¾ç½® */
        .fee-settings {
            background: var(--light);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin: 15px 0;
        }
        
        .fee-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .fee-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #ddd;
        }
        
        /* ç»“æœåŒºåŸŸ */
        .result-card {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            margin-top: 20px;
        }
        
        .result-main {
            font-size: 32px;
            font-weight: bold;
            color: var(--success);
            margin: 10px 0;
        }
        
        .result-positive {
            color: var(--success);
        }
        
        .result-negative {
            color: var(--danger);
        }
        
        .result-sub {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 15px;
        }
        
        .result-details {
            background: white;
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-top: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-gray);
            font-size: 14px;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            font-weight: bold;
            padding-top: 15px;
            border-top: 2px solid var(--light-gray);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loading i {
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .error {
            background: #FFEBEE;
            color: var(--danger);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            border-left: 4px solid var(--danger);
        }
        
        /* åº•éƒ¨å¯¼èˆª */
        .app-footer {
            background: white;
            padding: 15px;
            border-top: 1px solid var(--light-gray);
            position: sticky;
            bottom: 0;
            z-index: 100;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .container {
                border-radius: 0;
            }
            
            .app-header {
                padding: 15px;
            }
            
            .content {
                padding: 12px;
            }
            
            .card {
                padding: 15px;
            }
            
            .fee-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .input-group {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        /* è§¦æ‘¸ä¼˜åŒ– */
        .touch-feedback {
            transition: transform 0.1s;
        }
        
        .touch-feedback:active {
            transform: scale(0.98);
        }
        
        /* æ»šåŠ¨æ¡ä¼˜åŒ– */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        /* æ•°æ®æºé€‰æ‹© */
        .data-source-selector {
            background: var(--light);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin: 10px 0;
        }
        
        .source-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .source-btn {
            flex: 1;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            font-size: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .source-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* è‚¡ç¥¨è¯¦æƒ… */
        .stock-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
        }
        
        .stock-detail-content {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="app-header">
            <div class="header-content">
                <div>
                    <div class="app-title">
                        <i class="fas fa-chart-line"></i>
                        <span>Bursa AIæŠ•èµ„è®¡ç®—å™¨</span>
                        <span id="connectionStatus" style="font-size: 8px; background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px;">åœ¨çº¿</span>
                    </div>
                    <div class="app-subtitle">çœŸå®AIæ•°æ® + ç²¾ç¡®è´¹ç”¨è®¡ç®—</div>
                </div>
                <div style="font-size: 12px; opacity: 0.9;">
                    <div>æ›´æ–°: <span id="dataUpdateDate">2025-12-18</span></div>
                    <div>ç›®æ ‡åˆ©æ¶¦: RM5</div>
                </div>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('stocks')">
                <i class="fas fa-star"></i> AIé€‰è‚¡
            </div>
            <div class="tab" onclick="switchTab('calculator')">
                <i class="fas fa-calculator"></i> è®¡ç®—å™¨
            </div>
            <div class="tab" onclick="switchTab('results')">
                <i class="fas fa-chart-pie"></i> ç»“æœ
            </div>
        </div>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content">
            <!-- AIé€‰è‚¡æ ‡ç­¾é¡µ -->
            <div id="stocks-tab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-filter"></i> æ•°æ®æºé€‰æ‹©
                        </div>
                        <div style="font-size: 12px; color: var(--gray);">
                            <i class="fas fa-database"></i> <span id="currentSource">æœ¬åœ°JSON</span>
                        </div>
                    </div>
                    
                    <div class="data-source-selector">
                        <label>é€‰æ‹©æ•°æ®æ¥æº:</label>
                        <div class="source-buttons">
                            <div class="source-btn active" onclick="setDataSource('local')">
                                <i class="fas fa-file-alt"></i><br>
                                è™•æ“¬
                            </div>
                            <div class="source-btn" onclick="setDataSource('picks_latest')">
                                <i class="fas fa-bolt"></i><br>
                                æœ€æ–° Ai é¸è‚¡
                            </div>
                            <div class="source-btn" onclick="setDataSource('history')">
                                <i class="fas fa-history"></i><br>
                                éå» Ai é¸è‚¡ 
                            </div>
                        </div>
                    </div>
                    
                    <div class="date-picker" id="datePickerSection" style="display: none;">
                        <label for="dateSelect"><i class="far fa-calendar-alt"></i> é€‰æ‹©æ—¥æœŸ:</label>
                        <select id="dateSelect">
                            <!-- æ—¥æœŸé€‰é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    
                    <div class="source-buttons">
                        <div class="source-btn" onclick="loadAIData()" style="background: var(--secondary); color: white;">
                            <i class="fas fa-sync-alt"></i> åŠ è½½AIæ•°æ®
                        </div>
                        <div class="source-btn" onclick="loadPriceData()" style="background: var(--primary); color: white;">
                            <i class="fas fa-chart-line"></i> åŠ è½½è‚¡ä»·
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-line"></i> AIæ¨èè‚¡ç¥¨åˆ—è¡¨
                        </div>
                        <span id="stocksCount" style="font-size: 12px; color: var(--gray);">è¯·åŠ è½½æ•°æ®</span>
                    </div>
                    
                    <div id="filterSection" style="margin-bottom: 15px;">
                        <select id="typeFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--radius-sm); margin-bottom: 10px;">
                            <option value="all">æ‰€æœ‰ç±»å‹</option>
                            <option value="Warrant">è®¤è‚¡æƒè¯</option>
                            <option value="Stock">æ™®é€šè‚¡</option>
                        </select>
                        <input type="text" id="searchFilter" placeholder="æœç´¢è‚¡ç¥¨ä»£ç æˆ–åç§°..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--radius-sm);">
                    </div>
                    
                    <div id="aiStocksList" class="stocks-list">
                        <div class="loading">
                            <i class="fas fa-database"></i>
                            <p>è¯·é€‰æ‹©æ•°æ®æ¥æºå¹¶åŠ è½½æ•°æ®</p>
                            <p style="font-size: 12px; margin-top: 10px; color: var(--primary);">
                                æ”¯æŒ: picks_latest.json, history/*.json, æœ¬åœ°æ•°æ®
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®¡ç®—å™¨æ ‡ç­¾é¡µ -->
            <div id="calculator-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-edit"></i> è‚¡ç¥¨ä¿¡æ¯
                        </div>
                        <div style="font-size: 12px; color: var(--gray);" id="selectedStockInfo">æœªé€‰æ‹©</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stockCode"><i class="fas fa-hashtag"></i> è‚¡ç¥¨ä»£ç </label>
                        <input type="text" id="stockCode" class="form-input" placeholder="ä¾‹å¦‚: 53473N" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="stockName"><i class="fas fa-signature"></i> è‚¡ç¥¨åç§°</label>
                        <input type="text" id="stockName" class="form-input" placeholder="é€‰æ‹©è‚¡ç¥¨åè‡ªåŠ¨å¡«å……" readonly>
                    </div>
                    
                    <div class="input-group">
                        <div class="form-group">
                            <label for="buyPrice"><i class="fas fa-shopping-cart"></i> ä¹°å…¥ä»·</label>
                            <input type="number" id="buyPrice" class="form-input" step="0.001" min="0.001" placeholder="0.000">
                        </div>
                        <div class="form-group">
                            <label for="sellPrice"><i class="fas fa-money-bill-wave"></i> ç›®æ ‡ä»·</label>
                            <input type="number" id="sellPrice" class="form-input" step="0.001" min="0.001" placeholder="0.000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="shareUnits"><i class="fas fa-chart-bar"></i> è´­ä¹°è‚¡æ•° (å•ä½: 100è‚¡)</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="shareUnitsRange" min="1" max="100" value="10" style="flex: 1;">
                            <input type="number" id="shareUnits" class="form-input" min="1" max="1000" value="10" style="width: 80px;">
                        </div>
                        <small style="color: var(--gray); margin-top: 5px; display: block;">
                            æ€»è‚¡æ•°: <span id="totalSharesDisplay">1,000</span> è‚¡ | æŠ•èµ„: <span id="investmentAmount">RM 0.00</span>
                        </small>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-cog"></i> è´¹ç”¨è®¾ç½®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
                        </div>
                        <button id="resetFeesBtn" style="background: none; border: none; color: var(--primary); font-size: 12px; cursor: pointer;">
                            <i class="fas fa-redo"></i> é‡ç½®
                        </button>
                    </div>
                    
                    <div class="fee-settings">
                        <div class="fee-row">
                            <div class="form-group">
                                <label style="font-size: 12px;">ç»çºªä½£é‡‘ (%)</label>
                                <input type="number" id="brokerageRate" class="form-input" step="0.01" min="0" value="0.42">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">æœ€ä½ä½£é‡‘ (RM)</label>
                                <input type="number" id="brokerageMin" class="form-input" step="0.01" min="0" value="8">
                            </div>
                        </div>
                        
                        <div class="fee-row">
                            <div class="form-group">
                                <label style="font-size: 12px;">æ¸…ç®—è´¹ (%)</label>
                                <input type="number" id="clearingFeeRate" class="form-input" step="0.001" min="0" value="0.03">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">ä¸Šé™ (RM)</label>
                                <input type="number" id="clearingCap" class="form-input" step="1" min="0" value="200">
                            </div>
                        </div>
                        
                        <div class="fee-row">
                            <div class="form-group">
                                <label style="font-size: 12px;">å°èŠ±ç¨ (RM/1000)</label>
                                <input type="number" id="stampDuty" class="form-input" step="0.01" min="0" value="1.50">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">ä¸Šé™ (RM)</label>
                                <input type="number" id="stampDutyCap" class="form-input" step="1" min="0" value="1000">
                            </div>
                        </div>
                        
                        <div class="fee-row">
                            <div class="form-group">
                                <label style="font-size: 12px;">æœåŠ¡ç¨ (%)</label>
                                <input type="number" id="serviceTaxRate" class="form-input" step="0.01" min="0" value="6.00">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">ç›®æ ‡åˆ©æ¶¦ (RM)</label>
                                <input type="number" id="minProfitTarget" class="form-input" step="0.01" min="0" value="5.00">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="calculateBtn" class="btn btn-primary touch-feedback">
                    <i class="fas fa-calculator"></i> è®¡ç®—å‡€å›é…¬
                </button>
            </div>
            
            <!-- ç»“æœæ ‡ç­¾é¡µ -->
            <div id="results-tab" class="tab-content">
                <div id="resultSection" style="display: none;">
                    <div class="result-card">
                        <div style="font-size: 14px; color: var(--gray);">å‡€å›é…¬åˆ†æ</div>
                        <div id="resultMain" class="result-main result-positive">RM 0.00</div>
                        <div id="resultSub" class="result-sub">0.00% å›é…¬ç‡</div>
                        
                        <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: var(--gray);">ä¿æœ¬ä»·</div>
                                <div id="breakEvenPrice" style="font-size: 16px; font-weight: 600;">RM 0.000</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: var(--gray);">ç›®æ ‡ä»·</div>
                                <div id="targetPrice" style="font-size: 16px; font-weight: 600;">RM 0.000</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="minimumNote" class="card" style="display: none; background: #FFF3E0; border-left: 4px solid var(--warning);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--warning);">æœªè¾¾åˆ°æœ€ä½åˆ©æ¶¦ç›®æ ‡</div>
                                <div style="font-size: 13px; color: var(--gray); margin-top: 5px;">
                                    å½“å‰å›é…¬ <strong id="currentProfitDisplay">RM 0.00</strong> ä½äºç›®æ ‡ <strong>RM <span id="minProfitDisplay">5.00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-list-alt"></i> è´¹ç”¨æ˜ç»†
                            </div>
                        </div>
                        
                        <div id="resultDetails">
                            <div class="detail-row">
                                <span>è´­ä¹°æˆæœ¬:</span>
                                <span id="buyTotalCost">RM 0.00</span>
                            </div>
                            <div class="detail-row">
                                <span>å–å‡ºæ”¶å…¥:</span>
                                <span id="sellTotalRevenue">RM 0.00</span>
                            </div>
                            <div class="detail-row">
                                <span>ç»çºªä½£é‡‘:</span>
                                <span id="totalBrokerage">RM 0.00</span>
                            </div>
                            <div class="detail-row">
                                <span>æ¸…ç®—è´¹:</span>
                                <span id="totalClearingFee">RM 0.00</span>
                            </div>
                            <div class="detail-row">
                                <span>å°èŠ±ç¨:</span>
                                <span id="totalStampDuty">RM 0.00</span>
                            </div>
                            <div class="detail-row">
                                <span>æœåŠ¡ç¨:</span>
                                <span id="serviceTax">RM 0.00</span>
                            </div>
                            <div class="detail-row">
                                <span>æ€»è´¹ç”¨:</span>
                                <span id="totalFees">RM 0.00</span>
                            </div>
                            <div class="detail-row">
                                <span>å‡€å›é…¬:</span>
                                <span id="netProfit" class="result-positive">RM 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="noResults" class="loading">
                    <i class="fas fa-calculator" style="font-size: 36px; color: var(--gray);"></i>
                    <p style="margin-top: 10px;">è¯·å…ˆåœ¨è®¡ç®—å™¨é¡µé¢è¿›è¡Œè®¡ç®—</p>
                    <button onclick="switchTab('calculator')" class="btn-secondary" style="margin-top: 15px;">
                        <i class="fas fa-arrow-left"></i> è¿”å›è®¡ç®—å™¨
                    </button>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="app-footer">
            <div style="text-align: center; font-size: 11px; color: var(--gray);">
                <p>Â© 2025 Bursa Malaysia AIåˆ†æå·¥å…· | ä½¿ç”¨çœŸå®AIæ•°æ®</p>
                <p id="dataSourceInfo" style="margin-top: 5px; font-size: 10px;">æ•°æ®æº: æœªåŠ è½½</p>
            </div>
        </div>
    </div>
    
    <!-- è‚¡ç¥¨è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="stockDetailModal" class="stock-detail-modal">
        <div class="stock-detail-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="modalStockTitle" style="color: var(--primary);">è‚¡ç¥¨è¯¦æƒ…</h3>
                <button onclick="closeStockDetail()" style="background: none; border: none; font-size: 20px; color: var(--gray); cursor: pointer;">Ã—</button>
            </div>
            <div id="modalStockContent">
                <!-- è¯¦æƒ…å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button onclick="closeStockDetail()" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); margin-top: 15px;">
                å…³é—­
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let aiStocksData = [];
        let priceData = [];
        let selectedStock = null;
        let currentDate = '2025-12-18';
        let currentDataSource = 'local';
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± Bursa AIæŠ•èµ„è®¡ç®—å™¨å¯åŠ¨ - å¢å¼ºç‰ˆ');
            
            // åˆå§‹åŒ–UI
            initUI();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            // åˆå§‹åŒ–å¢å¼ºçš„æ—¥æœŸé€‰æ‹©å™¨
            setTimeout(() => {
                initDateSelectorEnhanced();
                updateDateSelector();
            }, 500);
            
            // è‡ªåŠ¨åŠ è½½æœ€æ–°æ•°æ®
            setTimeout(() => {
                loadLatestData();
            }, 1000);
        });
        
        // åˆå§‹åŒ–UI
        function initUI() {
            // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
            initDateSelector();
            
            // åˆå§‹åŒ–è§¦æ‘¸åé¦ˆ
            initTouchFeedback();
            
            // è®¾ç½®é»˜è®¤æ•°æ®æº
            setDataSource('local');
            
            // æ›´æ–°å½“å‰æ—¥æœŸæ˜¾ç¤º
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('dataUpdateDate').textContent = dateStr;
            currentDate = dateStr;
        }
        
        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        function initDateSelector() {
            const dateSelect = document.getElementById('dateSelect');
            if (!dateSelect) return;
            
            dateSelect.innerHTML = '';
            
            // æ·»åŠ ä»Šå¤©çš„é€‰é¡¹
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const todayOption = document.createElement('option');
            todayOption.value = todayStr;
            todayOption.textContent = todayStr + ' (ä»Šå¤©)';
            todayOption.selected = true;
            dateSelect.appendChild(todayOption);
            
            console.log('åŸºæœ¬æ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        // å¢å¼ºç‰ˆæ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–
        function initDateSelectorEnhanced() {
            const dateSelect = document.getElementById('dateSelect');
            
            if (!dateSelect) {
                console.error('æ‰¾ä¸åˆ°æ—¥æœŸé€‰æ‹©å™¨å…ƒç´ ');
                return;
            }
            
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            dateSelect.removeEventListener('change', handleDateChange);
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            dateSelect.addEventListener('change', handleDateChange);
            
            console.log('å¢å¼ºç‰ˆæ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        // è‡ªåŠ¨æ£€æµ‹å†å²æ–‡ä»¶
        async function scanHistoryFiles() {
            try {
                console.log('æ­£åœ¨æ‰«æ history/ ç›®å½•...');
                // å°è¯•ç›´æ¥è®¿é—® history ç›®å½•
                const response = await fetch('history/');
                if (!response.ok) {
                    console.log('historyç›®å½•ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®');
                    return [];
                }
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a[href$=".json"]'));
                
                console.log('æ‰¾åˆ°çš„é“¾æ¥:', links.map(link => link.getAttribute('href')));
                
                // æå– picks_YYYYMMDD.json æ ¼å¼çš„æ–‡ä»¶
                const files = links
                    .map(link => link.getAttribute('href'))
                    .filter(href => {
                        // è¿‡æ»¤ picks_YYYYMMDD.json æ ¼å¼çš„æ–‡ä»¶
                        const match = href.match(/picks_(\d{8})\.json/);
                        return match && !href.includes('latest'); // æ’é™¤ picks_latest.json
                    })
                    .map(href => {
                        // æå–æ—¥æœŸéƒ¨åˆ†
                        const match = href.match(/picks_(\d{8})\.json/);
                        return {
                            filename: href,
                            dateStr: match[1],
                            formattedDate: match[1].replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3')
                        };
                    })
                    .sort((a, b) => b.dateStr.localeCompare(a.dateStr)); // æŒ‰æ—¥æœŸé™åºæ’åˆ—
                
                console.log(`æ‰¾åˆ° ${files.length} ä¸ªå†å²æ–‡ä»¶:`, files);
                return files;
                
            } catch (error) {
                console.error('æ‰«æå†å²æ–‡ä»¶å¤±è´¥:', error);
                return [];
            }
        }
        
        // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
        async function updateDateSelector() {
            const dateSelect = document.getElementById('dateSelect');
            
            if (!dateSelect) {
                console.error('æ‰¾ä¸åˆ°æ—¥æœŸé€‰æ‹©å™¨å…ƒç´ ');
                return;
            }
            
            // ä¿å­˜å½“å‰å€¼
            const currentValue = dateSelect.value;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            dateSelect.innerHTML = '';
            
            // æ·»åŠ ä»Šå¤©çš„é€‰é¡¹
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            const todayOption = document.createElement('option');
            todayOption.value = todayStr;
            todayOption.textContent = todayStr + ' (ä»Šå¤©)';
            dateSelect.appendChild(todayOption);
            
            // ä»å†å²æ–‡ä»¶æ·»åŠ é€‰é¡¹
            const files = await scanHistoryFiles();
            
            files.forEach(file => {
                const formattedDate = file.formattedDate;
                
                // é¿å…é‡å¤æ·»åŠ ä»Šå¤©
                if (formattedDate !== todayStr) {
                    const option = document.createElement('option');
                    option.value = formattedDate;
                    option.textContent = formattedDate + ' (å†å²)';
                    dateSelect.appendChild(option);
                }
            });
            
            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼æˆ–é€‰æ‹©ç¬¬ä¸€ä¸ª
            if (dateSelect.options.length > 0) {
                const hasCurrent = Array.from(dateSelect.options).some(opt => opt.value === currentValue);
                if (hasCurrent && currentValue) {
                    dateSelect.value = currentValue;
                } else {
                    dateSelect.selectedIndex = 0;
                }
            }
            
            console.log(`æ—¥æœŸé€‰æ‹©å™¨å·²æ›´æ–°: ${dateSelect.options.length} ä¸ªé€‰é¡¹`);
            
            // è§¦å‘æ—¥æœŸå˜æ›´äº‹ä»¶
            setTimeout(() => {
                dateSelect.dispatchEvent(new Event('change'));
            }, 100);
        }
        
        // å¤„ç†æ—¥æœŸå˜æ›´
        function handleDateChange() {
            const selectedDate = this.value;
            console.log('é€‰æ‹©æ—¥æœŸ:', selectedDate);
            currentDate = selectedDate;
            
            // æ›´æ–°æ•°æ®æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            document.getElementById('dataUpdateDate').textContent = selectedDate;
            
            // å¦‚æœå½“å‰æ•°æ®æºæ˜¯ historyï¼Œé‡æ–°åŠ è½½æ•°æ®
            if (currentDataSource === 'history') {
                console.log('é‡æ–°åŠ è½½å†å²æ•°æ®...');
                loadCurrentData();
            }
        }
        
        // åŠ è½½å½“å‰é€‰æ‹©çš„æ•°æ®
        async function loadCurrentData() {
            if (currentDataSource === 'history') {
                await loadHistoryData();
            } else if (currentDataSource === 'picks_latest') {
                await loadPicksLatest();
            } else {
                await loadLocalData();
            }
        }
        
        // åˆå§‹åŒ–è§¦æ‘¸åé¦ˆ
        function initTouchFeedback() {
            const buttons = document.querySelectorAll('button, .tab, .stock-item, .source-btn');
            buttons.forEach(btn => {
                btn.classList.add('touch-feedback');
            });
        }
        
        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // è®¡ç®—æŒ‰é’®
            document.getElementById('calculateBtn').addEventListener('click', calculateProfit);
            
            // é‡ç½®è´¹ç”¨æŒ‰é’®
            document.getElementById('resetFeesBtn').addEventListener('click', resetFeesToDefault);
            
            // è¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
            document.getElementById('buyPrice').addEventListener('input', updateTotalInvestment);
            document.getElementById('shareUnits').addEventListener('input', updateTotalInvestment);
            document.getElementById('shareUnitsRange').addEventListener('input', function() {
                document.getElementById('shareUnits').value = this.value;
                updateTotalInvestment();
            });
            document.getElementById('shareUnits').addEventListener('input', function() {
                document.getElementById('shareUnitsRange').value = this.value;
                updateTotalInvestment();
            });
            
            // ç­›é€‰å™¨äº‹ä»¶
            document.getElementById('typeFilter').addEventListener('change', filterStocks);
            document.getElementById('searchFilter').addEventListener('input', filterStocks);
            
            // è´¹ç”¨è®¾ç½®å˜åŒ–æ—¶è‡ªåŠ¨è®¡ç®—
            const feeInputs = [
                'brokerageRate', 'brokerageMin', 'clearingFeeRate', 'clearingCap',
                'stampDuty', 'stampDutyCap', 'serviceTaxRate', 'minProfitTarget'
            ];
            
            feeInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (document.getElementById('buyPrice').value && 
                        document.getElementById('sellPrice').value) {
                        setTimeout(calculateProfit, 300);
                    }
                });
            });
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            const activeTab = document.querySelector(`.tab[onclick*="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            document.querySelector('.content').scrollTop = 0;
            
            // å¦‚æœåˆ‡æ¢åˆ°ç»“æœé¡µä¸”æ²¡æœ‰ç»“æœï¼Œæ˜¾ç¤ºæç¤º
            if (tabName === 'results' && !document.getElementById('resultSection').style.display || 
                document.getElementById('resultSection').style.display === 'none') {
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
            } else if (tabName === 'results') {
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('noResults').style.display = 'none';
            }
            
            console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabName);
        }
        
        // è®¾ç½®æ•°æ®æº
        function setDataSource(source) {
            currentDataSource = source;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.source-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ ¹æ®æ•°æ®æºè®¾ç½®ä¸åŒçš„æ–‡æœ¬å’Œå›¾æ ‡
            let sourceText = '';
            let sourceIcon = '';
            
            switch(source) {
                case 'local':
                    sourceText = 'æœ¬åœ°JSONæ•°æ®';
                    sourceIcon = 'fa-file-alt';
                    document.querySelector('.source-btn[onclick="setDataSource(\'local\')"]').classList.add('active');
                    // éšè—æ—¥æœŸé€‰æ‹©å™¨
                    document.getElementById('datePickerSection').style.display = 'none';
                    break;
                case 'picks_latest':
                    sourceText = '';
                  sourceIcon = 'fa-bolt';
                    document.querySelector('.source-btn[onclick="setDataSource(\'picks_latest\')"]').classList.add('active');
                    // éšè—æ—¥æœŸé€‰æ‹©å™¨
                    document.getElementById('datePickerSection').style.display = 'none';
                    break;
                case 'history':
                    sourceText = 'å†å²æ•°æ®';
                    sourceIcon = 'fa-history';
                    document.querySelector('.source-btn[onclick="setDataSource(\'history\')"]').classList.add('active');
                    // æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
                    document.getElementById('datePickerSection').style.display = 'flex';
                    // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
                    setTimeout(updateDateSelector, 100);
                    break;
            }
            
            document.getElementById('currentSource').innerHTML = `<i class="fas ${sourceIcon}"></i> ${sourceText}`;
            document.getElementById('dataSourceInfo').textContent = `æ•°æ®æº: ${sourceText}`;
            
            console.log('è®¾ç½®æ•°æ®æº:', source);
        }
        
        // åŠ è½½æœ€æ–°æ•°æ®
        async function loadLatestData() {
            try {
                // é¦–å…ˆå°è¯•åŠ è½½ picks_latest.json
                const response = await fetch('picks_latest.json');
                if (response.ok) {
                    const data = await response.json();
                    processStockData(data.picks || []);
                    showNotification('æˆåŠŸåŠ è½½ picks_latest.json', 'success');
                    setDataSource('picks_latest');
                    return;
                }
            } catch (error) {
                console.log('picks_latest.json åŠ è½½å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ•°æ®æº');
            }
            
            // å¦‚æœ picks_latest.json å¤±è´¥ï¼Œå°è¯•å†å²æ•°æ®
            try {
                await loadLatestHistoryFile();
                setDataSource('history');
            } catch (error) {
                console.log('å†å²æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                loadLocalData();
                setDataSource('local');
            }
        }
        
        // åŠ è½½AIæ•°æ®
        async function loadAIData() {
            const stocksListEl = document.getElementById('aiStocksList');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            stocksListEl.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>æ­£åœ¨åŠ è½½AIé€‰è‚¡æ•°æ®...</p>
                    <p style="font-size: 12px; margin-top: 10px; color: var(--primary);" id="loadingPath"></p>
                </div>
            `;
            
            switch(currentDataSource) {
                case 'picks_latest':
                    await loadPicksLatest();
                    break;
                case 'history':
                    await loadHistoryData();
                    break;
                case 'local':
                default:
                    await loadLocalData();
                    break;
            }
        }
        
        // åŠ è½½ picks_latest.json
        async function loadPicksLatest() {
            try {
                const response = await fetch('picks_latest.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                processStockData(data.picks || []);
                showNotification(`æˆåŠŸåŠ è½½ picks_latest.json (${(data.picks || []).length} åªè‚¡ç¥¨)`, 'success');
                
            } catch (error) {
                showNotification(`åŠ è½½ picks_latest.json å¤±è´¥: ${error.message}`, 'error');
                loadLocalData();
            }
        }
        
        // åŠ è½½å†å²æ•°æ®
        async function loadHistoryData() {
            const stocksListEl = document.getElementById('aiStocksList');
            const dateSelect = document.getElementById('dateSelect');
            const selectedDate = dateSelect ? dateSelect.value : currentDate;
            
            if (!selectedDate) {
                showNotification('è¯·å…ˆé€‰æ‹©æ—¥æœŸ', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            stocksListEl.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>æ­£åœ¨åŠ è½½å†å²æ•°æ®...</p>
                    <p style="font-size: 12px; margin-top: 10px; color: var(--primary);">
                        æ—¥æœŸ: ${selectedDate}
                    </p>
                </div>
            `;
            
            try {
                // å°† YYYY-MM-DD è½¬æ¢ä¸º YYYYMMDD
                const dateStr = selectedDate.replace(/-/g, '');
                const fileName = `picks_${dateStr}.json`;
                const filePath = `history/${fileName}`;
                
                console.log('åŠ è½½å†å²æ–‡ä»¶:', filePath);
                
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${fileName} ä¸å­˜åœ¨`);
                }
                
                const data = await response.json();
                processStockData(data.picks || []);
                
                showNotification(`æˆåŠŸåŠ è½½å†å²æ•°æ®: ${selectedDate} (${(data.picks || []).length} åªè‚¡ç¥¨)`, 'success');
                
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
                
                // å°è¯•åŠ è½½æœ€æ–°çš„å†å²æ–‡ä»¶
                try {
                    await loadLatestHistoryFile();
                } catch (fallbackError) {
                    showNotification(`å†å²æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    loadLocalData(); // å›é€€åˆ°æœ¬åœ°æ•°æ®
                }
            }
        }
        
        // åŠ è½½æœ€æ–°å†å²æ–‡ä»¶
        async function loadLatestHistoryFile() {
            const dateSelect = document.getElementById('dateSelect');
            const today = new Date();
            const attempts = 7; // å°è¯•æœ€è¿‘7å¤©
            
            for (let i = 1; i <= attempts; i++) { // ä»æ˜¨å¤©å¼€å§‹
                const checkDate = new Date();
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0].replace(/-/g, '');
                const fileName = `picks_${dateStr}.json`;
                const filePath = `history/${fileName}`;
                
                console.log(`å°è¯•åŠ è½½: ${filePath}`);
                
                try {
                    const response = await fetch(filePath);
                    if (response.ok) {
                        const data = await response.json();
                        processStockData(data.picks || []);
                        
                        // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
                        const formattedDate = dateStr.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                        if (dateSelect) {
                            dateSelect.value = formattedDate;
                            currentDate = formattedDate;
                        }
                        
                        showNotification(`æˆåŠŸåŠ è½½: ${fileName}`, 'success');
                        return;
                    }
                } catch (error) {
                    // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ—¥æœŸ
                }
            }
            
            throw new Error('æœ€è¿‘7å¤©å†…æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å†å²æ–‡ä»¶');
        }
        
        // åŠ è½½æœ¬åœ°æ•°æ®ï¼ˆä½¿ç”¨å†…ç½®çš„çœŸå®æ•°æ®ç¤ºä¾‹ï¼‰
        async function loadLocalData() {
            // è¿™é‡Œä½¿ç”¨æ‚¨æä¾›çš„çœŸå®æ•°æ®ç»“æ„
            const sampleData = [
                {
                    "rank": 1,
                    "code": "53473N",
                    "name": "TENAGA-C3N",
                    "instrument_type": "Warrant",
                    "sector": "365",
                    "current_price": 0.05,
                    "daily_change": 42.86,
                    "score": 75,
                    "potential_score": 90,
                    "potential_reasons": "Warrantåš´é‡è¶…è³£ï¼Œåå½ˆæ©Ÿæœƒæ¥µå¤§",
                    "recommendation": "ğŸ”¥å¼·çƒˆè²·å…¥ï¼ˆWarrantï¼‰",
                    "risk_level": "é«˜",
                    "rsi": 50.0,
                    "volume": 5401,
                    "status": "ä¸­æ€§",
                    "pe_ratio": null,
                    "dividend_yield": null,
                    "macd": 0,
                    "volume_ratio": 1.0
                },
                {
                    "rank": 2,
                    "code": "5916CV",
                    "name": "MSC-CV",
                    "instrument_type": "Warrant",
                    "sector": "302",
                    "current_price": 0.1,
                    "daily_change": 33.33,
                    "score": 77,
                    "potential_score": 88,
                    "potential_reasons": "WarrantæŠ€è¡“é¢å‘å¥½ï¼Œä¸Šæ¼²æ½›åŠ›å¤§",
                    "recommendation": "ğŸ‘è²·å…¥ï¼ˆWarrantï¼‰",
                    "risk_level": "ä¸­é«˜",
                    "rsi": 50.0,
                    "volume": 3670,
                    "status": "ä¸­æ€§",
                    "pe_ratio": null,
                    "dividend_yield": null,
                    "macd": 0.017,
                    "volume_ratio": 0.01
                },
                {
                    "rank": 3,
                    "code": "5916CU",
                    "name": "MSC-CU",
                    "instrument_type": "Warrant",
                    "sector": "302",
                    "current_price": 0.4,
                    "daily_change": 25.0,
                    "score": 75,
                    "potential_score": 87,
                    "potential_reasons": "WarrantæŠ€è¡“é¢å‘å¥½ï¼Œä¸Šæ¼²æ½›åŠ›å¤§",
                    "recommendation": "ğŸ‘è²·å…¥ï¼ˆWarrantï¼‰",
                    "risk_level": "ä¸­é«˜",
                    "rsi": 50.0,
                    "volume": 1310,
                    "status": "ä¸­æ€§",
                    "pe_ratio": null,
                    "dividend_yield": null,
                    "macd": 0.034,
                    "volume_ratio": 0.01
                },
                {
                    "rank": 4,
                    "code": "69631C",
                    "name": "VS-C1C",
                    "instrument_type": "Warrant",
                    "sector": "302",
                    "current_price": 0.02,
                    "daily_change": 33.33,
                    "score": 72,
                    "potential_score": 86,
                    "potential_reasons": "WarrantæŠ€è¡“é¢å‘å¥½ï¼Œä¸Šæ¼²æ½›åŠ›å¤§",
                    "recommendation": "ğŸ‘è²·å…¥ï¼ˆWarrantï¼‰",
                    "risk_level": "ä¸­é«˜",
                    "rsi": 50.0,
                    "volume": 1050,
                    "status": "ä¸­æ€§",
                    "pe_ratio": null,
                    "dividend_yield": null,
                    "macd": 0,
                    "volume_ratio": 1.0
                },
                {
                    "rank": 5,
                    "code": "522558",
                    "name": "IHH-C58",
                    "instrument_type": "Warrant",
                    "sector": "362",
                    "current_price": 0.235,
                    "daily_change": 20.51,
                    "score": 77,
                    "potential_score": 85,
                    "potential_reasons": "WarrantæŠ€è¡“é¢å‘å¥½ï¼Œä¸Šæ¼²æ½›åŠ›å¤§",
                    "recommendation": "ğŸ‘è²·å…¥ï¼ˆWarrantï¼‰",
                    "risk_level": "ä¸­é«˜",
                    "rsi": 50.0,
                    "volume": 1960,
                    "status": "ä¸­æ€§",
                    "pe_ratio": null,
                    "dividend_yield": null,
                    "macd": 0.009,
                    "volume_ratio": 0.03
                }
            ];
            
            processStockData(sampleData);
            showNotification('å·²åŠ è½½å†…ç½®çœŸå®æ•°æ®ç¤ºä¾‹', 'success');
        }
        
        // åŠ è½½è‚¡ä»·æ•°æ®
        async function loadPriceData() {
            try {
                const response = await fetch('latest_price.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                priceData = data.stocks || [];
                
                // å¦‚æœæœ‰AIæ•°æ®ï¼Œå°è¯•åˆå¹¶
                if (aiStocksData.length > 0) {
                    mergePriceData();
                }
                
                showNotification(`æˆåŠŸåŠ è½½è‚¡ä»·æ•°æ® (${priceData.length} åªè‚¡ç¥¨)`, 'success');
                
            } catch (error) {
                showNotification(`åŠ è½½è‚¡ä»·æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åˆå¹¶è‚¡ä»·æ•°æ®
        function mergePriceData() {
            // åˆ›å»ºè‚¡ä»·æ˜ å°„
            const priceMap = {};
            priceData.forEach(stock => {
                const cleanCode = stock.code.replace(/[="]/g, '');
                priceMap[cleanCode] = {
                    last_price: stock.last_price,
                    change_percent: stock.change_percent,
                    volume: stock.volume
                };
            });
            
            // æ›´æ–°AIæ•°æ®
            aiStocksData.forEach(stock => {
                const priceInfo = priceMap[stock.code];
                if (priceInfo) {
                    stock.current_price = priceInfo.last_price || stock.current_price;
                    stock.daily_change = priceInfo.change_percent || stock.daily_change;
                    stock.volume = priceInfo.volume || stock.volume;
                }
            });
            
            // é‡æ–°æ˜¾ç¤ºè‚¡ç¥¨åˆ—è¡¨
            displayStocksList(aiStocksData);
        }
        
        // å¤„ç†è‚¡ç¥¨æ•°æ®
        function processStockData(picks) {
            aiStocksData = picks;
            
            // æ›´æ–°è‚¡ç¥¨è®¡æ•°
            document.getElementById('stocksCount').textContent = `${picks.length} åªè‚¡ç¥¨`;
            
            // æ˜¾ç¤ºè‚¡ç¥¨åˆ—è¡¨
            displayStocksList(picks);
        }
        
        // æ˜¾ç¤ºè‚¡ç¥¨åˆ—è¡¨
        function displayStocksList(stocks) {
            const stocksListEl = document.getElementById('aiStocksList');
            
            if (stocks.length === 0) {
                stocksListEl.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-database" style="color: var(--gray);"></i>
                        <p>æ²¡æœ‰æ‰¾åˆ°é€‰è‚¡æ•°æ®</p>
                        <button onclick="loadLocalData()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm);">
                            ä½¿ç”¨ç¤ºä¾‹æ•°æ®
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            stocks.forEach((stock, index) => {
                const cleanCode = stock.code || 'N/A';
                const name = stock.name || 'æœªçŸ¥';
                const price = stock.current_price || 0;
                const change = stock.daily_change || 0;
                const rec = stock.recommendation || 'æ¨è';
                const type = stock.instrument_type === 'Warrant' ? 'warrant' : 'stock';
                const riskLevel = stock.risk_level === 'é«˜' ? 'high-risk' : '';
                
                // ç¡®å®šæ¨èç±»å‹
                let recType = 'buy';
                if (rec.includes('ğŸ”¥')) recType = 'strong-buy';
                else if (rec.includes('ğŸ‘')) recType = 'buy';
                else if (rec.includes('âš ï¸')) recType = 'caution';
                
                // æ„å»ºè‚¡ç¥¨å¡ç‰‡
                html += `
                    <div class="stock-item touch-feedback ${type} ${riskLevel}" onclick="showStockDetail(${JSON.stringify(stock).replace(/"/g, '&quot;')})">
                        <div class="stock-rank ${type} ${riskLevel}">#${stock.rank || index + 1}</div>
                        
                        <div class="stock-basic">
                            <div class="stock-code ${type} ${riskLevel}">${cleanCode}</div>
                            <div class="stock-name">${name}</div>
                        </div>
                        
                        <div class="stock-tags">
                            <span class="tag ${recType}">${rec.replace(/[ğŸ”¥ğŸ‘âš ï¸]/g, '')}</span>
                            <span class="tag ${type}">${type === 'warrant' ? 'è®¤è‚¡æƒè¯' : 'æ™®é€šè‚¡'}</span>
                            ${stock.risk_level ? `<span class="tag caution">${stock.risk_level}é£é™©</span>` : ''}
                        </div>
                        
                        <div class="stock-price">
                            <div class="price">RM ${price.toFixed(3)}</div>
                            <div class="price-change ${change >= 0 ? 'positive' : 'negative'}">
                                ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                            </div>
                        </div>
                        
                        <div class="stock-ai-score">
                            <div class="score-item">
                                <div class="score-label">AIè¯„åˆ†</div>
                                <div class="score-value" style="color: ${stock.score >= 70 ? '#4CAF50' : stock.score >= 50 ? '#FF9800' : '#F44336'}">
                                    ${stock.score || 'N/A'}
                                </div>
                            </div>
                            <div class="score-item">
                                <div class="score-label">æ½œåŠ›è¯„åˆ†</div>
                                <div class="score-value" style="color: ${stock.potential_score >= 85 ? '#4CAF50' : stock.potential_score >= 70 ? '#FF9800' : '#F44336'}">
                                    ${stock.potential_score || 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <button class="select-btn touch-feedback ${type}" onclick="event.stopPropagation(); selectStock(${JSON.stringify(stock).replace(/"/g, '&quot;')})">
                            <i class="fas fa-check-circle"></i> é€‰æ‹©è®¡ç®—
                        </button>
                    </div>
                `;
            });
            
            stocksListEl.innerHTML = html;
        }
        
        // ç­›é€‰è‚¡ç¥¨
        function filterStocks() {
            const typeFilter = document.getElementById('typeFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            const filteredStocks = aiStocksData.filter(stock => {
                // ç±»å‹ç­›é€‰
                if (typeFilter !== 'all') {
                    if (typeFilter === 'Warrant' && stock.instrument_type !== 'Warrant') return false;
                    if (typeFilter === 'Stock' && stock.instrument_type === 'Warrant') return false;
                }
                
                // æœç´¢ç­›é€‰
                if (searchFilter) {
                    const codeMatch = (stock.code || '').toLowerCase().includes(searchFilter);
                    const nameMatch = (stock.name || '').toLowerCase().includes(searchFilter);
                    return codeMatch || nameMatch;
                }
                
                return true;
            });
            
            displayStocksList(filteredStocks);
        }
        
        // æ˜¾ç¤ºè‚¡ç¥¨è¯¦æƒ…
        function showStockDetail(stock) {
            const modal = document.getElementById('stockDetailModal');
            const title = document.getElementById('modalStockTitle');
            const content = document.getElementById('modalStockContent');
            
            const cleanCode = stock.code || 'N/A';
            const name = stock.name || 'æœªçŸ¥';
            
            title.textContent = `${cleanCode} - ${name}`;
            
            const detailHtml = `
                <div style="margin-bottom: 20px;">
                    <div style="background: ${stock.instrument_type === 'Warrant' ? 'var(--warrant-bg)' : 'var(--light)'}; padding: 15px; border-radius: var(--radius-sm);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 12px; color: var(--gray);">å½“å‰ä»·æ ¼</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">
                                    RM ${(stock.current_price || 0).toFixed(3)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--gray);">æ¶¨è·Œå¹…</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${(stock.daily_change || 0) >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${(stock.daily_change || 0) >= 0 ? '+' : ''}${(stock.daily_change || 0).toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: white; padding: 10px; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);">
                        <div style="font-size: 11px; color: var(--gray);">AIè¯„åˆ†</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${stock.score >= 70 ? '#4CAF50' : stock.score >= 50 ? '#FF9800' : '#F44336'}">
                            ${stock.score || 'N/A'}/100
                        </div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);">
                        <div style="font-size: 11px; color: var(--gray);">æ½œåŠ›è¯„åˆ†</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${stock.potential_score >= 85 ? '#4CAF50' : stock.potential_score >= 70 ? '#FF9800' : '#F44336'}">
                            ${stock.potential_score || 'N/A'}/100
                        </div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);">
                        <div style="font-size: 11px; color: var(--gray);">é£é™©ç­‰çº§</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${stock.risk_level === 'é«˜' ? 'var(--danger)' : 'var(--warning)'}">
                            ${stock.risk_level || 'æœªçŸ¥'}
                        </div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: var(--radius-sm); border: 1px solid var(--light-gray);">
                        <div style="font-size: 11px; color: var(--gray);">æˆäº¤é‡</div>
                        <div style="font-size: 18px; font-weight: bold; color: var(--primary);">
                            ${formatVolume(stock.volume || 0)}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">AIæ¨èç†ç”±</div>
                    <div style="background: #FFF3E0; padding: 15px; border-radius: var(--radius-sm); border-left: 4px solid var(--warning);">
                        <p style="margin: 0; font-size: 14px; line-height: 1.5;">
                            ${stock.potential_reasons || 'æš‚æ— è¯¦ç»†åˆ†æ'}
                        </p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">æŠ€æœ¯æŒ‡æ ‡</div>
                    <div style="background: var(--light); padding: 10px; border-radius: var(--radius-sm);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--gray);">RSI (14):</span>
                            <span style="font-weight: bold;">${stock.rsi ? stock.rsi.toFixed(1) : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--gray);">MACD:</span>
                            <span style="font-weight: bold;">${stock.macd ? stock.macd.toFixed(3) : 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: var(--gray);">æˆäº¤é‡æ¯”:</span>
                            <span style="font-weight: bold;">${stock.volume_ratio ? stock.volume_ratio.toFixed(2) : 'N/A'}</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="selectStock(${JSON.stringify(stock).replace(/"/g, '&quot;')}); closeStockDetail();" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); font-weight: bold;">
                        <i class="fas fa-calculator"></i> ä½¿ç”¨æ­¤è‚¡ç¥¨è®¡ç®—
                    </button>
                </div>
            `;
            
            content.innerHTML = detailHtml;
            modal.style.display = 'flex';
        }
        
        // å…³é—­è‚¡ç¥¨è¯¦æƒ…
        function closeStockDetail() {
            document.getElementById('stockDetailModal').style.display = 'none';
        }
        
        // é€‰æ‹©è‚¡ç¥¨
        function selectStock(stock) {
            console.log('é€‰æ‹©è‚¡ç¥¨:', stock.code, stock.name);
            selectedStock = stock;
            
            // æ›´æ–°è¡¨å•
            const cleanCode = stock.code || '';
            document.getElementById('stockCode').value = cleanCode;
            document.getElementById('stockName').value = stock.name || 'æœªçŸ¥';
            document.getElementById('selectedStockInfo').textContent = `${cleanCode} - ${stock.name}`;
            
            const price = stock.current_price || 0;
            document.getElementById('buyPrice').value = price.toFixed(3);
            
            // è®¡ç®—å»ºè®®å–å‡ºä»·æ ¼ï¼ˆåŸºäºAIæ½œåŠ›è¯„åˆ†ï¼‰
            const suggestedSellPrice = price * (1 + (stock.potential_score || 85) / 100 * 0.1);
            document.getElementById('sellPrice').value = suggestedSellPrice.toFixed(3);
            
            // æ›´æ–°æŠ•èµ„æ€»é¢
            updateTotalInvestment();
            
            // åˆ‡æ¢åˆ°è®¡ç®—å™¨æ ‡ç­¾é¡µ
            switchTab('calculator');
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(`å·²é€‰æ‹© ${cleanCode} - ${stock.name}`, 'success');
        }
        
        // æ›´æ–°æŠ•èµ„æ€»é¢
        function updateTotalInvestment() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const shareUnits = parseInt(document.getElementById('shareUnits').value) || 0;
            
            // è®¡ç®—æ€»è‚¡æ•°ï¼ˆå•ä½ * 100ï¼‰
            const totalShares = shareUnits * 100;
            const totalInvestment = buyPrice * totalShares;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalSharesDisplay').textContent = totalShares.toLocaleString();
            document.getElementById('investmentAmount').textContent = `RM ${totalInvestment.toFixed(2)}`;
        }
        
        // é‡ç½®è´¹ç”¨è®¾ç½®
        function resetFeesToDefault() {
            document.getElementById('brokerageRate').value = 0.42;
            document.getElementById('brokerageMin').value = 8;
            document.getElementById('clearingFeeRate').value = 0.03;
            document.getElementById('clearingCap').value = 200;
            document.getElementById('stampDuty').value = 1.50;
            document.getElementById('stampDutyCap').value = 1000;
            document.getElementById('serviceTaxRate').value = 6.00;
            document.getElementById('minProfitTarget').value = 5.00;
            
            showNotification('è´¹ç”¨è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
            
            // é‡æ–°è®¡ç®—
            if (document.getElementById('buyPrice').value) {
                calculateProfit();
            }
        }
        
        // è®¡ç®—å‡€å›é…¬ï¼ˆä¿æŒåŸæœ‰çš„è®¡ç®—é€»è¾‘ï¼‰
        function calculateProfit() {
            console.log('å¼€å§‹è®¡ç®—å‡€å›é…¬...');
            
            // è·å–è¾“å…¥å€¼
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            const shareUnits = parseInt(document.getElementById('shareUnits').value) || 0;
            
            if (buyPrice <= 0 || sellPrice <= 0 || shareUnits <= 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼å’Œè‚¡æ•°', 'error');
                return;
            }
            
            // è·å–è´¹ç”¨è®¾ç½®
            const brokerageRate = parseFloat(document.getElementById('brokerageRate').value) / 100 || 0;
            const brokerageMin = parseFloat(document.getElementById('brokerageMin').value) || 0;
            const clearingFeeRate = parseFloat(document.getElementById('clearingFeeRate').value) / 100 || 0;
            const clearingCap = parseFloat(document.getElementById('clearingCap').value) || 0;
            const stampDuty = parseFloat(document.getElementById('stampDuty').value) || 0;
            const stampDutyCap = parseFloat(document.getElementById('stampDutyCap').value) || 0;
            const serviceTaxRate = parseFloat(document.getElementById('serviceTaxRate').value) / 100 || 0;
            const minProfitTarget = parseFloat(document.getElementById('minProfitTarget').value) || 5.00;
            
            // è®¡ç®—æ€»è‚¡æ•°
            const totalShares = shareUnits * 100;
            
            // è®¡ç®—ä¹°å…¥å’Œå–å‡ºæ€»é¢
            const buyTotal = buyPrice * totalShares;
            const sellTotal = sellPrice * totalShares;
            
            // è®¡ç®—ç»çºªä½£é‡‘
            const buyBrokerage = Math.max(buyTotal * brokerageRate, brokerageMin);
            const sellBrokerage = Math.max(sellTotal * brokerageRate, brokerageMin);
            const totalBrokerage = buyBrokerage + sellBrokerage;
            
            // è®¡ç®—æ¸…ç®—è´¹
            const buyClearingFee = Math.min(buyTotal * clearingFeeRate, clearingCap);
            const sellClearingFee = Math.min(sellTotal * clearingFeeRate, clearingCap);
            const totalClearingFee = buyClearingFee + sellClearingFee;
            
            // è®¡ç®—å°èŠ±ç¨
            const buyStampDuty = Math.min(Math.ceil(buyTotal / 1000) * stampDuty, stampDutyCap);
            const sellStampDuty = Math.min(Math.ceil(sellTotal / 1000) * stampDuty, stampDutyCap);
            const totalStampDuty = buyStampDuty + sellStampDuty;
            
            // è®¡ç®—æœåŠ¡ç¨
            const serviceTax = totalBrokerage * serviceTaxRate;
            
            // è®¡ç®—æ€»è´¹ç”¨
            const totalFees = totalBrokerage + totalClearingFee + totalStampDuty + serviceTax;
            
            // è®¡ç®—å‡€å›é…¬
            const netProfit = sellTotal - buyTotal - totalFees;
            const profitPercentage = buyTotal > 0 ? (netProfit / buyTotal) * 100 : 0;
            
            // è®¡ç®—ç›ˆäºå¹³è¡¡ä»·æ ¼
            const buyCostPerShare = buyTotal + buyBrokerage + buyClearingFee + buyStampDuty + (serviceTax / 2);
            const breakEvenPrice = (buyCostPerShare + sellBrokerage + sellClearingFee + sellStampDuty + (serviceTax / 2)) / totalShares;
            
            // è®¡ç®—è¾¾åˆ°ç›®æ ‡åˆ©æ¶¦çš„ä»·æ ¼
            const targetPrice = (buyCostPerShare + sellBrokerage + sellClearingFee + sellStampDuty + (serviceTax / 2) + minProfitTarget) / totalShares;
            
            // æ˜¾ç¤ºç»“æœ
            displayResults(
                netProfit,
                profitPercentage,
                buyTotal,
                sellTotal,
                totalBrokerage,
                totalClearingFee,
                totalStampDuty,
                serviceTax,
                totalFees,
                breakEvenPrice,
                targetPrice,
                minProfitTarget
            );
            
            // åˆ‡æ¢åˆ°ç»“æœæ ‡ç­¾é¡µ
            switchTab('results');
            
            console.log('è®¡ç®—å®Œæˆï¼Œå‡€å›é…¬:', netProfit);
        }
        
        // æ˜¾ç¤ºè®¡ç®—ç»“æœï¼ˆä¿æŒåŸæœ‰çš„æ˜¾ç¤ºé€»è¾‘ï¼‰
        function displayResults(
            netProfit, profitPercentage, buyTotal, sellTotal,
            totalBrokerage, totalClearingFee, totalStampDuty,
            serviceTax, totalFees, breakEvenPrice, targetPrice, minProfitTarget
        ) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('noResults').style.display = 'none';
            
            // æ›´æ–°ä¸»è¦ç»“æœ
            const resultMainEl = document.getElementById('resultMain');
            const resultSubEl = document.getElementById('resultSub');
            
            if (netProfit >= 0) {
                resultMainEl.className = 'result-main result-positive';
                resultMainEl.textContent = `+ RM ${netProfit.toFixed(2)}`;
                resultSubEl.textContent = `+${profitPercentage.toFixed(2)}% å›é…¬ç‡`;
            } else {
                resultMainEl.className = 'result-main result-negative';
                resultMainEl.textContent = `- RM ${Math.abs(netProfit).toFixed(2)}`;
                resultSubEl.textContent = `${profitPercentage.toFixed(2)}% å›é…¬ç‡`;
            }
            
            // æ›´æ–°ä»·æ ¼
            document.getElementById('breakEvenPrice').textContent = `RM ${breakEvenPrice.toFixed(3)}`;
            document.getElementById('targetPrice').textContent = `RM ${targetPrice.toFixed(3)}`;
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€ä½åˆ©æ¶¦ç›®æ ‡
            const minNoteEl = document.getElementById('minimumNote');
            if (netProfit < minProfitTarget) {
                document.getElementById('minProfitDisplay').textContent = minProfitTarget.toFixed(2);
                document.getElementById('currentProfitDisplay').textContent = `RM ${netProfit.toFixed(2)}`;
                minNoteEl.style.display = 'block';
            } else {
                minNoteEl.style.display = 'none';
            }
            
            // æ›´æ–°è¯¦ç»†è´¹ç”¨
            const formatCurrency = (value) => `RM ${value.toFixed(2)}`;
            
            document.getElementById('buyTotalCost').textContent = formatCurrency(buyTotal);
            document.getElementById('sellTotalRevenue').textContent = formatCurrency(sellTotal);
            document.getElementById('totalBrokerage').textContent = formatCurrency(totalBrokerage);
            document.getElementById('totalClearingFee').textContent = formatCurrency(totalClearingFee);
            document.getElementById('totalStampDuty').textContent = formatCurrency(totalStampDuty);
            document.getElementById('serviceTax').textContent = formatCurrency(serviceTax);
            document.getElementById('totalFees').textContent = formatCurrency(totalFees);
            
            const netProfitEl = document.getElementById('netProfit');
            if (netProfit >= 0) {
                netProfitEl.textContent = `+ ${formatCurrency(netProfit)}`;
                netProfitEl.className = 'result-positive';
            } else {
                netProfitEl.textContent = `- ${formatCurrency(Math.abs(netProfit))}`;
                netProfitEl.className = 'result-negative';
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function formatVolume(volume) {
            if (!volume || volume === 0) return '0';
            if (volume >= 1000000) return (volume / 1000000).toFixed(1) + 'M';
            if (volume >= 1000) return (volume / 1000).toFixed(1) + 'K';
            return volume.toString();
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // ç§»é™¤ç°æœ‰é€šçŸ¥
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // åˆ›å»ºé€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
                color: white;
                border-radius: var(--radius-sm);
                box-shadow: var(--shadow);
                z-index: 10000;
                font-weight: 500;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideDown 0.3s ease;
                max-width: 90%;
                white-space: nowrap;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
            
            // æ·»åŠ CSSåŠ¨ç”»
            if (!document.querySelector('#notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideDown {
                        from { top: 50px; opacity: 0; }
                        to { top: 100px; opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { top: 100px; opacity: 1; }
                        to { top: 50px; opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        setTimeout(() => {
            updateTotalInvestment();
        }, 500);
    </script>
</body>
</html>