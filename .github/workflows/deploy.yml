name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate HTML
      run: |
        echo "æª¢æŸ¥ HTML æ–‡ä»¶..."
        # ç°¡å–®æª¢æŸ¥ GA4 ä»£ç¢¼
        if grep -q "G-RX7R4JWV7E" index.html; then
          echo "âœ… GA4 æ¸¬é‡ ID å­˜åœ¨"
        else
          echo "âŒ GA4 æ¸¬é‡ ID æœªæ‰¾åˆ°"
          exit 1
        fi
        
        # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        for file in index.html bursa.html; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        
    - name: Check Links
      run: |
        echo "æª¢æŸ¥å…§éƒ¨éˆæ¥..."
        # ç°¡å–®æª¢æŸ¥ QR code åœ–ç‰‡
        if grep -q "qr-code" bursa.html; then
          echo "âœ… QR code ç›¸é—œä»£ç¢¼å­˜åœ¨"
        fi

  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Send success notification
      if: success()
      run: |
        echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼"
        echo "ç¶²ç«™å·²ç™¼å¸ƒåˆ°: https://myx-shop-manager.github.io/myx_shop/"
        echo "æˆ–è¨ªå•: ${{ steps.deployment.outputs.page_url }}"
