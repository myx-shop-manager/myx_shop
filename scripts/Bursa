#!/bin/bash
# æ™ºèƒ½Bursaç®¡ç†å™¨ v2.0 - é›†æˆShopeeç®¡ç†åŠŸèƒ½

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é …ç›®è·¯å¾‘
PROJECT_ROOT="/storage/emulated/0/bursasearch/myx_shop"

# å‡½æ•¸ï¼šé¡¯ç¤ºæ¨™é¡Œ
show_title() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘      ğŸ¤– Bursa AIé¸è‚¡ + Shopee é›»å•†ç®¡ç†ç³»çµ±       â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# å‡½æ•¸ï¼šæª¢æŸ¥æœå‹™å™¨ç‹€æ…‹
check_server_status() {
    echo -e "${BLUE}ğŸ” æª¢æŸ¥æœå‹™å™¨ç‹€æ…‹...${NC}"
    
    # æª¢æŸ¥ç«¯å£8000ï¼ˆHTTPæœå‹™å™¨ï¼‰
    if nc -z 127.0.0.1 8000 2>/dev/null; then
        echo -e "  ${GREEN}âœ… HTTPæœå‹™å™¨ (8000) - é‹è¡Œä¸­${NC}"
    else
        echo -e "  ${RED}âŒ HTTPæœå‹™å™¨ (8000) - æœªé‹è¡Œ${NC}"
    fi
    
    # æª¢æŸ¥ç«¯å£5050ï¼ˆAPIæœå‹™å™¨ï¼‰
    if nc -z 127.0.0.1 5050 2>/dev/null; then
        echo -e "  ${GREEN}âœ… APIæœå‹™å™¨ (5050) - é‹è¡Œä¸­${NC}"
    else
        echo -e "  ${RED}âŒ APIæœå‹™å™¨ (5050) - æœªé‹è¡Œ${NC}"
    fi
    
    echo ""
}

# å‡½æ•¸ï¼šæ‰“é–‹æ–‡ä»¶
open_file() {
    local file="$1"
    local desc="$2"
    
    if [ -n "$desc" ]; then
        echo -e "${GREEN}âœ… æ­£åœ¨æ‰“é–‹: $desc${NC}"
    else
        echo -e "${GREEN}âœ… æ­£åœ¨æ‰“é–‹: $file${NC}"
    fi
    
    if command -v termux-open &> /dev/null; then
        termux-open "$file" 2>/dev/null && \
        echo -e "${BLUE}ğŸš€ å·²é€šéTermuxæ‰“é–‹${NC}"
    else
        echo -e "${YELLOW}ğŸŒ è«‹æ‰‹å‹•è¨ªå•:${NC}"
        echo -e "file://$(pwd)/$file"
    fi
}

# å‡½æ•¸ï¼šæª¢æŸ¥JSONæ–‡ä»¶
check_json_file() {
    local json_file="$1"
    
    if [ ! -f "$json_file" ]; then
        echo -e "${RED}âŒ æ–‡ä»¶ä¸å­˜åœ¨: $json_file${NC}"
        return 1
    fi
    
    # å˜—è©¦ä½¿ç”¨jqè§£æ
    if command -v jq &> /dev/null; then
        local count=$(jq '.products | length' "$json_file" 2>/dev/null)
        if [ -n "$count" ]; then
            echo -e "${GREEN}ğŸ“Š JSONæ–‡ä»¶æª¢æŸ¥:${NC}"
            echo -e "  æ–‡ä»¶: $(basename "$json_file")"
            echo -e "  ç”¢å“æ•¸é‡: $count"
            echo -e "  æœ€å¾Œæ›´æ–°: $(jq -r '.lastUpdated // "æœªçŸ¥"' "$json_file")"
            
            # é¡¯ç¤ºå‰3å€‹ç”¢å“
            echo -e "\n${YELLOW}ğŸ“‹ ç”¢å“æ¨£ä¾‹:${NC}"
            jq -r '.products[0:3] | .[] | "  \(.id). \(.name) - RM\(.price) (åº«å­˜: \(.stock))"' "$json_file" 2>/dev/null
        else
            echo -e "${YELLOW}âš ï¸  æ–‡ä»¶å­˜åœ¨ä½†å¯èƒ½æ ¼å¼éŒ¯èª¤${NC}"
            head -5 "$json_file"
        fi
    else
        echo -e "${YELLOW}ğŸ“„ æ–‡ä»¶å…§å®¹(å‰5è¡Œ):${NC}"
        head -5 "$json_file"
    fi
    
    echo ""
}

# å‡½æ•¸ï¼šç®¡ç†Shopeeç³»çµ±
manage_shopee() {
    while true; do
        show_title
        echo -e "${PURPLE}ğŸ›ï¸  SHOPEE é›»å•†ç³»çµ±ç®¡ç†${NC}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo -e "${CYAN}ğŸ“± å‰å°å±•ç¤º:${NC}"
        echo "  1. æ‰“é–‹Shopeeç”¢å“é é¢"
        echo "  2. æ‰“é–‹Temuç”¢å“é é¢"
        echo "  3. æ‰“é–‹Lazadaç”¢å“é é¢"
        echo ""
        echo -e "${CYAN}âš™ï¸  å¾Œå°ç®¡ç†:${NC}"
        echo "  4. æ‰“é–‹Shopeeç®¡ç†å¾Œå°"
        echo "  5. æª¢æŸ¥JSONæ•¸æ“šæ–‡ä»¶"
        echo "  6. å‚™ä»½JSONæ•¸æ“š"
        echo ""
        echo -e "${CYAN}ğŸ–¼ï¸  åœ–ç‰‡ç®¡ç†:${NC}"
        echo "  7. æŸ¥çœ‹ç”¢å“åœ–ç‰‡"
        echo "  8. æª¢æŸ¥åœ–ç‰‡è·¯å¾‘"
        echo ""
        echo -e "${CYAN}ğŸŒ æœå‹™å™¨:${NC}"
        echo "  9. å•Ÿå‹•æœ¬åœ°æœå‹™å™¨"
        echo "  0. è¿”å›ä¸»èœå–®"
        echo ""
        
        read -p "è«‹é¸æ“‡æ“ä½œ (0-9): " choice
        
        case $choice in
            1)
                if [ -f "shopee.html" ]; then
                    open_file "shopee.html" "Shopeeç”¢å“å±•ç¤ºé é¢"
                else
                    echo -e "${RED}âŒ æ‰¾ä¸åˆ° shopee.html${NC}"
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            2)
                if [ -f "temu.html" ]; then
                    open_file "temu.html" "Temuç”¢å“å±•ç¤ºé é¢"
                else
                    echo -e "${YELLOW}âš ï¸  æ‰¾ä¸åˆ° temu.html${NC}"
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            3)
                if [ -f "lazada.html" ]; then
                    open_file "lazada.html" "Lazadaç”¢å“å±•ç¤ºé é¢"
                else
                    echo -e "${YELLOW}âš ï¸  æ‰¾ä¸åˆ° lazada.html${NC}"
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            4)
                if [ -f "admin/shopee_dashboard.html" ]; then
                    open_file "admin/shopee_dashboard.html" "Shopeeç®¡ç†å¾Œå°"
                else
                    echo -e "${RED}âŒ æ‰¾ä¸åˆ° admin/shopee_dashboard.html${NC}"
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            5)
                echo -e "${YELLOW}ğŸ“Š æª¢æŸ¥JSONæ•¸æ“šæ–‡ä»¶...${NC}"
                if [ -f "js/shopee_list.json" ]; then
                    check_json_file "js/shopee_list.json"
                else
                    echo -e "${RED}âŒ æ‰¾ä¸åˆ° js/shopee_list.json${NC}"
                    echo -e "å¯é¸æ–‡ä»¶:"
                    find . -name "*.json" -type f | grep -i shopee | head -5
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            6)
                echo -e "${YELLOW}ğŸ’¾ å‚™ä»½JSONæ•¸æ“š...${NC}"
                if [ -f "js/shopee_list.json" ]; then
                    backup_file="shopee_list_$(date +%Y%m%d_%H%M%S).json"
                    cp "js/shopee_list.json" "$backup_file"
                    echo -e "${GREEN}âœ… å‚™ä»½å®Œæˆ: $backup_file${NC}"
                    ls -la "$backup_file"
                else
                    echo -e "${RED}âŒ æ‰¾ä¸åˆ°åŸå§‹æ–‡ä»¶${NC}"
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            7)
                echo -e "${YELLOW}ğŸ–¼ï¸  ç”¢å“åœ–ç‰‡åˆ—è¡¨:${NC}"
                if [ -d "images/products/shopee" ]; then
                    echo "åœ–ç‰‡ç›®éŒ„: images/products/shopee/"
                    ls -la "images/products/shopee/" | head -10
                    echo ""
                    echo "ç¸½åœ–ç‰‡æ•¸: $(ls "images/products/shopee/" 2>/dev/null | wc -l)"
                else
                    echo -e "${RED}âŒ æ‰¾ä¸åˆ°åœ–ç‰‡ç›®éŒ„${NC}"
                    find . -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | grep -i shopee | head -5
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            8)
                echo -e "${YELLOW}ğŸ” æª¢æŸ¥åœ–ç‰‡è·¯å¾‘...${NC}"
                if [ -f "js/shopee_list.json" ] && command -v jq &> /dev/null; then
                    echo "ç”¢å“ä½¿ç”¨çš„åœ–ç‰‡æ–‡ä»¶:"
                    jq -r '.products[] | "\(.id). \(.name) -> \(.image // "ç„¡åœ–ç‰‡")"' "js/shopee_list.json" 2>/dev/null
                    
                    echo -e "\n${YELLOW}æª¢æŸ¥ç¼ºå¤±çš„åœ–ç‰‡:${NC}"
                    jq -r '.products[] | select(.image) | .image' "js/shopee_list.json" 2>/dev/null | while read img; do
                        if [ ! -f "images/products/shopee/$img" ]; then
                            echo "âŒ ç¼ºå¤±: $img"
                        fi
                    done
                fi
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            9)
                manage_server
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}âŒ ç„¡æ•ˆé¸æ“‡${NC}"
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
        esac
    done
}

# å‡½æ•¸ï¼šç®¡ç†æœå‹™å™¨
manage_server() {
    while true; do
        show_title
        echo -e "${PURPLE}ğŸŒ æœå‹™å™¨ç®¡ç†${NC}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        check_server_status
        
        echo -e "${CYAN}å¯é¸æ“ä½œ:${NC}"
        echo "  1. å•Ÿå‹•Python HTTPæœå‹™å™¨ (ç«¯å£8000)"
        echo "  2. å•Ÿå‹•Python APIæœå‹™å™¨ (ç«¯å£5050)"
        echo "  3. åœæ­¢æ‰€æœ‰æœå‹™å™¨"
        echo "  4. æŸ¥çœ‹é‹è¡Œä¸­çš„æœå‹™å™¨"
        echo "  0. è¿”å›ä¸Šä¸€å±¤"
        echo ""
        
        read -p "è«‹é¸æ“‡æ“ä½œ (0-4): " choice
        
        case $choice in
            1)
                echo -e "${GREEN}ğŸš€ å•Ÿå‹•HTTPæœå‹™å™¨ (ç«¯å£8000)...${NC}"
                python3 -m http.server 8000 > /dev/null 2>&1 &
                SERVER_PID=$!
                echo -e "âœ… æœå‹™å™¨å·²å•Ÿå‹• (PID: $SERVER_PID)"
                echo -e "ğŸŒ è¨ªå•åœ°å€: http://localhost:8000"
                sleep 2
                ;;
            2)
                echo -e "${GREEN}ğŸš€ å•Ÿå‹•APIæœå‹™å™¨ (ç«¯å£5050)...${NC}"
                if [ -f "save_server.py" ]; then
                    python3 save_server.py > /dev/null 2>&1 &
                    API_PID=$!
                    echo -e "âœ… APIæœå‹™å™¨å·²å•Ÿå‹• (PID: $API_PID)"
                    echo -e "ğŸ”— è¨ªå•åœ°å€: http://localhost:5050"
                else
                    echo -e "${YELLOW}âš ï¸  æ‰¾ä¸åˆ° save_server.py${NC}"
                    echo -e "æ­£åœ¨å‰µå»ºåŸºæœ¬APIæœå‹™å™¨..."
                    create_basic_server
                    python3 save_server.py > /dev/null 2>&1 &
                fi
                sleep 2
                ;;
            3)
                echo -e "${RED}ğŸ›‘ åœæ­¢æ‰€æœ‰Pythonæœå‹™å™¨...${NC}"
                pkill -f "python.*server" 2>/dev/null
                pkill -f "save_server.py" 2>/dev/null
                echo -e "âœ… æœå‹™å™¨å·²åœæ­¢"
                sleep 1
                ;;
            4)
                echo -e "${YELLOW}ğŸ“Š é‹è¡Œä¸­çš„æœå‹™å™¨é€²ç¨‹:${NC}"
                ps aux | grep -E "python.*server|save_server" | grep -v grep
                echo ""
                read -p "æŒ‰Enterç¹¼çºŒ..."
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}âŒ ç„¡æ•ˆé¸æ“‡${NC}"
                ;;
        esac
        sleep 1
    done
}

# å‡½æ•¸ï¼šå‰µå»ºåŸºæœ¬APIæœå‹™å™¨
create_basic_server() {
    cat > save_server.py << 'EOF'
from http.server import HTTPServer, SimpleHTTPRequestHandler
import json
import os
from datetime import datetime

class ShopeeAPIHandler(SimpleHTTPRequestHandler):
    def do_GET(self):
        # å…è¨±è·¨åŸŸ
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        
        if self.path == '/api/shopee/products':
            try:
                with open('js/shopee_list.json', 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                self.send_response(200)
                self.send_header('Content-type', 'application/json')
                self.end_headers()
                self.wfile.write(json.dumps(data, ensure_ascii=False).encode())
            except Exception as e:
                self.send_error(500, str(e))
        else:
            super().do_GET()
    
    def do_POST(self):
        if self.path == '/api/shopee/save':
            try:
                content_length = int(self.headers['Content-Length'])
                post_data = self.rfile.read(content_length)
                data = json.loads(post_data.decode('utf-8'))
                
                # æ·»åŠ æ™‚é–“æˆ³
                data['lastUpdated'] = datetime.now().isoformat()
                
                # ä¿å­˜åˆ°æ–‡ä»¶
                with open('js/shopee_list.json', 'w', encoding='utf-8') as f:
                    json.dump(data, f, indent=2, ensure_ascii=False)
                
                self.send_response(200)
                self.send_header('Content-type', 'application/json')
                self.send_header('Access-Control-Allow-Origin', '*')
                self.end_headers()
                response = {'success': True, 'message': 'æ•¸æ“šä¿å­˜æˆåŠŸ'}
                self.wfile.write(json.dumps(response).encode())
                
                print(f"[{datetime.now()}] âœ… ä¿å­˜äº† {len(data.get('products', []))} å€‹ç”¢å“")
                
            except Exception as e:
                self.send_response(500)
                self.send_header('Content-type', 'application/json')
                self.end_headers()
                response = {'success': False, 'error': str(e)}
                self.wfile.write(json.dumps(response).encode())
                print(f"[{datetime.now()}] âŒ ä¿å­˜å¤±æ•—: {e}")
        else:
            self.send_error(404, "API endpoint not found")
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()

if __name__ == '__main__':
    # ç¢ºä¿åœ¨é …ç›®æ ¹ç›®éŒ„é‹è¡Œ
    os.chdir(os.path.dirname(os.path.abspath(__file__)))
    
    server = HTTPServer(('127.0.0.1', 5050), ShopeeAPIHandler)
    print(f"[{datetime.now()}] ğŸš€ Shopee APIæœå‹™å™¨é‹è¡Œåœ¨ http://127.0.0.1:5050")
    print(f"[{datetime.now()}] ğŸ“ ç•¶å‰ç›®éŒ„: {os.getcwd()}")
    print(f"[{datetime.now()}] ğŸ“Š APIç«¯é»:")
    print(f"[{datetime.now()}]   GET  /api/shopee/products  - ç²å–ç”¢å“æ•¸æ“š")
    print(f"[{datetime.now()}]   POST /api/shopee/save     - ä¿å­˜ç”¢å“æ•¸æ“š")
    
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        print(f"\n[{datetime.now()}] ğŸ‘‹ æœå‹™å™¨å·²åœæ­¢")
EOF
    
    echo -e "${GREEN}âœ… å·²å‰µå»ºåŸºæœ¬APIæœå‹™å™¨: save_server.py${NC}"
    chmod +x save_server.py
}

# å‡½æ•¸ï¼šä¸»èœå–®
main_menu() {
    # æª¢æ¸¬ç•¶å‰ç›®éŒ„
    CURRENT_DIR=$(basename "$(pwd)")
    BASE_DIR=$(basename "$(dirname "$(pwd)")")
    
    while true; do
        show_title
        check_server_status
        
        # é¡¯ç¤ºç•¶å‰ä½ç½®
        echo -e "${YELLOW}ğŸ“ ç•¶å‰ä½ç½®:${NC}"
        pwd
        echo ""
        
        # æ ¹æ“šç›®éŒ„é¡¯ç¤ºä¸åŒèœå–®
        case "$CURRENT_DIR" in
            "myx_shop")
                echo -e "${GREEN}ğŸ  ä¸»é …ç›®ç›®éŒ„${NC}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo -e "${CYAN}ğŸŒ ç¶²ç«™ç³»çµ±:${NC}"
                echo "  1. ğŸ›ï¸  ç®¡ç†Shopeeé›»å•†ç³»çµ±"
                echo "  2. ğŸ“Š æ‰“é–‹AIé¸è‚¡é é¢ (bursa.html)"
                echo "  3. ğŸ  æ‰“é–‹ç¶²ç«™é¦–é  (index.html)"
                echo ""
                echo -e "${CYAN}ğŸ¤– AIç³»çµ±:${NC}"
                echo "  4. é‹è¡ŒAIè‚¡ç¥¨åˆ†æ"
                echo "  5. æŸ¥çœ‹AIå ±å‘Š"
                echo ""
                echo -e "${CYAN}ğŸ”§ å·¥å…·:${NC}"
                echo "  6. ğŸŒ æœå‹™å™¨ç®¡ç†"
                echo "  7. ğŸ“ ç€è¦½æ–‡ä»¶"
                echo "  8. ğŸ”„ åˆ‡æ›ç›®éŒ„"
                echo "  0. ğŸšª é€€å‡º"
                echo ""
                ;;
                
            "web")
                echo -e "${BLUE}ğŸŒ Webç›®éŒ„${NC}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "å¯ç”¨ç¶²é æ–‡ä»¶:"
                ls -1 *.html 2>/dev/null | nl
                echo ""
                echo "  9. è¿”å›ä¸»ç›®éŒ„"
                echo "  0. é€€å‡º"
                echo ""
                ;;
                
            "scripts")
                echo -e "${PURPLE}ğŸ¤– Scriptsç›®éŒ„${NC}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "å¯ç”¨è…³æœ¬:"
                ls -1 *.py *.sh 2>/dev/null | nl
                echo ""
                echo "  9. è¿”å›ä¸»ç›®éŒ„"
                echo "  0. é€€å‡º"
                echo ""
                ;;
                
            *)
                echo -e "${YELLOW}ğŸ“ å…¶ä»–ç›®éŒ„: $CURRENT_DIR${NC}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "  1. é€²å…¥myx_shopä¸»ç›®éŒ„"
                echo "  2. é€²å…¥webç›®éŒ„"
                echo "  3. é€²å…¥scriptsç›®éŒ„"
                echo "  0. é€€å‡º"
                echo ""
                ;;
        esac
        
        read -p "è«‹é¸æ“‡æ“ä½œ: " choice
        
        case "$CURRENT_DIR" in
            "myx_shop")
                case $choice in
                    1) manage_shopee ;;
                    2) open_file "bursa.html" "AIé¸è‚¡ç³»çµ±" ;;
                    3) open_file "index.html" "ç¶²ç«™é¦–é " ;;
                    4) 
                        echo -e "${GREEN}ğŸ¤– é‹è¡ŒAIåˆ†æ...${NC}"
                        if [ -d "scripts" ]; then
                            cd scripts && ./Bursa
                            cd ..
                        else
                            echo -e "${RED}âŒ æ‰¾ä¸åˆ°scriptsç›®éŒ„${NC}"
                        fi
                        ;;
                    5)
                        if [ -f "web/ai_analysis_preview.html" ]; then
                            open_file "web/ai_analysis_preview.html" "AIåˆ†æå ±å‘Š"
                        else
                            echo -e "${YELLOW}âš ï¸  æ‰¾ä¸åˆ°AIå ±å‘Š${NC}"
                        fi
                        ;;
                    6) manage_server ;;
                    7)
                        echo -e "${YELLOW}ğŸ“ æ–‡ä»¶åˆ—è¡¨:${NC}"
                        find . -maxdepth 2 -type f \( -name "*.html" -o -name "*.json" -o -name "*.py" \) | sort
                        echo ""
                        read -p "æŒ‰Enterç¹¼çºŒ..."
                        ;;
                    8)
                        echo "é¸æ“‡ç›®éŒ„:"
                        select dir in "web" "scripts" "admin" "js" "images"; do
                            if [ -d "$dir" ]; then
                                cd "$dir" && exec "$0"
                            fi
                            break
                        done
                        ;;
                    0)
                        echo -e "${GREEN}ğŸ‘‹ å†è¦‹ï¼${NC}"
                        exit 0
                        ;;
                    *)
                        echo -e "${RED}âŒ ç„¡æ•ˆé¸æ“‡${NC}"
                        sleep 1
                        ;;
                esac
                ;;
                
            "web"|"scripts")
                case $choice in
                    [1-9])
                        if [ "$choice" = "9" ]; then
                            cd "$PROJECT_ROOT" && exec "$0"
                        else
                            files=($(ls -1 *.html 2>/dev/null))
                            if [ ${#files[@]} -ge $choice ]; then
                                open_file "${files[$((choice-1))]}" "${files[$((choice-1))]}"
                            else
                                echo -e "${RED}âŒ æ–‡ä»¶ä¸å­˜åœ¨${NC}"
                            fi
                        fi
                        read -p "æŒ‰Enterç¹¼çºŒ..."
                        ;;
                    0)
                        echo -e "${GREEN}ğŸ‘‹ å†è¦‹ï¼${NC}"
                        exit 0
                        ;;
                    *)
                        echo -e "${RED}âŒ ç„¡æ•ˆé¸æ“‡${NC}"
                        sleep 1
                        ;;
                esac
                ;;
                
            *)
                case $choice in
                    1) cd "$PROJECT_ROOT" && exec "$0" ;;
                    2) cd "$PROJECT_ROOT/web" && exec "$0" ;;
                    3) cd "$PROJECT_ROOT/scripts" && exec "$0" ;;
                    0)
                        echo -e "${GREEN}ğŸ‘‹ å†è¦‹ï¼${NC}"
                        exit 0
                        ;;
                    *)
                        echo -e "${RED}âŒ ç„¡æ•ˆé¸æ“‡${NC}"
                        sleep 1
                        ;;
                esac
                ;;
        esac
    done
}

# ç¢ºä¿åœ¨æ­£ç¢ºçš„ç›®éŒ„
if [ ! -d "$PROJECT_ROOT" ]; then
    echo -e "${RED}âŒ é …ç›®ç›®éŒ„ä¸å­˜åœ¨: $PROJECT_ROOT${NC}"
    echo -e "è«‹æª¢æŸ¥è·¯å¾‘è¨­ç½®"
    exit 1
fi

# å¦‚æœä¸åœ¨é …ç›®ç›®éŒ„ï¼Œè‡ªå‹•å°èˆª
if [ "$(pwd)" != "$PROJECT_ROOT" ] && [ "$(basename "$(pwd)")" != "web" ] && [ "$(basename "$(pwd)")" != "scripts" ]; then
    echo -e "${YELLOW}ğŸ”„ è‡ªå‹•å°èˆªåˆ°é …ç›®ç›®éŒ„...${NC}"
    cd "$PROJECT_ROOT"
fi

# å•Ÿå‹•ä¸»èœå–®
main_menu