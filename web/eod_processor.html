<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š EOD CSVä¸“ä¸šå¤„ç†å™¨ - åˆ—é‡æ’ & è¡Œä¸šè½¬æ¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        /* ä¸¤æ å¸ƒå±€ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: 800px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .content-area {
            padding: 25px;
            overflow-y: auto;
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            background: #f5f7fa;
            border-left: 1px solid #e0e0e0;
            padding: 25px;
            overflow-y: auto;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .card h2 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* åˆ—ç®¡ç†åŒºåŸŸ */
        .column-manager {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .column-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
        }
        
        .column-item:hover {
            border-color: #1976d2;
            background: #e3f2fd;
            transform: translateY(-2px);
        }
        
        .column-item.dragging {
            opacity: 0.5;
            border-style: dashed;
        }
        
        .column-handle {
            color: #1976d2;
            cursor: move;
        }
        
        .column-name {
            font-weight: 500;
            color: #333;
        }
        
        /* ç›®æ ‡åˆ—åŒºåŸŸ */
        .target-columns {
            min-height: 200px;
            border: 3px dashed #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            background: #f8f9fa;
        }
        
        .target-placeholder {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .target-columns .column-item {
            background: #E8F5E9;
            border-color: #4CAF50;
        }
        
        /* è¡Œä¸šæ˜ å°„åŒºåŸŸ */
        .sector-mapping {
            background: #fff3e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #FFB74D;
        }
        
        .sector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .sector-item {
            background: white;
            border: 1px solid #FFB74D;
            border-radius: 6px;
            padding: 10px;
            font-size: 13px;
        }
        
        .sector-code {
            font-weight: bold;
            color: #1976d2;
        }
        
        .sector-name {
            color: #333;
        }
        
        /* é¢„è§ˆåŒºåŸŸ */
        .preview-area {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            color: #d4d4d4;
        }
        
        .preview-table th {
            background: #2d2d2d;
            padding: 8px;
            border: 1px solid #404040;
            text-align: left;
            font-weight: bold;
            color: #569cd6;
        }
        
        .preview-table td {
            padding: 8px;
            border: 1px solid #404040;
            white-space: nowrap;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #1976d2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388E3C;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #FF9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: #2196F3;
            color: white;
        }
        
        .btn-info:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #E8F5E9;
            border-color: #2E7D32;
        }
        
        .upload-area i {
            font-size: 60px;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        /* ä¾§è¾¹æ ä¿¡æ¯ */
        .info-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #1976d2;
        }
        
        .info-box.warning {
            border-left-color: #FF9800;
            background: #fff3e0;
        }
        
        .info-box.success {
            border-left-color: #4CAF50;
            background: #E8F5E9;
        }
        
        .info-box h4 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* åŒ¹é…çŠ¶æ€æ ‡ç­¾ */
        .match-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .match-good {
            background: #4CAF50;
            color: white;
        }
        
        .match-warning {
            background: #FF9800;
            color: white;
        }
        
        .match-bad {
            background: #f44336;
            color: white;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #1976d2;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1000px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid #e0e0e0;
            }
        }
        
        @media (max-width: 600px) {
            .header h1 {
                font-size: 22px;
            }
            
            .column-list {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1><i class="fas fa-columns"></i> EOD CSVä¸“ä¸šå¤„ç†å™¨</h1>
            <div class="subtitle">ä¸“é—¨è§£å†³ï¼šåˆ—æ’åˆ— + è¡Œä¸šä»£ç è½¬æ¢</div>
        </div>
        
        <div class="main-content">
            <!-- ä¸»å†…å®¹åŒº -->
            <div class="content-area">
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div class="card">
                    <h2><i class="fas fa-file-upload"></i> ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ åŸå§‹EOD CSVæ–‡ä»¶</h2>
                    <p style="color: #666; margin-bottom: 15px;">
                        ä»æ‚¨çš„è‚¡ç¥¨ç»çºªç³»ç»Ÿä¸‹è½½çš„EOD CSVæ–‡ä»¶ï¼ˆç¡®ä¿åŒ…å«æ‰€æœ‰å¿…éœ€åˆ—ï¼‰
                    </p>
                    
                    <div class="upload-area" onclick="document.getElementById('csvInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>ç‚¹å‡»ä¸Šä¼ EOD CSVæ–‡ä»¶</h3>
                        <p>æ”¯æŒ .csv æ ¼å¼ | è‡ªåŠ¨æ£€æµ‹åˆ—ç»“æ„</p>
                    </div>
                    
                    <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                    
                    <div id="uploadStatus" style="margin-top: 15px;"></div>
                </div>
                
                <!-- åˆ—æ’åˆ—å¤„ç† -->
                <div class="card" id="columnSection" style="display: none;">
                    <h2><i class="fas fa-sort-alpha-down"></i> ç¬¬äºŒæ­¥ï¼šåˆ—æ’åˆ—ç®¡ç†</h2>
                    <p style="color: #666; margin-bottom: 15px;">
                        æ‹–æ‹½ä¸‹é¢çš„åˆ—åˆ°ç›®æ ‡åŒºåŸŸï¼ŒæŒ‰ç…§è¦æ±‚çš„é¡ºåºæ’åˆ—ï¼š
                    </p>
                    
                    <div class="column-manager">
                        <h3 style="color: #1976d2; margin-bottom: 10px;">å¯ç”¨åˆ—ï¼š</h3>
                        <div class="column-list" id="availableColumns">
                            <!-- å¯ç”¨åˆ—ä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="column-manager">
                        <h3 style="color: #4CAF50; margin-bottom: 10px;">ç›®æ ‡åˆ—é¡ºåºï¼š</h3>
                        <div class="target-columns" id="targetColumns">
                            <div class="target-placeholder">
                                <i class="fas fa-arrow-down" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                                <div>å°†åˆ—æ‹–æ”¾åˆ°è¿™é‡Œ</div>
                                <div style="font-size: 12px; margin-top: 5px; color: #999;">
                                    æŒ‰ç…§è¦æ±‚é¡ºåºï¼šCode, Stock, Sector, Open, Last, Prv Close...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button onclick="autoArrangeColumns()" class="btn btn-primary btn-small">
                            <i class="fas fa-magic"></i> è‡ªåŠ¨æ’åˆ—
                        </button>
                        <button onclick="adjustColumnManually()" class="btn btn-info btn-small">
                            <i class="fas fa-hand-pointer"></i> æ‰‹åŠ¨è°ƒæ•´
                        </button>
                        <button onclick="showColumnMatchStatus()" class="btn btn-info btn-small">
                            <i class="fas fa-check-circle"></i> æ£€æŸ¥åŒ¹é…
                        </button>
                        <button onclick="debugDataMapping()" class="btn btn-warning btn-small">
                            <i class="fas fa-bug"></i> è°ƒè¯•
                        </button>
                        <button onclick="resetColumns()" class="btn btn-warning btn-small">
                            <i class="fas fa-redo"></i> é‡ç½®
                        </button>
                    </div>
                </div>
                
                <!-- è¡Œä¸šä»£ç è½¬æ¢ -->
                <div class="card" id="sectorSection" style="display: none;">
                    <h2><i class="fas fa-exchange-alt"></i> ç¬¬ä¸‰æ­¥ï¼šè¡Œä¸šä»£ç è½¬æ¢</h2>
                    <p style="color: #666; margin-bottom: 15px;">
                        å°†æ•°å­—è¡Œä¸šä»£ç è½¬æ¢ä¸ºå®é™…è¡Œä¸šåç§°ï¼š
                    </p>
                    
                    <div class="sector-mapping">
                        <h3 style="color: #FF9800; margin-bottom: 10px;">è¡Œä¸šä»£ç æ˜ å°„ï¼š</h3>
                        <div class="sector-grid" id="sectorMapping">
                            <!-- è¡Œä¸šæ˜ å°„ä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button onclick="applySectorMapping()" class="btn btn-success">
                            <i class="fas fa-sync-alt"></i> åº”ç”¨è¡Œä¸šè½¬æ¢
                        </button>
                        <button onclick="viewSectorStats()" class="btn btn-warning btn-small">
                            <i class="fas fa-chart-bar"></i> æŸ¥çœ‹ç»Ÿè®¡
                        </button>
                    </div>
                </div>
                
                <!-- æ•°æ®é¢„è§ˆ -->
                <div class="card" id="previewSection" style="display: none;">
                    <h2><i class="fas fa-eye"></i> ç¬¬å››æ­¥ï¼šå¤„ç†ç»“æœé¢„è§ˆ</h2>
                    <p style="color: #666; margin-bottom: 15px;">
                        å¤„ç†åçš„æ•°æ®é¢„è§ˆï¼ˆå‰10è¡Œï¼‰ï¼š
                    </p>
                    
                    <div class="preview-area">
                        <table class="preview-table" id="dataPreview">
                            <!-- æ•°æ®é¢„è§ˆä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </table>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div style="font-size: 12px; color: #666;">
                            æ˜¾ç¤º <span id="previewRowCount">0</span> è¡Œæ•°æ®
                        </div>
                        <button onclick="showFullPreview()" style="background: none; border: none; color: #1976d2; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-expand"></i> æ˜¾ç¤ºå®Œæ•´æ•°æ®
                        </button>
                    </div>
                </div>
                
                <!-- å¤„ç†è¿›åº¦ -->
                <div class="card" id="processSection" style="display: none;">
                    <h2><i class="fas fa-cogs"></i> ç¬¬äº”æ­¥ï¼šå¼€å§‹å¤„ç†</h2>
                    <p style="color: #666; margin-bottom: 15px;">
                        ç¡®è®¤æ‰€æœ‰è®¾ç½®åï¼Œå¼€å§‹å¤„ç†æ•°æ®ï¼š
                    </p>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="processProgress" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; color: #666;">
                            <span id="processText">ç­‰å¾…å¼€å§‹...</span>
                            <span id="processPercent">0%</span>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button onclick="startProcessing()" class="btn btn-success">
                            <i class="fas fa-play-circle"></i> å¼€å§‹å¤„ç†
                        </button>
                        <button onclick="downloadResult()" class="btn btn-primary" id="downloadBtn" disabled>
                            <i class="fas fa-download"></i> ä¸‹è½½ç»“æœ
                        </button>
                        <button onclick="exportToJSON()" class="btn btn-warning">
                            <i class="fas fa-file-export"></i> å¯¼å‡ºJSON
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="info-box">
                    <h4><i class="fas fa-list-ol"></i> å¤„ç†æ­¥éª¤</h4>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span id="step1" style="background: #1976d2; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">1</span>
                            <span>ä¸Šä¼ CSVæ–‡ä»¶</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span id="step2" style="background: #e0e0e0; color: #666; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">2</span>
                            <span>åˆ—æ’åˆ—ç®¡ç†</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span id="step3" style="background: #e0e0e0; color: #666; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">3</span>
                            <span>è¡Œä¸šä»£ç è½¬æ¢</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span id="step4" style="background: #e0e0e0; color: #666; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">4</span>
                            <span>ç»“æœé¢„è§ˆ</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="step5" style="background: #e0e0e0; color: #666; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">5</span>
                            <span>å®Œæˆä¸‹è½½</span>
                        </div>
                    </div>
                </div>
                
                <!-- å¿…éœ€åˆ—ä¿¡æ¯ -->
                <div class="info-box warning">
                    <h4><i class="fas fa-exclamation-triangle"></i> å¿…éœ€åˆ— (20åˆ—)</h4>
                    <div style="font-size: 13px; color: #555; line-height: 1.5;">
                        è¯·ç¡®ä¿ä»¥ä¸‹åˆ—æŒ‰é¡ºåºæ’åˆ—ï¼š
                        <ol style="padding-left: 20px; margin-top: 8px; font-size: 12px;">
                            <li>Code</li>
                            <li>Stock</li>
                            <li>Sector</li>
                            <li>Open</li>
                            <li>Last</li>
                            <li>Prv Close</li>
                            <li>Chg</li>
                            <li>High</li>
                            <li>Low</li>
                            <li>Y-High</li>
                            <li>Y-Low</li>
                            <li>Vol</li>
                            <li>DY*</li>
                            <li>B%</li>
                            <li>Vol MA (20)</li>
                            <li>RSI (14)</li>
                            <li>MACD (26,12)</li>
                            <li>EPS*</li>
                            <li>P/E</li>
                            <li>Status</li>
                        </ol>
                    </div>
                </div>
                
                <!-- è¡Œä¸šæ˜ å°„ä¿¡æ¯ -->
                <div class="info-box success">
                    <h4><i class="fas fa-map-signs"></i> è¡Œä¸šä»£ç ç¤ºä¾‹</h4>
                    <div style="font-size: 13px; color: #555; line-height: 1.5;">
                        <div><strong>101-166:</strong> Industrial & Consumer Products</div>
                        <div><strong>301-365:</strong> Technology</div>
                        <div><strong>401-465:</strong> Property</div>
                        <div><strong>501-560:</strong> Telecom & Media</div>
                        <div><strong>653-657:</strong> Transportation</div>
                        <div><strong>701-762:</strong> Utilities</div>
                        <div><strong>1201-1205:</strong> Financial</div>
                        <button onclick="showFullSectorMapping()" style="background: none; border: none; color: #1976d2; cursor: pointer; font-size: 12px; margin-top: 10px;">
                            <i class="fas fa-list"></i> æŸ¥çœ‹å®Œæ•´æ˜ å°„
                        </button>
                    </div>
                </div>
                
                <!-- å¤„ç†çŠ¶æ€ -->
                <div class="info-box">
                    <h4><i class="fas fa-info-circle"></i> å½“å‰çŠ¶æ€</h4>
                    <div id="currentStatus" style="font-size: 14px; color: #666;">
                        ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...
                    </div>
                    <div id="fileInfo" style="margin-top: 10px; font-size: 12px; color: #888;">
                        <!-- æ–‡ä»¶ä¿¡æ¯ä¼šåŠ¨æ€æ˜¾ç¤º -->
                    </div>
                    <div id="columnMatchInfo" style="margin-top: 10px; font-size: 12px;">
                        <!-- åˆ—åŒ¹é…ä¿¡æ¯ä¼šåŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div style="margin-top: 20px;">
                    <button onclick="loadSampleData()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-vial"></i> åŠ è½½ç¤ºä¾‹æ•°æ®
                    </button>
                    <button onclick="resetAll()" class="btn btn-warning" style="width: 100%;">
                        <i class="fas fa-trash"></i> å…¨éƒ¨é‡ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®Œæ•´è¡Œä¸šæ˜ å°„æ¨¡æ€æ¡† -->
    <div id="sectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;"><i class="fas fa-map"></i> å®Œæ•´è¡Œä¸šä»£ç æ˜ å°„</h3>
                <button onclick="closeSectorModal()" class="modal-close">Ã—</button>
            </div>
            <div class="modal-body" id="fullSectorMapping">
                <!-- å®Œæ•´æ˜ å°„ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- è¡Œä¸šç»Ÿè®¡æ¨¡æ€æ¡† -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;"><i class="fas fa-chart-bar"></i> è¡Œä¸šåˆ†å¸ƒç»Ÿè®¡</h3>
                <button onclick="closeStatsModal()" class="modal-close">Ã—</button>
            </div>
            <div class="modal-body" id="statsContent">
                <!-- ç»Ÿè®¡ä¿¡æ¯ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let rawData = [];
        let processedData = [];
        let currentColumns = [];
        let targetColumnOrder = [];
        let sectorMapping = {};
        let finalData = [];
        
        // æ ‡å‡†åˆ—é¡ºåº - ç”¨äºCSVè¾“å‡º
        const STANDARD_COLUMN_NAMES = [
            "Code", "Stock", "Sector", "Open", "Last", "Prv Close", "Chg", "High", "Low", 
            "Y-High", "Y-Low", "Vol", "DY*", "B%", "Vol MA (20)", "RSI (14)", "MACD (26,12)", 
            "EPS*", "P/E", "Status"
        ];
        
        // ä¼˜åŒ–çš„åˆ—åæ˜ å°„ï¼ˆæ”¯æŒå¤šç§åˆ—åå˜ä½“ï¼‰
        const COLUMN_MAPPING = {
            "Code": ["Code", "è‚¡ç¥¨ä»£ç ", "ä»£ç ", "Symbol", "Ticker", "ä»£å·", "è¯åˆ¸ä»£ç ", "è‚¡å·"],
            "Stock": ["Stock", "è‚¡ç¥¨", "åç§°", "Name", "å…¬å¸åç§°", "è‚¡ç¥¨åç§°", "å…¬å¸", "è‚¡ç¥¨å"],
            "Sector": ["Sector", "è¡Œä¸š", "æ¿å—", "Industry", "è¡Œä¸šåˆ†ç±»", "æ‰€å±è¡Œä¸š", "äº§ä¸š", "æ¿å—åˆ†ç±»"],
            "Open": ["Open", "å¼€ç›˜ä»·", "å¼€ç›˜", "Opening Price", "å¼€å¸‚ä»·", "ä»Šå¼€", "å¼€ç›˜ä»·æ ¼"],
            "Last": ["Last", "æœ€æ–°ä»·", "ç°ä»·", "å½“å‰ä»·", "æ”¶ç›˜ä»·", "æœ€åä»·", "æˆäº¤ä»·", "å½“å‰ä»·æ ¼"],
            "Prv Close": ["Prv Close", "å‰æ”¶ç›˜", "æ˜¨æ—¥æ”¶ç›˜", "Previous Close", "å‰æ”¶", "æ˜¨æ”¶", "å‰ä¸€æ—¥æ”¶ç›˜", "æ˜¨æ—¥æ”¶å¸‚", "Prev Close"],
            "Chg": ["Chg", "æ¶¨è·Œ", "å˜åŒ–", "Change", "æ¶¨è·Œå¹…", "å˜åŠ¨", "æ¶¨å¹…", "å˜åŒ–ç‡", "æ¶¨è·Œ%", "Chg%", "Change%"],
            "High": ["High", "æœ€é«˜ä»·", "æœ€é«˜", "æœ€é«˜ä»·", "æ—¥å†…æœ€é«˜", "å½“æ—¥æœ€é«˜"],
            "Low": ["Low", "æœ€ä½ä»·", "æœ€ä½", "æœ€ä½ä»·", "æ—¥å†…æœ€ä½", "å½“æ—¥æœ€ä½"],
            "Y-High": ["Y-High", "å¹´æœ€é«˜", "52å‘¨æœ€é«˜", "Year High", "52å‘¨é«˜", "å¹´åº¦æœ€é«˜", "å¹´å†…æœ€é«˜", "Year-High"],
            "Y-Low": ["Y-Low", "å¹´æœ€ä½", "52å‘¨æœ€ä½", "Year Low", "52å‘¨ä½", "å¹´åº¦æœ€ä½", "å¹´å†…æœ€ä½", "Year-Low"],
            "Vol": ["Vol", "æˆäº¤é‡", "äº¤æ˜“é‡", "Volume", "æˆäº¤é¢", "é‡", "æˆäº¤è‚¡æ•°", "äº¤æ˜“è‚¡æ•°"],
            "DY*": ["DY*", "è‚¡æ¯ç‡", "è‚¡æ¯æ”¶ç›Šç‡", "Dividend Yield", "è‚¡æ¯", "åˆ†çº¢ç‡", "è‚¡æ¯%", "Dividend"],
            "B%": ["B%", "è´å¡”ç³»æ•°", "Beta", "æ³¢åŠ¨ç‡", "é£é™©ç³»æ•°", "Î²", "Betaç³»æ•°"],
            "Vol MA (20)": ["Vol MA (20)", "æˆäº¤é‡å‡çº¿20", "20æ—¥æˆäº¤é‡å‡çº¿", "Vol MA 20", "Volume MA 20", "20æ—¥å‡é‡", "æˆäº¤é‡20æ—¥å‡çº¿", "Vol MA(20)"],
            "RSI (14)": ["RSI (14)", "RSI", "ç›¸å¯¹å¼ºå¼±æŒ‡æ•°", "RSI 14", "ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡", "RSIæŒ‡æ ‡"],
            "MACD (26,12)": ["MACD (26,12)", "MACD", "æŒ‡æ•°å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿", "MACDæŒ‡æ ‡", 
                           "MACD(26,12)", "MACD (26, 12)", "MACD(26, 12)", "MACD 26 12", 
                           "MACD(26,12,9)", "MACD (26,12,9)", "MACD 26-12", "MACD (26,12)", "MACD(26,12)"],
            "EPS*": ["EPS*", "æ¯è‚¡æ”¶ç›Š", "EPS", "æ¯è‚¡ç›ˆåˆ©", "æ¯è‚¡ç›ˆä½™", "Earnings Per Share", "æ¯è‚¡æ”¶ç›ŠEPS"],
            "P/E": ["P/E", "å¸‚ç›ˆç‡", "PE", "è‚¡ä»·æ”¶ç›Šæ¯”", "æœ¬ç›Šæ¯”", "å¸‚ç›ˆç‡(PE)", "PE Ratio", "P/E Ratio"],
            "Status": ["Status", "çŠ¶æ€", "äº¤æ˜“çŠ¶æ€", "ä¸Šå¸‚çŠ¶æ€", "è‚¡ç¥¨çŠ¶æ€", "ä¸Šå¸‚æƒ…å†µ", "äº¤æ˜“æƒ…å†µ"]
        };
        
        // è¡Œä¸šæ˜ å°„æ•°æ®
        const SECTOR_MAP = {
            "101": "Industrial & Consumer Products",
            "102": "Industrial & Consumer Products", 
            "103": "Industrial & Consumer Products",
            "105": "Industrial & Consumer Products",
            "110": "Industrial & Consumer Products",
            "120": "Industrial & Consumer Products",
            "125": "Industrial & Consumer Products",
            "150": "Industrial & Consumer Products",
            "155": "Industrial & Consumer Products",
            "161": "Industrial & Consumer Products",
            "162": "Industrial & Consumer Products",
            "163": "Industrial & Consumer Products",
            "164": "Industrial & Consumer Products",
            "165": "Industrial & Consumer Products",
            "166": "Industrial & Consumer Products",
            "301": "Technology",
            "302": "Technology",
            "303": "Technology",
            "305": "Technology",
            "310": "Technology",
            "320": "Technology",
            "325": "Technology",
            "358": "Technology",
            "361": "Technology",
            "362": "Technology",
            "363": "Technology",
            "364": "Technology",
            "365": "Technology",
            "401": "Property",
            "402": "Property",
            "403": "Property",
            "405": "Property",
            "410": "Property",
            "420": "Property",
            "425": "Property",
            "461": "Property",
            "462": "Property",
            "463": "Property",
            "464": "Property",
            "465": "Property",
            "501": "Telecommunications & Media",
            "502": "Telecommunications & Media",
            "520": "Telecommunications & Media",
            "560": "Telecommunications & Media",
            "653": "Transportation & Logistics",
            "654": "Transportation & Logistics",
            "656": "Transportation & Logistics",
            "657": "Transportation & Logistics",
            "701": "Utilities",
            "702": "Utilities",
            "703": "Utilities",
            "705": "Utilities",
            "710": "Utilities",
            "725": "Utilities",
            "762": "Utilities",
            "0162": "Medical Devices & Supplies",
            "0405": "Software & IT Services",
            "1701": "Industrial Holding Firms",
            "1702": "Industrial & Consumer Products",
            "1703": "Industrial Support Services",
            "1704": "Building Materials",
            "1705": "Construction & Infrastructure",
            "1706": "Transportation & Logistics",
            "1801": "Consumer Product Holding Firms",
            "1802": "Food, Beverage & Tobacco",
            "1803": "Retail & Distribution",
            "1804": "Hotel, Resort & Recreational Services",
            "1805": "Media & Entertainment",
            "1806": "Other Consumer Services",
            "1807": "Health Care Equipment & Services",
            "1808": "Pharmaceuticals & Biotechnology",
            "1809": "Technology",
            "1810": "Telecommunications & Media",
            "0200": "Plantation",
            "0501": "Property Holding Firms",
            "0502": "Property Development",
            "0503": "Real Estate Investment Trusts (REITs)",
            "0504": "Other Property-related Services",
            "1201": "Financial Holding Firms",
            "1202": "Commercial Banks",
            "1203": "Insurance",
            "1204": "Investment Banks",
            "1205": "Other Finance",
            "0301": "Energy Holding Firms",
            "0302": "Energy-related Equipment & Services",
            "0303": "Oil & Gas",
            "0401": "Utilities Holding Firms",
            "0402": "Gas, Water & Multi-utilities",
            "0403": "Electricity",
            "0080": "Special Purpose Acquisition",
            
            // é»˜è®¤æ˜ å°„
            "default_mapping": {
                "1": "Industrial & Consumer Products",
                "2": "Technology", 
                "3": "Property",
                "4": "Telecommunications & Media",
                "5": "Transportation & Logistics",
                "6": "Utilities",
                "7": "Medical",
                "8": "Financial",
                "9": "Energy",
                "10": "Consumer"
            }
        };
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            initializeSectorMapping();
            setupDragAndDrop();
        });
        
        // åˆå§‹åŒ–è¡Œä¸šæ˜ å°„æ˜¾ç¤º
        function initializeSectorMapping() {
            const container = document.getElementById('sectorMapping');
            let html = '';
            
            // æ˜¾ç¤ºä¸»è¦åˆ†ç±»
            const mainCategories = {
                'Industrial & Consumer Products': ['101-166'],
                'Technology': ['301-365'],
                'Property': ['401-465'],
                'Financial': ['1201-1205'],
                'Telecom & Media': ['501-560'],
                'Transportation': ['653-657'],
                'Utilities': ['701-762']
            };
            
            for (const [category, ranges] of Object.entries(mainCategories)) {
                html += `
                    <div class="sector-item">
                        <div class="sector-code">${ranges.join(', ')}</div>
                        <div class="sector-name">${category}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        function setupDragAndDrop() {
            const targetArea = document.getElementById('targetColumns');
            
            targetArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#f1f8e9';
            });
            
            targetArea.addEventListener('dragleave', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            
            targetArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.backgroundColor = '#f8f9fa';
                
                const columnName = e.dataTransfer.getData('text/plain');
                if (columnName && !targetColumnOrder.includes(columnName)) {
                    addColumnToTarget(columnName);
                }
            });
        }
        
        // å¤„ç†CSVä¸Šä¼ 
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.innerHTML = `
                <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¯»å–æ–‡ä»¶: ${file.name}
                </div>
            `;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    
                    if (lines.length < 2) {
                        throw new Error('CSVæ–‡ä»¶å†…å®¹è¿‡å°‘');
                    }
                    
                    // è§£æCSV
                    const headers = parseCSVLine(lines[0]);
                    const data = [];
                    
                    for (let i = 1; i < Math.min(1000, lines.length); i++) {
                        if (lines[i].trim()) {
                            const values = parseCSVLine(lines[i]);
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header.trim()] = values[index] ? values[index].trim() : '';
                            });
                            data.push(row);
                        }
                    }
                    
                    if (data.length === 0) {
                        throw new Error('CSVæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                    }
                    
                    rawData = data;
                    currentColumns = headers.map(h => h.trim());
                    
                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    uploadStatus.innerHTML = `
                        <div style="background: #E8F5E9; padding: 10px; border-radius: 5px; color: #4CAF50;">
                            <i class="fas fa-check-circle"></i> æˆåŠŸè¯»å–æ–‡ä»¶ï¼
                            <div style="font-size: 12px; margin-top: 5px;">
                                å‘ç° ${data.length} è¡Œæ•°æ®ï¼Œ${headers.length} ä¸ªåˆ—
                            </div>
                        </div>
                    `;
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    updateStepStatus(1, true);
                    
                    // æ›´æ–°çŠ¶æ€
                    document.getElementById('currentStatus').innerHTML = `
                        <span style="color: #4CAF50;">âœ“ æ–‡ä»¶å·²ä¸Šä¼ </span><br>
                        <span style="font-size: 12px; color: #888;">${data.length} è¡Œæ•°æ®</span>
                    `;
                    
                    document.getElementById('fileInfo').innerHTML = `
                        æ–‡ä»¶å: ${file.name}<br>
                        å¤§å°: ${formatFileSize(file.size)}<br>
                        åˆ—æ•°: ${headers.length}
                    `;
                    
                    // æ˜¾ç¤ºåˆ—ç®¡ç†åŒºåŸŸ
                    document.getElementById('columnSection').style.display = 'block';
                    document.getElementById('sectorSection').style.display = 'block';
                    document.getElementById('previewSection').style.display = 'block';
                    document.getElementById('processSection').style.display = 'block';
                    
                    // åˆå§‹åŒ–åˆ—åˆ—è¡¨
                    initializeColumnList();
                    
                    // å°è¯•è‡ªåŠ¨æ’åˆ—åˆ—
                    setTimeout(() => {
                        autoArrangeColumns();
                        updateStepStatus(2, true);
                    }, 500);
                    
                } catch (error) {
                    console.error('CSVè§£æé”™è¯¯:', error);
                    uploadStatus.innerHTML = `
                        <div style="background: #FFEBEE; padding: 10px; border-radius: 5px; color: #f44336;">
                            <i class="fas fa-exclamation-triangle"></i> æ–‡ä»¶è§£æå¤±è´¥
                            <div style="font-size: 12px; margin-top: 5px;">
                                ${error.message}
                            </div>
                        </div>
                    `;
                }
            };
            
            reader.onerror = function() {
                uploadStatus.innerHTML = `
                    <div style="background: #FFEBEE; padding: 10px; border-radius: 5px; color: #f44336;">
                        <i class="fas fa-exclamation-triangle"></i> æ–‡ä»¶è¯»å–å¤±è´¥
                    </div>
                `;
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // è§£æCSVè¡Œ
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // åˆå§‹åŒ–åˆ—åˆ—è¡¨
        function initializeColumnList() {
            const container = document.getElementById('availableColumns');
            container.innerHTML = '';
            
            currentColumns.forEach(column => {
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';
                columnItem.id = `column-${column}`;
                columnItem.draggable = true;
                columnItem.innerHTML = `
                    <span class="column-handle"><i class="fas fa-grip-vertical"></i></span>
                    <span class="column-name">${column}</span>
                `;
                
                columnItem.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', column);
                    this.classList.add('dragging');
                });
                
                columnItem.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                container.appendChild(columnItem);
            });
        }
        
        // æ·»åŠ åˆ—åˆ°ç›®æ ‡åŒºåŸŸ
        function addColumnToTarget(columnName) {
            if (targetColumnOrder.includes(columnName)) {
                return; // å·²ç»å­˜åœ¨
            }
            
            targetColumnOrder.push(columnName);
            updateTargetColumnsDisplay();
            updateColumnMatchInfo();
        }
        
        // ä»ç›®æ ‡åŒºåŸŸç§»é™¤åˆ—
        function removeFromTarget(columnName) {
            targetColumnOrder = targetColumnOrder.filter(col => col !== columnName);
            updateTargetColumnsDisplay();
            updateColumnMatchInfo();
        }
        
        // æ›´æ–°ç›®æ ‡åˆ—æ˜¾ç¤º
        function updateTargetColumnsDisplay() {
            const targetContainer = document.getElementById('targetColumns');
            targetContainer.innerHTML = '';
            
            if (targetColumnOrder.length === 0) {
                targetContainer.innerHTML = `
                    <div class="target-placeholder">
                        <i class="fas fa-arrow-down" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                        <div>å°†åˆ—æ‹–æ”¾åˆ°è¿™é‡Œ</div>
                    </div>
                `;
            } else {
                targetColumnOrder.forEach((columnName, index) => {
                    const columnItem = document.createElement('div');
                    columnItem.className = 'column-item';
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ¹é…æ ‡å‡†åˆ—å
                    const standardCol = STANDARD_COLUMN_NAMES[index];
                    const isMatched = standardCol && checkColumnMatch(columnName, standardCol);
                    
                    columnItem.innerHTML = `
                        <span class="column-handle"><i class="fas fa-grip-vertical"></i></span>
                        <span class="column-name">${columnName}</span>
                        ${index < STANDARD_COLUMN_NAMES.length ? 
                            `<span class="match-badge ${isMatched ? 'match-good' : 'match-warning'}">
                                ${index + 1}
                            </span>` : 
                            `<span class="match-badge" style="background:#9e9e9e;color:white;">
                                ${index + 1}
                            </span>`
                        }
                        <button onclick="removeFromTarget('${columnName}')" style="margin-left: auto; background: none; border: none; color: #f44336; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    targetContainer.appendChild(columnItem);
                });
            }
            
            updateStatus();
        }
        
        // ä¼˜åŒ–çš„åˆ—ååŒ¹é…é€»è¾‘
        function checkColumnMatch(actualCol, standardCol) {
            if (!actualCol || !standardCol) return false;
            
            // å»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦è¿›è¡Œæ¯”è¾ƒ
            const cleanActual = actualCol.trim().replace(/\s+/g, ' ').toLowerCase();
            const cleanStandard = standardCol.trim().replace(/\s+/g, ' ').toLowerCase();
            
            // ç›´æ¥åŒ¹é…
            if (cleanActual === cleanStandard) return true;
            
            // æ£€æŸ¥åˆ—åæ˜ å°„
            if (COLUMN_MAPPING[standardCol]) {
                for (const variant of COLUMN_MAPPING[standardCol]) {
                    const cleanVariant = variant.toLowerCase();
                    if (cleanActual === cleanVariant) return true;
                    if (cleanActual.includes(cleanVariant)) return true;
                    if (cleanVariant.includes(cleanActual)) return true;
                }
            }
            
            // å¯¹äºMACDåˆ—çš„ç‰¹æ®Šå¤„ç†
            if (standardCol === "MACD (26,12)") {
                const macdPatterns = [
                    /macd\s*\(\s*26\s*[,ï¼Œ]\s*12\s*\)/i,
                    /macd\s*26\s*[,ï¼Œ]\s*12/i,
                    /^macd$/i,
                    /æŒ‡æ•°å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿/i,
                    /macd\s*\(\s*26\s*,\s*12\s*\)/i,
                    /macd\s*\(26,12\)/i
                ];
                return macdPatterns.some(pattern => pattern.test(actualCol));
            }
            
            // å¤„ç†ä¸­æ–‡åˆ—å
            const chineseMapping = {
                "Code": ["ä»£ç ", "ä»£å·", "è‚¡å·"],
                "Stock": ["è‚¡ç¥¨", "åç§°"],
                "Sector": ["è¡Œä¸š"],
                "Open": ["å¼€ç›˜ä»·", "å¼€ç›˜"],
                "Last": ["æœ€æ–°ä»·", "æ”¶ç›˜ä»·"],
                "Prv Close": ["å‰æ”¶ç›˜", "æ˜¨æ”¶", "å‰æ”¶"],
                "Chg": ["æ¶¨è·Œ", "æ¶¨è·Œå¹…", "å˜åŒ–"],
                "High": ["æœ€é«˜ä»·", "æœ€é«˜"],
                "Low": ["æœ€ä½ä»·", "æœ€ä½"],
                "Y-High": ["å¹´æœ€é«˜", "52å‘¨æœ€é«˜"],
                "Y-Low": ["å¹´æœ€ä½", "52å‘¨æœ€ä½"],
                "Vol": ["æˆäº¤é‡", "äº¤æ˜“é‡"],
                "DY*": ["è‚¡æ¯ç‡", "è‚¡æ¯æ”¶ç›Šç‡"],
                "B%": ["è´å¡”ç³»æ•°", "Beta"],
                "Vol MA (20)": ["æˆäº¤é‡å‡çº¿20", "20æ—¥æˆäº¤é‡å‡çº¿", "æˆäº¤é‡å‡çº¿"],
                "RSI (14)": ["RSI", "ç›¸å¯¹å¼ºå¼±æŒ‡æ•°"],
                "MACD (26,12)": ["MACD", "æŒ‡æ•°å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿"],
                "EPS*": ["æ¯è‚¡æ”¶ç›Š", "EPS"],
                "P/E": ["å¸‚ç›ˆç‡", "PE"],
                "Status": ["çŠ¶æ€", "äº¤æ˜“çŠ¶æ€"]
            };
            
            if (chineseMapping[standardCol]) {
                for (const chinese of chineseMapping[standardCol]) {
                    if (actualCol.includes(chinese) || chinese.includes(actualCol)) {
                        return true;
                    }
                }
            }
            
            // å…³é”®è¯åŒ¹é…
            const keywords = cleanStandard.replace(/[^a-z0-9]/g, ' ');
            const keywordList = keywords.split(' ').filter(k => k.length > 1);
            
            if (keywordList.length > 0) {
                return keywordList.some(keyword => cleanActual.includes(keyword));
            }
            
            return false;
        }
        
        // ä¼˜åŒ–çš„è‡ªåŠ¨æ’åˆ—åˆ—å‡½æ•°
        function autoArrangeColumns() {
            targetColumnOrder = [];
            const matchedColumns = [];
            const usedActualCols = [];
            
            console.log("å¼€å§‹è‡ªåŠ¨æ’åˆ—åˆ—...");
            console.log("åŸå§‹åˆ—:", currentColumns);
            
            // ç¬¬ä¸€æ­¥ï¼šä¸ºæ¯ä¸ªæ ‡å‡†åˆ—å¯»æ‰¾æœ€ä½³åŒ¹é…
            STANDARD_COLUMN_NAMES.forEach(standardCol => {
                let bestMatch = null;
                let bestScore = 0;
                
                currentColumns.forEach(actualCol => {
                    if (usedActualCols.includes(actualCol)) return;
                    
                    // è®¡ç®—åŒ¹é…åˆ†æ•°
                    let score = 0;
                    
                    // ç²¾ç¡®åŒ¹é…ï¼š10åˆ†
                    if (actualCol === standardCol) {
                        score = 10;
                        console.log(`ç²¾ç¡®åŒ¹é…: ${standardCol} -> ${actualCol} (10åˆ†)`);
                    }
                    
                    // æ£€æŸ¥åˆ—åæ˜ å°„ï¼š8åˆ†
                    else if (score === 0 && COLUMN_MAPPING[standardCol]) {
                        for (const variant of COLUMN_MAPPING[standardCol]) {
                            if (actualCol.toLowerCase() === variant.toLowerCase()) {
                                score = 8;
                                console.log(`æ˜ å°„åŒ¹é…: ${standardCol} -> ${actualCol} (8åˆ†)`);
                                break;
                            }
                        }
                    }
                    
                    // åŒ…å«å…³ç³»ï¼š6åˆ†
                    if (score === 0) {
                        const actualLower = actualCol.toLowerCase();
                        const standardLower = standardCol.toLowerCase();
                        
                        // æ£€æŸ¥å®é™…åˆ—åæ˜¯å¦åŒ…å«æ ‡å‡†åˆ—åçš„å…³é”®è¯
                        const standardWords = standardLower.split(/[^a-z0-9]+/).filter(w => w.length > 1);
                        const containsKeyword = standardWords.some(word => 
                            actualLower.includes(word)
                        );
                        
                        if (containsKeyword) {
                            score = 6;
                            console.log(`å…³é”®è¯åŒ¹é…: ${standardCol} -> ${actualCol} (6åˆ†)`);
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ä¸­æ–‡å¯¹åº”
                        const chineseMapping = {
                            "Code": ["ä»£ç ", "ä»£å·", "è‚¡å·"],
                            "Stock": ["è‚¡ç¥¨", "åç§°"],
                            "Sector": ["è¡Œä¸š"],
                            "Open": ["å¼€ç›˜ä»·", "å¼€ç›˜"],
                            "Last": ["æœ€æ–°ä»·", "æ”¶ç›˜ä»·"],
                            "Prv Close": ["å‰æ”¶ç›˜", "æ˜¨æ”¶"],
                            "Chg": ["æ¶¨è·Œ", "æ¶¨è·Œå¹…", "Chg%"],
                            "High": ["æœ€é«˜ä»·", "æœ€é«˜"],
                            "Low": ["æœ€ä½ä»·", "æœ€ä½"],
                            "Y-High": ["å¹´æœ€é«˜", "52å‘¨æœ€é«˜"],
                            "Y-Low": ["å¹´æœ€ä½", "52å‘¨æœ€ä½"],
                            "Vol": ["æˆäº¤é‡", "äº¤æ˜“é‡"],
                            "DY*": ["è‚¡æ¯ç‡", "è‚¡æ¯æ”¶ç›Šç‡"],
                            "B%": ["è´å¡”ç³»æ•°", "Beta"],
                            "Vol MA (20)": ["æˆäº¤é‡å‡çº¿20", "20æ—¥æˆäº¤é‡å‡çº¿"],
                            "RSI (14)": ["RSI", "ç›¸å¯¹å¼ºå¼±æŒ‡æ•°"],
                            "MACD (26,12)": ["MACD", "æŒ‡æ•°å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿"],
                            "EPS*": ["æ¯è‚¡æ”¶ç›Š", "EPS"],
                            "P/E": ["å¸‚ç›ˆç‡", "PE"],
                            "Status": ["çŠ¶æ€", "äº¤æ˜“çŠ¶æ€"]
                        };
                        
                        if (chineseMapping[standardCol]) {
                            for (const chinese of chineseMapping[standardCol]) {
                                if (actualCol.includes(chinese)) {
                                    score = 7;
                                    console.log(`ä¸­æ–‡åŒ¹é…: ${standardCol} -> ${actualCol} (7åˆ†)`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // å¦‚æœæ‰¾åˆ°æ›´å¥½çš„åŒ¹é…ï¼Œæ›´æ–°æœ€ä½³åŒ¹é…
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = actualCol;
                    }
                });
                
                // å¦‚æœæ‰¾åˆ°äº†åŒ¹é…ï¼Œæ·»åŠ åˆ°ç›®æ ‡åˆ—
                if (bestMatch && bestScore >= 3) {
                    targetColumnOrder.push(bestMatch);
                    usedActualCols.push(bestMatch);
                    matchedColumns.push({ standard: standardCol, actual: bestMatch, score: bestScore });
                    console.log(`æœ€ç»ˆåŒ¹é…: ${standardCol} -> ${bestMatch} (${bestScore}åˆ†)`);
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…ï¼Œæ·»åŠ æ ‡å‡†åˆ—å
                    targetColumnOrder.push(standardCol);
                    console.log(`æœªæ‰¾åˆ°åŒ¹é…: ${standardCol} -> ${standardCol}`);
                }
            });
            
            // ç¬¬äºŒæ­¥ï¼šæ·»åŠ å‰©ä½™çš„åˆ—
            currentColumns.forEach(col => {
                if (!usedActualCols.includes(col)) {
                    targetColumnOrder.push(col);
                }
            });
            
            console.log("è‡ªåŠ¨æ’åˆ—å®Œæˆï¼Œç»“æœ:", targetColumnOrder);
            
            updateTargetColumnsDisplay();
            updateColumnMatchInfo();
            
            // æ˜¾ç¤ºåŒ¹é…ç»“æœ
            const matchedCount = getMatchedColumnCount();
            const matchPercentage = Math.round((matchedCount / STANDARD_COLUMN_NAMES.length) * 100);
            
            let statusColor = '#1976d2';
            let statusIcon = 'âœ“';
            if (matchPercentage < 70) {
                statusColor = '#FF9800';
                statusIcon = 'âš ';
            }
            if (matchPercentage < 50) {
                statusColor = '#f44336';
                statusIcon = 'âœ—';
            }
            
            document.getElementById('currentStatus').innerHTML = `
                <span style="color: ${statusColor};">
                    ${statusIcon} è‡ªåŠ¨æ’åˆ—å®Œæˆ
                </span><br>
                <span style="font-size: 12px; color: #888;">
                    åŒ¹é…äº† ${matchedCount}/${STANDARD_COLUMN_NAMES.length} ä¸ªæ ‡å‡†åˆ— (${matchPercentage}%)
                </span>
            `;
            
            // å¦‚æœåŒ¹é…ç‡ä½ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (matchPercentage < 70) {
                document.getElementById('columnMatchInfo').innerHTML = `
                    <div style="color: #FF9800; font-weight: bold;">
                        <i class="fas fa-exclamation-triangle"></i> åŒ¹é…ç‡è¾ƒä½ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥åˆ—é¡ºåºæˆ–ä½¿ç”¨"æ‰‹åŠ¨è°ƒæ•´"åŠŸèƒ½
                    </div>
                `;
            }
        }
        
        // è·å–åŒ¹é…çš„åˆ—æ•°
        function getMatchedColumnCount() {
            let count = 0;
            STANDARD_COLUMN_NAMES.forEach((stdCol, index) => {
                if (index < targetColumnOrder.length) {
                    const actualCol = targetColumnOrder[index];
                    if (actualCol && checkColumnMatch(actualCol, stdCol)) {
                        count++;
                    }
                }
            });
            return count;
        }
        
        // æ›´æ–°åˆ—åŒ¹é…ä¿¡æ¯
        function updateColumnMatchInfo() {
            const matchedCount = getMatchedColumnCount();
            const totalRequired = STANDARD_COLUMN_NAMES.length;
            const matchPercentage = Math.round((matchedCount / totalRequired) * 100);
            
            let color = '#4CAF50';
            if (matchPercentage < 70) color = '#FF9800';
            if (matchPercentage < 50) color = '#f44336';
            
            document.getElementById('columnMatchInfo').innerHTML = `
                <div style="color: ${color}; font-weight: bold;">
                    åˆ—åŒ¹é…: ${matchedCount}/${totalRequired} (${matchPercentage}%)
                </div>
            `;
        }
        
        // æ˜¾ç¤ºåˆ—åŒ¹é…çŠ¶æ€
        function showColumnMatchStatus() {
            if (targetColumnOrder.length === 0) {
                alert('è¯·å…ˆè¿è¡Œè‡ªåŠ¨æ’åˆ—ï¼');
                return;
            }
            
            let statusHTML = '<h3>åˆ—åŒ¹é…çŠ¶æ€ï¼š</h3><table style="width:100%; border-collapse:collapse;">';
            statusHTML += '<tr style="background:#f0f0f0;"><th>åºå·</th><th>æ ‡å‡†åˆ—å</th><th>å®é™…åˆ—å</th><th>åŒ¹é…çŠ¶æ€</th><th>å»ºè®®</th></tr>';
            
            STANDARD_COLUMN_NAMES.forEach((stdCol, index) => {
                const actualCol = targetColumnOrder[index] || 'æœªåŒ¹é…';
                const isMatched = actualCol && checkColumnMatch(actualCol, stdCol);
                
                let suggestion = '';
                if (!isMatched && actualCol !== 'æœªåŒ¹é…') {
                    suggestion = `å»ºè®®: å°†"${actualCol}"ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®`;
                } else if (actualCol === 'æœªåŒ¹é…') {
                    suggestion = `å»ºè®®: æŸ¥æ‰¾åŒ…å«"${stdCol}"çš„åˆ—`;
                }
                
                statusHTML += `
                    <tr style="border-bottom:1px solid #ddd;">
                        <td style="padding:5px;">${index + 1}</td>
                        <td style="padding:5px;"><strong>${stdCol}</strong></td>
                        <td style="padding:5px;">${actualCol}</td>
                        <td style="padding:5px; color:${isMatched ? 'green' : 'red'}">
                            ${isMatched ? 'âœ“ åŒ¹é…' : 'âœ— ä¸åŒ¹é…'}
                        </td>
                        <td style="padding:5px; font-size:11px; color:#666;">${suggestion}</td>
                    </tr>
                `;
            });
            
            // æ˜¾ç¤ºé¢å¤–çš„åˆ—
            if (targetColumnOrder.length > STANDARD_COLUMN_NAMES.length) {
                statusHTML += '<tr><td colspan="5" style="padding:10px; background:#f9f9f9;"><strong>é¢å¤–åˆ—ï¼š</strong></td></tr>';
                for (let i = STANDARD_COLUMN_NAMES.length; i < targetColumnOrder.length; i++) {
                    statusHTML += `
                        <tr style="border-bottom:1px solid #ddd;">
                            <td style="padding:5px;">${i + 1}</td>
                            <td style="padding:5px; color:#999;">(é¢å¤–)</td>
                            <td style="padding:5px;">${targetColumnOrder[i]}</td>
                            <td style="padding:5px; color:#666;">é¢å¤–åˆ—</td>
                            <td style="padding:5px; font-size:11px; color:#666;">å°†æ˜¾ç¤ºåœ¨å¿…éœ€åˆ—ä¹‹å</td>
                        </tr>
                    `;
                }
            }
            
            statusHTML += '</table>';
            
            const matchedCount = getMatchedColumnCount();
            const matchPercentage = Math.round((matchedCount / STANDARD_COLUMN_NAMES.length) * 100);
            
            // åœ¨æ–°çª—å£ä¸­æ˜¾ç¤º
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                <head>
                    <title>åˆ—åŒ¹é…çŠ¶æ€</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f2f2f2; }
                        .summary { 
                            background: #f8f9fa; 
                            padding: 15px; 
                            border-radius: 5px; 
                            margin: 20px 0;
                            border-left: 4px solid #1976d2;
                        }
                        .match-good { color: green; font-weight: bold; }
                        .match-warning { color: orange; font-weight: bold; }
                        .match-bad { color: red; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h2>åˆ—é¡ºåºåŒ¹é…çŠ¶æ€</h2>
                    <div class="summary">
                        <h3>åŒ¹é…æ‘˜è¦</h3>
                        <p>æ ‡å‡†åˆ—æ€»æ•°: ${STANDARD_COLUMN_NAMES.length}</p>
                        <p>å·²åŒ¹é…åˆ—æ•°: ${matchedCount}</p>
                        <p>åŒ¹é…ç‡: <span class="${matchPercentage >= 90 ? 'match-good' : matchPercentage >= 70 ? 'match-warning' : 'match-bad'}">${matchPercentage}%</span></p>
                        <p>æ€»å…±åˆ—æ•°: ${targetColumnOrder.length}</p>
                    </div>
                    ${statusHTML}
                </body>
                </html>
            `);
        }
        
        // é‡ç½®åˆ—
        function resetColumns() {
            targetColumnOrder = [];
            updateTargetColumnsDisplay();
            updateColumnMatchInfo();
            
            document.getElementById('currentStatus').innerHTML = `
                <span style="color: #FF9800;">â†º åˆ—æ’åˆ—å·²é‡ç½®</span>
            `;
        }
        
        // åº”ç”¨è¡Œä¸šæ˜ å°„
        function applySectorMapping() {
            if (rawData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ•°æ®ï¼');
                return;
            }
            
            processedData = rawData.map(row => {
                const newRow = {...row};
                
                // æ‰¾åˆ°Sectoråˆ—
                const sectorKey = Object.keys(row).find(key => 
                    key.toLowerCase().includes('sector') || 
                    key.toLowerCase().includes('industry') ||
                    key === 'Sector'
                );
                
                if (sectorKey && row[sectorKey]) {
                    const sectorCode = row[sectorKey].toString().trim();
                    const sectorName = SECTOR_MAP[sectorCode] || 
                                      SECTOR_MAP.default_mapping?.[sectorCode[0]] || 
                                      `Unknown (${sectorCode})`;
                    
                    newRow[sectorKey] = sectorName;
                }
                
                return newRow;
            });
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            updateStepStatus(3, true);
            
            // æ›´æ–°çŠ¶æ€
            document.getElementById('currentStatus').innerHTML = `
                <span style="color: #4CAF50;">âœ“ è¡Œä¸šä»£ç å·²è½¬æ¢</span><br>
                <span style="font-size: 12px; color: #888;">${rawData.length} è¡Œæ•°æ®å·²å¤„ç†</span>
            `;
            
            // é¢„è§ˆæ•°æ®
            previewData();
        }
        
        // é¢„è§ˆæ•°æ®
        function previewData() {
            if (processedData.length === 0) {
                processedData = [...rawData];
            }
            
            const previewTable = document.getElementById('dataPreview');
            previewTable.innerHTML = '';
            
            // åˆ›å»ºè¡¨å¤´ - ä½¿ç”¨æ ‡å‡†åˆ—å
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            STANDARD_COLUMN_NAMES.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            previewTable.appendChild(thead);
            
            // åˆ›å»ºè¡¨æ ¼å†…å®¹ï¼ˆå‰10è¡Œï¼‰
            const tbody = document.createElement('tbody');
            const previewRows = Math.min(10, processedData.length);
            
            for (let i = 0; i < previewRows; i++) {
                const row = processedData[i];
                const tr = document.createElement('tr');
                
                STANDARD_COLUMN_NAMES.forEach(column => {
                    const td = document.createElement('td');
                    // æŸ¥æ‰¾å¯¹åº”çš„å®é™…åˆ—
                    let value = '';
                    for (const [key, val] of Object.entries(row)) {
                        if (checkColumnMatch(key, column)) {
                            value = val;
                            break;
                        }
                    }
                    td.textContent = value || '';
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            }
            
            previewTable.appendChild(tbody);
            
            // æ›´æ–°è¡Œæ•°æ˜¾ç¤º
            document.getElementById('previewRowCount').textContent = previewRows;
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            updateStepStatus(4, true);
        }
        
        // æ˜¾ç¤ºå®Œæ•´æ•°æ®
        function showFullPreview() {
            if (processedData.length === 0) {
                alert('è¯·å…ˆå¤„ç†æ•°æ®ï¼');
                return;
            }
            
            let fullContent = STANDARD_COLUMN_NAMES.join(',') + '\n';
            
            processedData.forEach(row => {
                const rowContent = STANDARD_COLUMN_NAMES.map(col => {
                    // æŸ¥æ‰¾å¯¹åº”çš„å®é™…åˆ—
                    let value = '';
                    for (const [key, val] of Object.entries(row)) {
                        if (checkColumnMatch(key, col)) {
                            value = val;
                            break;
                        }
                    }
                    return `"${value || ''}"`;
                }).join(',');
                fullContent += rowContent + '\n';
            });
            
            // åœ¨æ–°çª—å£ä¸­æ˜¾ç¤º
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                <head>
                    <title>å®Œæ•´æ•°æ®é¢„è§ˆ</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        pre { background: #f5f5f5; padding: 20px; border-radius: 5px; overflow-x: auto; }
                    </style>
                </head>
                <body>
                    <h2>å®Œæ•´æ•°æ®é¢„è§ˆ (${processedData.length} è¡Œ)</h2>
                    <pre>${fullContent}</pre>
                </body>
                </html>
            `);
        }
        
        // ç”Ÿæˆæœ€ç»ˆæ•°æ® - ä¿®å¤ç‰ˆ
        function generateFinalData() {
            if (processedData.length === 0) {
                applySectorMapping();
            }
            
            console.log("å¼€å§‹ç”Ÿæˆæœ€ç»ˆæ•°æ®...");
            console.log("ç›®æ ‡åˆ—é¡ºåº:", targetColumnOrder);
            console.log("æ ‡å‡†åˆ—é¡ºåº:", STANDARD_COLUMN_NAMES);
            
            // åˆ›å»ºåˆ—æ˜ å°„å…³ç³»
            const columnMapping = {};
            
            // ä¸ºæ¯ä¸ªæ ‡å‡†åˆ—æ‰¾åˆ°å¯¹åº”çš„å®é™…åˆ—
            STANDARD_COLUMN_NAMES.forEach(standardCol => {
                let foundMatch = null;
                
                // åœ¨ç›®æ ‡åˆ—é¡ºåºä¸­æŸ¥æ‰¾åŒ¹é…
                for (let i = 0; i < targetColumnOrder.length; i++) {
                    const actualCol = targetColumnOrder[i];
                    if (actualCol && checkColumnMatch(actualCol, standardCol)) {
                        foundMatch = actualCol;
                        console.log(`æ˜ å°„: ${standardCol} -> ${actualCol}`);
                        break;
                    }
                }
                
                columnMapping[standardCol] = foundMatch;
            });
            
            console.log("åˆ—æ˜ å°„å…³ç³»:", columnMapping);
            
            // ç”Ÿæˆæœ€ç»ˆæ•°æ®
            finalData = processedData.map((row, rowIndex) => {
                const newRow = {};
                
                // ä¸ºæ¯ä¸ªæ ‡å‡†åˆ—èµ‹å€¼
                STANDARD_COLUMN_NAMES.forEach(standardCol => {
                    const actualCol = columnMapping[standardCol];
                    
                    if (actualCol && row[actualCol] !== undefined && row[actualCol] !== '') {
                        newRow[standardCol] = row[actualCol];
                    } else {
                        newRow[standardCol] = '';
                    }
                });
                
                return newRow;
            });
            
            console.log("æœ€ç»ˆæ•°æ®ç¤ºä¾‹:", finalData[0]);
            return finalData;
        }
        
        // å¼€å§‹å¤„ç†
        function startProcessing() {
            if (targetColumnOrder.length === 0) {
                alert('è¯·å…ˆæ’åˆ—åˆ—é¡ºåºï¼');
                return;
            }
            
            const progressBar = document.getElementById('processProgress');
            const progressText = document.getElementById('processText');
            const progressPercent = document.getElementById('processPercent');
            const downloadBtn = document.getElementById('downloadBtn');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressPercent.textContent = progress + '%';
                
                if (progress <= 30) {
                    progressText.textContent = 'éªŒè¯åˆ—é¡ºåº...';
                } else if (progress <= 60) {
                    progressText.textContent = 'åº”ç”¨è¡Œä¸šæ˜ å°„...';
                } else if (progress <= 90) {
                    progressText.textContent = 'é‡æ–°æ’åˆ—æ•°æ®...';
                } else {
                    progressText.textContent = 'ç”Ÿæˆæœ€ç»ˆç»“æœ...';
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    progressText.textContent = 'å¤„ç†å®Œæˆï¼';
                    downloadBtn.disabled = false;
                    
                    // ç”Ÿæˆæœ€ç»ˆæ•°æ®
                    generateFinalData();
                    
                    // è°ƒè¯•è¾“å‡º
                    debugDataMapping();
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    updateStepStatus(5, true);
                    
                    document.getElementById('currentStatus').innerHTML = `
                        <span style="color: #4CAF50;">âœ“ æ•°æ®å¤„ç†å®Œæˆ</span><br>
                        <span style="font-size: 12px; color: #888;">${processedData.length} è¡Œæ•°æ®å·²å°±ç»ª</span>
                    `;
                }
            }, 200);
        }
        
        // ä¸‹è½½ç»“æœ - ä¿®å¤ç‰ˆ
        function downloadResult() {
            if (!finalData || finalData.length === 0) {
                generateFinalData();
            }
            
            if (finalData.length === 0) {
                alert('è¯·å…ˆå¤„ç†æ•°æ®ï¼');
                return;
            }
            
            // ä½¿ç”¨æ ‡å‡†åˆ—é¡ºåº
            const exportColumns = STANDARD_COLUMN_NAMES;
            
            console.log("å¯¼å‡ºåˆ—é¡ºåº:", exportColumns);
            console.log("ç¬¬ä¸€è¡Œæ•°æ®:", finalData[0]);
            
            // è½¬æ¢ä¸ºCSV
            let csvContent = exportColumns.join(',') + '\n';
            
            finalData.forEach((row, rowIndex) => {
                const rowContent = exportColumns.map(col => {
                    let value = row[col] || '';
                    
                    // ç¡®ä¿å€¼æ˜¯å­—ç¬¦ä¸²
                    if (value !== null && value !== undefined) {
                        value = value.toString();
                    } else {
                        value = '';
                    }
                    
                    // å¤„ç†åŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦çš„å€¼
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
                
                csvContent += rowContent + '\n';
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `EOD_Processed_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ˜¾ç¤ºä¸‹è½½æˆåŠŸæ¶ˆæ¯
            const matchedCount = getMatchedColumnCount();
            alert(`ä¸‹è½½æˆåŠŸï¼\n\næ–‡ä»¶: EOD_Processed_${new Date().toISOString().slice(0,10)}.csv\nè¡Œæ•°: ${finalData.length}\nåˆ—æ•°: ${exportColumns.length}\næ ‡å‡†åˆ—åŒ¹é…: ${matchedCount}/${STANDARD_COLUMN_NAMES.length}`);
        }
        
        // å¯¼å‡ºJSON
        function exportToJSON() {
            if (!finalData || finalData.length === 0) {
                generateFinalData();
            }
            
            if (finalData.length === 0) {
                alert('è¯·å…ˆå¤„ç†æ•°æ®ï¼');
                return;
            }
            
            const jsonData = JSON.stringify(finalData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EOD_Processed_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`JSONå¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶: EOD_Processed_${new Date().toISOString().slice(0,10)}.json\nè¡Œæ•°: ${finalData.length}`);
        }
        
        // æŸ¥çœ‹è¡Œä¸šç»Ÿè®¡
        function viewSectorStats() {
            if (processedData.length === 0) {
                alert('è¯·å…ˆå¤„ç†æ•°æ®ï¼');
                return;
            }
            
            const sectorCounts = {};
            processedData.forEach(row => {
                // æŸ¥æ‰¾Sectoråˆ—
                let sector = '';
                for (const [key, value] of Object.entries(row)) {
                    if (key.toLowerCase().includes('sector') || key === 'Sector') {
                        sector = value;
                        break;
                    }
                }
                
                if (sector) {
                    sectorCounts[sector] = (sectorCounts[sector] || 0) + 1;
                }
            });
            
            let statsHTML = '<h3>è¡Œä¸šåˆ†å¸ƒç»Ÿè®¡ï¼š</h3>';
            statsHTML += `<p>æ€»è®¡: ${processedData.length} è¡Œæ•°æ®</p>`;
            statsHTML += '<table style="width:100%;border-collapse:collapse;margin-top:15px;">';
            statsHTML += '<tr style="background:#f0f0f0;"><th>è¡Œä¸š</th><th>è‚¡ç¥¨æ•°é‡</th><th>å æ¯”</th></tr>';
            
            Object.entries(sectorCounts).forEach(([sector, count]) => {
                const percentage = ((count / processedData.length) * 100).toFixed(2);
                statsHTML += `
                    <tr style="border-bottom:1px solid #ddd;">
                        <td style="padding:8px;">${sector}</td>
                        <td style="padding:8px;text-align:center;">${count}</td>
                        <td style="padding:8px;text-align:center;">${percentage}%</td>
                    </tr>
                `;
            });
            
            statsHTML += '</table>';
            
            // æ˜¾ç¤ºåœ¨æ¨¡æ€æ¡†ä¸­
            document.getElementById('statsContent').innerHTML = statsHTML;
            document.getElementById('statsModal').style.display = 'block';
        }
        
        // è°ƒè¯•å‡½æ•°ï¼Œæ£€æŸ¥æ•°æ®è½¬æ¢è¿‡ç¨‹
        function debugDataMapping() {
            if (rawData.length === 0) {
                console.log("æ²¡æœ‰åŸå§‹æ•°æ®");
                return;
            }
            
            console.log("=== æ•°æ®æ˜ å°„è°ƒè¯• ===");
            console.log("åŸå§‹åˆ—é¡ºåº:", currentColumns);
            console.log("ç›®æ ‡åˆ—é¡ºåº:", targetColumnOrder);
            console.log("æ ‡å‡†åˆ—å:", STANDARD_COLUMN_NAMES);
            
            // æ£€æŸ¥ç¬¬ä¸€è¡Œæ•°æ®çš„åˆ—å
            const firstRow = rawData[0];
            console.log("åŸå§‹æ•°æ®ç¬¬ä¸€è¡Œ:", firstRow);
            
            // æ£€æŸ¥æ¯ä¸ªåˆ—æ˜¯å¦åŒ¹é…
            STANDARD_COLUMN_NAMES.forEach((stdCol, index) => {
                const targetCol = targetColumnOrder[index];
                const isMatched = targetCol ? checkColumnMatch(targetCol, stdCol) : false;
                const actualValue = firstRow ? firstRow[targetCol] : 'N/A';
                console.log(`${index + 1}. ${stdCol} -> ${targetCol || 'æœªåŒ¹é…'} ${isMatched ? 'âœ“' : 'âœ—'} å€¼: ${actualValue}`);
            });
            
            // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
            let debugHTML = '<h3>è°ƒè¯•ä¿¡æ¯ï¼š</h3>';
            debugHTML += '<p><strong>åŸå§‹åˆ—é¡ºåº:</strong> ' + currentColumns.join(', ') + '</p>';
            debugHTML += '<p><strong>ç›®æ ‡åˆ—é¡ºåº:</strong> ' + targetColumnOrder.join(', ') + '</p>';
            
            debugHTML += '<table style="width:100%;border-collapse:collapse;margin-top:15px;">';
            debugHTML += '<tr style="background:#f0f0f0;"><th>æ ‡å‡†åˆ—</th><th>æ˜ å°„åˆ—</th><th>åŒ¹é…çŠ¶æ€</th><th>ç¤ºä¾‹å€¼</th></tr>';
            
            STANDARD_COLUMN_NAMES.forEach((stdCol, index) => {
                const targetCol = targetColumnOrder[index];
                const isMatched = targetCol ? checkColumnMatch(targetCol, stdCol) : false;
                const actualValue = rawData[0] ? rawData[0][targetCol] || '' : '';
                
                debugHTML += `
                    <tr style="border-bottom:1px solid #ddd;">
                        <td style="padding:5px;"><strong>${stdCol}</strong></td>
                        <td style="padding:5px;">${targetCol || 'æœªåŒ¹é…'}</td>
                        <td style="padding:5px; color:${isMatched ? 'green' : 'red'}">
                            ${isMatched ? 'âœ“ åŒ¹é…' : 'âœ— ä¸åŒ¹é…'}
                        </td>
                        <td style="padding:5px;">${actualValue}</td>
                    </tr>
                `;
            });
            
            debugHTML += '</table>';
            
            const debugWindow = window.open();
            debugWindow.document.write(`
                <html>
                <head>
                    <title>è°ƒè¯•ä¿¡æ¯</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${debugHTML}
                </body>
                </html>
            `);
        }
        
        // æ‰‹åŠ¨è°ƒæ•´åˆ—æ˜ å°„
        function adjustColumnManually() {
            if (currentColumns.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ•°æ®ï¼');
                return;
            }
            
            // åˆ›å»ºä¸€ä¸ªç•Œé¢è®©ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´åˆ—é¡ºåº
            let manualHtml = `
                <div style="padding: 20px; max-width: 800px;">
                    <h3>æ‰‹åŠ¨è°ƒæ•´åˆ—æ˜ å°„</h3>
                    <p>è¯·ä¸ºæ¯ä¸ªæ ‡å‡†åˆ—é€‰æ‹©å¯¹åº”çš„å®é™…åˆ—ï¼š</p>
                    <div id="manualMapping" style="margin: 20px 0;">
            `;
            
            STANDARD_COLUMN_NAMES.forEach((stdCol, index) => {
                // æŸ¥æ‰¾å½“å‰åŒ¹é…çš„åˆ—
                let currentMatch = '';
                if (index < targetColumnOrder.length) {
                    currentMatch = targetColumnOrder[index];
                }
                
                manualHtml += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                        <strong>${index + 1}. ${stdCol}:</strong>
                        <select id="map-${stdCol}" style="margin-left: 10px; padding: 5px; min-width: 250px;">
                            <option value="">-- é€‰æ‹©å¯¹åº”åˆ— --</option>
                `;
                
                currentColumns.forEach(actualCol => {
                    const isSelected = currentMatch === actualCol;
                    manualHtml += `<option value="${actualCol}" ${isSelected ? 'selected' : ''}>${actualCol}</option>`;
                });
                
                manualHtml += `
                        </select>
                    </div>
                `;
            });
            
            manualHtml += `
                    </div>
                    <div style="margin-top: 20px;">
                        <button id="applyManualBtn" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            åº”ç”¨æ‰‹åŠ¨æ˜ å°„
                        </button>
                        <button id="cancelManualBtn" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            const manualWindow = window.open();
            manualWindow.document.write(`
                <html>
                <head>
                    <title>æ‰‹åŠ¨è°ƒæ•´åˆ—æ˜ å°„</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        select { min-width: 200px; }
                        button { cursor: pointer; }
                    </style>
                </head>
                <body>${manualHtml}</body>
                </html>
            `);
            
            // æ·»åŠ äº‹ä»¶å¤„ç†
            manualWindow.document.getElementById('applyManualBtn').onclick = function() {
                const newTargetOrder = [];
                STANDARD_COLUMN_NAMES.forEach(stdCol => {
                    const select = manualWindow.document.getElementById(`map-${stdCol}`);
                    const selectedCol = select.value;
                    if (selectedCol) {
                        newTargetOrder.push(selectedCol);
                    }
                });
                
                // æ·»åŠ å‰©ä½™çš„åˆ—
                currentColumns.forEach(col => {
                    if (!newTargetOrder.includes(col)) {
                        newTargetOrder.push(col);
                    }
                });
                
                targetColumnOrder = newTargetOrder;
                updateTargetColumnsDisplay();
                updateColumnMatchInfo();
                
                manualWindow.close();
                alert('æ‰‹åŠ¨æ˜ å°„å·²åº”ç”¨ï¼');
            };
            
            manualWindow.document.getElementById('cancelManualBtn').onclick = function() {
                manualWindow.close();
            };
        }
        
        // æ˜¾ç¤ºå®Œæ•´è¡Œä¸šæ˜ å°„
        function showFullSectorMapping() {
            const content = document.getElementById('fullSectorMapping');
            
            let html = '<h3>å®Œæ•´è¡Œä¸šä»£ç æ˜ å°„ï¼š</h3>';
            html += '<table style="width:100%;border-collapse:collapse;margin-top:15px;">';
            html += '<tr style="background:#f0f0f0;"><th>ä»£ç </th><th>è¡Œä¸šåç§°</th></tr>';
            
            // æŒ‰ç…§ä»£ç æ’åº
            const sortedCodes = Object.keys(SECTOR_MAP).sort((a, b) => {
                if (a === 'default_mapping') return 1;
                if (b === 'default_mapping') return -1;
                return a.localeCompare(b, undefined, {numeric: true});
            });
            
            sortedCodes.forEach(code => {
                if (code !== 'default_mapping') {
                    html += `
                        <tr style="border-bottom:1px solid #ddd;">
                            <td style="padding:8px;"><strong>${code}</strong></td>
                            <td style="padding:8px;">${SECTOR_MAP[code]}</td>
                        </tr>
                    `;
                }
            });
            
            html += '</table>';
            
            // æ·»åŠ é»˜è®¤æ˜ å°„
            html += '<h3 style="margin-top:20px;">é»˜è®¤æ˜ å°„ï¼š</h3>';
            html += '<table style="width:100%;border-collapse:collapse;">';
            html += '<tr style="background:#f0f0f0;"><th>ä»£ç å¼€å¤´</th><th>è¡Œä¸šåç§°</th></tr>';
            
            Object.entries(SECTOR_MAP.default_mapping).forEach(([code, name]) => {
                html += `
                    <tr style="border-bottom:1px solid #ddd;">
                        <td style="padding:8px;"><strong>${code}</strong></td>
                        <td style="padding:8px;">${name}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            
            content.innerHTML = html;
            document.getElementById('sectorModal').style.display = 'block';
        }
        
        // å…³é—­è¡Œä¸šæ¨¡æ€æ¡†
        function closeSectorModal() {
            document.getElementById('sectorModal').style.display = 'none';
        }
        
        // å…³é—­ç»Ÿè®¡æ¨¡æ€æ¡†
        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }
        
        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            // åˆ›å»ºä¸æ‚¨æä¾›çš„ç¤ºä¾‹æ•°æ®æ ¼å¼ç›¸åŒçš„ç¤ºä¾‹æ•°æ®
            const sampleCSV = `Code,Stock,Status,P/E,EPS*,MACD (26, 12),RSI (14),Vol MA (20),B%,DY*,Vol,Y-Low,Y-High,High,Low,Chg%,Prv Close,Last,Open,Sector
5681,PETDAG,Active,17.54,109.4,-0.65,42%,844450,64,5.43%,11776,16.1,23.8,19.72,19.38,1.65%,19.4,19.72,19.38,101
4065,PPB,Active,12.14,85.72,-0.282,33%,1209920,59,3.96%,12030,8.23,12.58,10.7,10.28,2.91%,10.3,10.6,10.3,101
2445,KLK,Active,22.93,73.9,-0.263,43%,1532915,47,3.00%,19034,18.34,21.86,20.18,19.7,1.52%,19.7,20,19.7,125`;
            
            // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ 
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.innerHTML = `
                <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½ç¤ºä¾‹æ•°æ®...
                </div>
            `;
            
            setTimeout(() => {
                try {
                    const lines = sampleCSV.split('\n');
                    const headers = parseCSVLine(lines[0]);
                    const data = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = parseCSVLine(lines[i]);
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header.trim()] = values[index] ? values[index].trim() : '';
                            });
                            data.push(row);
                        }
                    }
                    
                    rawData = data;
                    currentColumns = headers.map(h => h.trim());
                    
                    uploadStatus.innerHTML = `
                        <div style="background: #E8F5E9; padding: 10px; border-radius: 5px; color: #4CAF50;">
                            <i class="fas fa-check-circle"></i> ç¤ºä¾‹æ•°æ®åŠ è½½æˆåŠŸï¼
                            <div style="font-size: 12px; margin-top: 5px;">
                                åŠ è½½äº† ${data.length} è¡Œç¤ºä¾‹æ•°æ®
                            </div>
                        </div>
                    `;
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    updateStepStatus(1, true);
                    
                    // æ›´æ–°çŠ¶æ€
                    document.getElementById('currentStatus').innerHTML = `
                        <span style="color: #4CAF50;">âœ“ ç¤ºä¾‹æ•°æ®å·²åŠ è½½</span><br>
                        <span style="font-size: 12px; color: #888;">${data.length} è¡Œç¤ºä¾‹æ•°æ®</span>
                    `;
                    
                    document.getElementById('fileInfo').innerHTML = `
                        æ–‡ä»¶å: ç¤ºä¾‹æ•°æ®.csv<br>
                        å¤§å°: 1.2 KB<br>
                        åˆ—æ•°: ${headers.length}
                    `;
                    
                    // æ˜¾ç¤ºåˆ—ç®¡ç†åŒºåŸŸ
                    document.getElementById('columnSection').style.display = 'block';
                    document.getElementById('sectorSection').style.display = 'block';
                    document.getElementById('previewSection').style.display = 'block';
                    document.getElementById('processSection').style.display = 'block';
                    
                    // åˆå§‹åŒ–åˆ—åˆ—è¡¨
                    initializeColumnList();
                    
                    // å°è¯•è‡ªåŠ¨æ’åˆ—åˆ—
                    setTimeout(() => {
                        autoArrangeColumns();
                        updateStepStatus(2, true);
                    }, 500);
                    
                } catch (error) {
                    uploadStatus.innerHTML = `
                        <div style="background: #FFEBEE; padding: 10px; border-radius: 5px; color: #f44336;">
                            <i class="fas fa-exclamation-triangle"></i> ç¤ºä¾‹æ•°æ®åŠ è½½å¤±è´¥
                        </div>
                    `;
                }
            }, 1000);
        }
        
        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                rawData = [];
                processedData = [];
                currentColumns = [];
                targetColumnOrder = [];
                finalData = [];
                
                // é‡ç½®UI
                document.getElementById('columnSection').style.display = 'none';
                document.getElementById('sectorSection').style.display = 'none';
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('processSection').style.display = 'none';
                
                document.getElementById('availableColumns').innerHTML = '';
                document.getElementById('targetColumns').innerHTML = `
                    <div class="target-placeholder">
                        <i class="fas fa-arrow-down" style="font-size: 32px; color: #ccc; margin-bottom: 10px;"></i>
                        <div>å°†åˆ—æ‹–æ”¾åˆ°è¿™é‡Œ</div>
                    </div>
                `;
                
                document.getElementById('dataPreview').innerHTML = '';
                document.getElementById('previewRowCount').textContent = '0';
                document.getElementById('processProgress').style.width = '0%';
                document.getElementById('processText').textContent = 'ç­‰å¾…å¼€å§‹...';
                document.getElementById('processPercent').textContent = '0%';
                document.getElementById('downloadBtn').disabled = true;
                
                document.getElementById('currentStatus').innerHTML = 'ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...';
                document.getElementById('fileInfo').innerHTML = '';
                document.getElementById('columnMatchInfo').innerHTML = '';
                document.getElementById('uploadStatus').innerHTML = '';
                
                // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`step${i}`).style.background = i === 1 ? '#1976d2' : '#e0e0e0';
                    document.getElementById(`step${i}`).style.color = i === 1 ? 'white' : '#666';
                }
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                document.getElementById('csvInput').value = '';
            }
        }
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStepStatus(step, completed) {
            const stepElement = document.getElementById(`step${step}`);
            if (completed) {
                stepElement.style.background = '#4CAF50';
                stepElement.style.color = 'white';
                stepElement.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                stepElement.style.background = '#1976d2';
                stepElement.style.color = 'white';
                stepElement.textContent = step;
            }
            
            // æ¿€æ´»ä¸‹ä¸€æ­¥
            if (step < 5 && completed) {
                const nextStep = document.getElementById(`step${step + 1}`);
                nextStep.style.background = '#1976d2';
                nextStep.style.color = 'white';
            }
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus() {
            if (targetColumnOrder.length > 0) {
                const matchedCount = getMatchedColumnCount();
                const matchPercentage = Math.round((matchedCount / STANDARD_COLUMN_NAMES.length) * 100);
                
                let color = '#4CAF50';
                if (matchPercentage < 70) color = '#FF9800';
                if (matchPercentage < 50) color = '#f44336';
                
                document.getElementById('currentStatus').innerHTML = `
                    <span style="color: ${color};">
                        ${matchPercentage >= 70 ? 'âœ“' : matchPercentage >= 50 ? 'âš ' : 'âœ—'} åˆ—æ’åˆ—å®Œæˆ
                    </span><br>
                    <span style="font-size: 12px; color: #888;">
                        åŒ¹é…äº† ${matchedCount}/${STANDARD_COLUMN_NAMES.length} ä¸ªæ ‡å‡†åˆ—
                    </span>
                `;
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const sectorModal = document.getElementById('sectorModal');
            const statsModal = document.getElementById('statsModal');
            
            if (event.target == sectorModal) {
                closeSectorModal();
            }
            if (event.target == statsModal) {
                closeStatsModal();
            }
        };
    </script>
</body>
</html>