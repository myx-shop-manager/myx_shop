#!/usr/bin/env python3
"""
ğŸš€ Bursa Malaysia AIé¸è‚¡ç¥å™¨ - HTMLå…¼å®¹ç‰ˆ
ç¢ºä¿ç”Ÿæˆçš„JSONæ–‡ä»¶èˆ‡eskay-inv.htmlå®Œå…¨å…¼å®¹
"""

import pandas as pd
import numpy as np
import json
import os
import sys
import re
from datetime import datetime, timedelta
import shutil
import math
import warnings
warnings.filterwarnings('ignore')

# ========== å…¨å±€é…ç½® ==========
CONFIG = {
    'output_dirs': {
        'web_root': '../web',                    # webç›®éŒ„ (eskay-inv.htmlæ‰€åœ¨)
        'web_history': '../web/history',         # æ­·å²æ•¸æ“š
        'scripts_backup': 'data/bursa/picks'     # è…³æœ¬å‚™ä»½ (HTMLæŸ¥æ‰¾çš„ä½ç½®)
    },
    'retention_days': 30,                         # ä¿ç•™30å¤©æ­·å²
    'max_picks': 20,                              # æœ€å¤šæ¨è–¦20éš»è‚¡ç¥¨
    'max_price_stocks': 200                       # æœ€å¤š200éš»è‚¡ç¥¨åƒ¹æ ¼
}

# ========== è¡Œæ¥­ä»£ç¢¼æ˜ å°„ ==========
SECTOR_MAPPING = {
    "101": "Industrial & Consumer Products",
    "102": "Industrial & Consumer Products",
    "103": "Industrial & Consumer Products",
    "105": "Industrial & Consumer Products",
    "110": "Industrial & Consumer Products",
    "120": "Industrial & Consumer Products",
    "125": "Industrial & Consumer Products",
    "150": "Industrial & Consumer Products",
    "155": "Industrial & Consumer Products",
    "161": "Industrial & Consumer Products",
    "162": "Industrial & Consumer Products",
    "163": "Industrial & Consumer Products",
    "164": "Industrial & Consumer Products",
    "165": "Industrial & Consumer Products",
    "166": "Industrial & Consumer Products",
    "301": "Technology",
    "302": "Technology",
    "303": "Technology",
    "305": "Technology",
    "310": "Technology",
    "320": "Technology",
    "325": "Technology",
    "358": "Technology",
    "361": "Technology",
    "362": "Technology",
    "363": "Technology",
    "364": "Technology",
    "365": "Technology",
    "401": "Property",
    "402": "Property",
    "403": "Property",
    "405": "Property",
    "410": "Property",
    "420": "Property",
    "425": "Property",
    "461": "Property",
    "462": "Property",
    "463": "Property",
    "464": "Property",
    "465": "Property",
    "501": "Telecommunications & Media",
    "502": "Telecommunications & Media",
    "520": "Telecommunications & Media",
    "560": "Telecommunications & Media",
    "653": "Transportation & Logistics",
    "654": "Transportation & Logistics",
    "656": "Transportation & Logistics",
    "657": "Transportation & Logistics",
    "701": "Utilities",
    "702": "Utilities",
    "703": "Utilities",
    "705": "Utilities",
    "710": "Utilities",
    "725": "Utilities",
    "762": "Utilities",
    "0162": "Medical Devices & Supplies",
    "0405": "Software & IT Services",
    "1701": "Industrial Holding Firms",
    "1702": "Industrial & Consumer Products",
    "1703": "Industrial Support Services",
    "1704": "Building Materials",
    "1705": "Construction & Infrastructure",
    "1706": "Transportation & Logistics",
    "1801": "Consumer Product Holding Firms",
    "1802": "Food, Beverage & Tobacco",
    "1803": "Retail & Distribution",
    "1804": "Hotel, Resort & Recreational Services",
    "1805": "Media & Entertainment",
    "1806": "Other Consumer Services",
    "1807": "Health Care Equipment & Services",
    "1808": "Pharmaceuticals & Biotechnology",
    "1809": "Technology",
    "1810": "Telecommunications & Media",
    "0200": "Plantation",
    "0501": "Property Holding Firms",
    "0502": "Property Development",
    "0503": "Real Estate Investment Trusts (REITs)",
    "0504": "Other Property-related Services",
    "1201": "Financial Holding Firms",
    "1202": "Commercial Banks",
    "1203": "Insurance",
    "1204": "Investment Banks",
    "1205": "Other Finance",
    "0301": "Energy Holding Firms",
    "0302": "Energy-related Equipment & Services",
    "0303": "Oil & Gas",
    "0401": "Utilities Holding Firms",
    "0402": "Gas, Water & Multi-utilities",
    "0403": "Electricity",
    "0080": "Special Purpose Acquisition"
}

# ========== JSONè™•ç†å·¥å…· ==========
class SafeJSONEncoder(json.JSONEncoder):
    """å®‰å…¨çš„JSONç·¨ç¢¼å™¨ï¼Œè™•ç†NaNå’ŒInfinity"""
    def encode(self, obj):
        cleaned_obj = self.clean_nan_values(obj)
        return super().encode(cleaned_obj)
    
    def clean_nan_values(self, obj):
        """éæ­¸æ¸…ç†NaNå€¼"""
        if isinstance(obj, dict):
            return {k: self.clean_nan_values(v) for k, v in obj.items()}
        elif isinstance(obj, list):
            return [self.clean_nan_values(v) for v in obj]
        elif isinstance(obj, float):
            if math.isnan(obj) or math.isinf(obj):
                return None
            return obj
        else:
            return obj
    
    def default(self, obj):
        if isinstance(obj, float):
            if math.isnan(obj) or math.isinf(obj):
                return None
        return super().default(obj)

def save_json_safely(filepath, data, indent=2):
    """å®‰å…¨ä¿å­˜JSONæ–‡ä»¶ï¼Œè™•ç†NaNå€¼"""
    try:
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=indent, cls=SafeJSONEncoder)
        print(f"    ğŸ’¾ ä¿å­˜åˆ°: {filepath}")
        return True
    except Exception as e:
        print(f"    âŒ ä¿å­˜JSONæ–‡ä»¶å¤±æ•—: {e}")
        return False

def validate_json_file(filepath):
    """é©—è­‰JSONæ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            json.load(f)
        print(f"    âœ… JSONé©—è­‰æˆåŠŸ: {os.path.basename(filepath)}")
        return True
    except Exception as e:
        print(f"    âŒ JSONé©—è­‰å¤±æ•— {os.path.basename(filepath)}: {e}")
        return False

# ========== å·¥å…·å‡½æ•¸ ==========
def clean_code(code):
    """æ¸…ç†è‚¡ç¥¨ä»£ç¢¼ - HTMLå…¼å®¹ç‰ˆ"""
    if pd.isna(code) or code == '' or code is None:
        return ""
    
    code_str = str(code).strip()
    
    # æ¸…ç†ç‰¹æ®Šæ ¼å¼ï¼Œå¦‚ ="03041"
    code_str = re.sub(r'^=["\']+|["\']+$', '', code_str)
    code_str = code_str.replace('"', '').replace('=', '').replace("'", "")
    
    # æ¸…ç†éæ•¸å­—å­—ç¬¦
    code_str = re.sub(r'[^0-9]', '', code_str)
    
    if code_str.isdigit():
        if len(code_str) < 4:
            code_str = code_str.zfill(4)
    
    return code_str

def map_sector_code(sector_code):
    """å°‡è¡Œæ¥­ä»£ç¢¼æ˜ å°„ç‚ºè¡Œæ¥­åç¨±"""
    if pd.isna(sector_code) or sector_code == '' or sector_code is None:
        return "Unknown"
    
    sector_str = str(sector_code).strip()
    
    # æ¸…ç†ç‰¹æ®Šæ ¼å¼
    sector_str = re.sub(r'^=["\']+|["\']+$', '', sector_str)
    sector_str = sector_str.replace('"', '').replace('=', '').replace("'", "")
    
    # è½‰æ›ç‚ºå­—ç¬¦ä¸²ä¸¦æ¸…ç†
    if isinstance(sector_str, float):
        sector_str = str(int(sector_str))
    elif isinstance(sector_str, int):
        sector_str = str(sector_str)
    
    # ç¢ºä¿æ˜¯4ä½æ•¸æ ¼å¼
    if sector_str.isdigit():
        if len(sector_str) < 4:
            sector_str = sector_str.zfill(4)
    
    # æŸ¥æ‰¾æ˜ å°„
    if sector_str in SECTOR_MAPPING:
        return SECTOR_MAPPING[sector_str]
    else:
        # å˜—è©¦åŒ¹é…å‰3ä½
        if len(sector_str) >= 3:
            prefix = sector_str[:3]
            if prefix in SECTOR_MAPPING:
                return SECTOR_MAPPING[prefix]
    
    return "Unknown"

def get_instrument_type(name):
    """åˆ¤æ–·å·¥å…·é¡å‹"""
    if pd.isna(name) or name == '' or name is None:
        return "Stock"
    
    name_upper = str(name).upper()
    
    warrant_patterns = ['-C', '-P', '-W', '-R', 'CALL', 'PUT', 'WA', 'WB', 'WC', 'WD', 'WE']
    if any(pattern in name_upper for pattern in warrant_patterns):
        return "Warrant"
    
    if 'ETF' in name_upper:
        return "ETF"
    
    reit_patterns = ['REIT', '-REIT', 'REIT-']
    if any(pattern in name_upper for pattern in reit_patterns):
        return "REIT"
    
    return "Stock"

def safe_float(value, default=0.0):
    """å®‰å…¨è½‰æ›ç‚ºæµ®é»æ•¸"""
    try:
        if pd.isna(value) or value is None:
            return default
        if isinstance(value, str):
            value = value.strip()
            if value == '' or value.lower() in ['nan', 'null', 'none', '-', '--', '..', '...']:
                return default
        return float(value)
    except:
        return default

def safe_int(value, default=0):
    """å®‰å…¨è½‰æ›ç‚ºæ•´æ•¸"""
    try:
        if pd.isna(value) or value is None:
            return default
        if isinstance(value, str):
            value = value.strip()
            if value == '' or value.lower() in ['nan', 'null', 'none', '-', '--', '..', '...']:
                return default
        return int(float(value))
    except:
        return default

def safe_str(value, default=""):
    """å®‰å…¨è½‰æ›ç‚ºå­—ç¬¦ä¸²"""
    try:
        if pd.isna(value) or value is None:
            return default
        result = str(value).strip()
        result = re.sub(r'^=["\']+|["\']+$', '', result)
        return result
    except:
        return default

def normalize_dataframe(df):
    """æ¨™æº–åŒ–æ•¸æ“šæ¡† - ç²¾ç°¡ç‰ˆ"""
    print("  ğŸ”§ æ¨™æº–åŒ–æ•¸æ“š...")
    
    if df.empty:
        print("  âš ï¸ æ•¸æ“šæ¡†ç‚ºç©º")
        return pd.DataFrame()
    
    # å‰µå»ºå‰¯æœ¬
    df = df.copy()
    
    # é¡¯ç¤ºåŸå§‹åˆ—
    print(f"  åŸå§‹åˆ— ({len(df.columns)}): {list(df.columns)}")
    
    # å®šç¾©åˆ—æ˜ å°„
    column_mapping = {}
    for col in df.columns:
        col_lower = str(col).lower().strip()
        
        if 'code' in col_lower:
            column_mapping[col] = 'Code'
        elif 'stock' in col_lower and 'code' not in col_lower:
            column_mapping[col] = 'Stock'
        elif 'sector' in col_lower:
            column_mapping[col] = 'Sector'
        elif 'open' in col_lower:
            column_mapping[col] = 'Open'
        elif 'last' in col_lower:
            column_mapping[col] = 'Last'
        elif 'prv' in col_lower and 'close' in col_lower:
            column_mapping[col] = 'Prv_Close'
        elif 'chg%' in col_lower or 'change%' in col_lower:
            column_mapping[col] = 'Chg%'
        elif 'chg' in col_lower and 'chg%' not in col_lower:
            column_mapping[col] = 'Chg'
        elif 'high' in col_lower and 'y-' not in col_lower:
            column_mapping[col] = 'High'
        elif 'low' in col_lower and 'y-' not in col_lower:
            column_mapping[col] = 'Low'
        elif 'y-high' in col_lower:
            column_mapping[col] = 'Y_High'
        elif 'y-low' in col_lower:
            column_mapping[col] = 'Y_Low'
        elif 'vol' in col_lower and 'ma' not in col_lower:
            column_mapping[col] = 'Volume'
        elif 'dy' in col_lower or 'dividend' in col_lower:
            column_mapping[col] = 'Dividend'
        elif 'b%' in col_lower:
            column_mapping[col] = 'B_Percent'
        elif 'vol ma' in col_lower or 'volume ma' in col_lower:
            column_mapping[col] = 'Vol_MA'
        elif 'rsi' in col_lower:
            column_mapping[col] = 'RSI'
        elif 'macd' in col_lower:
            column_mapping[col] = 'MACD'
        elif 'eps' in col_lower:
            column_mapping[col] = 'EPS'
        elif 'p/e' in col_lower or 'pe' in col_lower:
            column_mapping[col] = 'PE'
        elif 'status' in col_lower:
            column_mapping[col] = 'Status'
    
    if column_mapping:
        df = df.rename(columns=column_mapping)
        print(f"  âœ… é‡å‘½å {len(column_mapping)} å€‹åˆ—")
    
    # æ¸…ç†å¿…éœ€åˆ—
    required_cols = ['Code', 'Stock', 'Sector', 'Last', 'Chg%', 'Volume']
    for col in required_cols:
        if col not in df.columns:
            df[col] = np.nan
            print(f"  âš ï¸ æ·»åŠ ç¼ºå¤±åˆ—: {col}")
    
    # æ¸…ç†æ•¸æ“š
    df['Code'] = df['Code'].apply(clean_code)
    df['Sector_Name'] = df['Sector'].apply(map_sector_code)
    df['Instrument_Type'] = df['Stock'].apply(get_instrument_type)
    
    # æ•¸å€¼è½‰æ›
    numeric_cols = ['Open', 'Last', 'Prv_Close', 'Chg', 'High', 'Low', 
                   'Y_High', 'Y_Low', 'Volume', 'Dividend', 'B_Percent',
                   'Vol_MA', 'RSI', 'MACD', 'EPS', 'PE']
    
    for col in numeric_cols:
        if col in df.columns:
            try:
                # è½‰æ›ç‚ºå­—ç¬¦ä¸²ä¸¦æ¸…ç†
                df[col] = df[col].astype(str)
                df[col] = df[col].str.replace(',', '').str.replace('%', '')
                
                # è½‰æ›ç„¡æ•ˆå€¼
                invalid_vals = ['nan', 'NaN', 'NAN', 'null', 'NULL', 'None', 'NONE', '', ' ', '-', '--']
                df[col] = df[col].replace(invalid_vals, np.nan)
                
                # è½‰æ›ç‚ºæ•¸å€¼
                df[col] = pd.to_numeric(df[col], errors='coerce')
                
                # å¡«å……NaN
                if col in ['Open', 'Last', 'Prv_Close', 'Chg', 'High', 'Low', 'Y_High', 'Y_Low']:
                    df[col] = df[col].fillna(0.0)
                elif col == 'Volume':
                    df[col] = df[col].fillna(0)
                elif col == 'RSI':
                    df[col] = df[col].fillna(50.0)
                elif col == 'MACD':
                    df[col] = df[col].fillna(0.0)
                elif col in ['Dividend', 'B_Percent', 'EPS', 'PE']:
                    df[col] = df[col].fillna(0.0)
                    
            except Exception as e:
                print(f"  âš ï¸ è½‰æ› {col} å‡ºéŒ¯: {e}")
                df[col] = 0.0
    
    # éæ¿¾ç„¡æ•ˆè‚¡ç¥¨
    df = df[df['Code'].str.len() >= 2]
    
    print(f"  âœ… æ¨™æº–åŒ–å®Œæˆ: {len(df)} è¡Œ")
    return df

def calculate_stock_score(row, is_warrant=False):
    """è¨ˆç®—è‚¡ç¥¨è©•åˆ†"""
    try:
        base_score = 50.0
        
        # RSIè©•åˆ†
        rsi = safe_float(row.get('RSI', 50.0), 50.0)
        if 0 <= rsi <= 100:
            if rsi < 30:
                base_score += 15
            elif rsi < 45:
                base_score += 10
            elif rsi > 70:
                base_score -= 10
            elif rsi > 60:
                base_score -= 5
        
        # åƒ¹æ ¼è®ŠåŒ–
        chg_pct = safe_float(row.get('Chg%', 0.0), 0.0)
        if chg_pct > 20:
            base_score += 15
        elif chg_pct > 10:
            base_score += 10
        elif chg_pct > 5:
            base_score += 5
        elif chg_pct < -20:
            base_score -= 15
        elif chg_pct < -10:
            base_score -= 10
        elif chg_pct < -5:
            base_score -= 5
        
        # MACDè©•åˆ†
        macd = safe_float(row.get('MACD', 0.0), 0.0)
        if macd > 0:
            base_score += 8
        elif macd < 0:
            base_score -= 3
        
        # æˆäº¤é‡
        vol = safe_float(row.get('Volume', 0.0), 0.0)
        vol_ma = safe_float(row.get('Vol_MA', 1.0), 1.0)
        if vol_ma > 0:
            vol_ratio = vol / vol_ma
            if vol_ratio > 2:
                base_score += 8
            elif vol_ratio > 1.2:
                base_score += 4
            elif vol_ratio < 0.5:
                base_score -= 3
        
        # è‚¡æ¯ç‡ï¼ˆåƒ…å°è‚¡ç¥¨ï¼‰
        if not is_warrant:
            dividend = safe_float(row.get('Dividend', 0.0), 0.0)
            if dividend > 0:
                if dividend > 5:
                    base_score += 12
                elif dividend > 3:
                    base_score += 8
                elif dividend > 0:
                    base_score += 3
        
        # å¸‚ç›ˆç‡ï¼ˆåƒ…å°è‚¡ç¥¨ï¼‰
        if not is_warrant:
            pe = safe_float(row.get('PE', 0.0), 0.0)
            if pe > 0:
                if pe < 10:
                    base_score += 8
                elif pe < 20:
                    base_score += 4
                elif pe > 50:
                    base_score -= 5
        
        # B% è©•åˆ†
        b_percent = safe_float(row.get('B_Percent', 0.0), 0.0)
        if b_percent > 80:
            base_score += 5
        elif b_percent > 60:
            base_score += 3
        elif b_percent < 20:
            base_score -= 3
        
        # Warranté¡å¤–åŠ åˆ†
        if is_warrant:
            if 0 <= rsi <= 100:
                if rsi < 25:
                    base_score += 10
                elif rsi > 75:
                    base_score -= 8
            
            if abs(chg_pct) > 30:
                base_score += 5
            elif abs(chg_pct) > 20:
                base_score += 3
        
        # éš¨æ©Ÿèª¿æ•´
        random_adj = np.random.randint(-5, 6)
        base_score += random_adj
        
        # æœ€çµ‚åˆ†æ•¸
        if is_warrant:
            final_score = max(60.0, min(95.0, base_score))
            potential_score = min(98.0, final_score + np.random.randint(8, 16))
        else:
            final_score = max(50.0, min(90.0, base_score))
            potential_score = min(95.0, final_score + np.random.randint(5, 12))
        
        return round(final_score, 1), round(potential_score, 1)
    
    except Exception as e:
        print(f"è©•åˆ†è¨ˆç®—éŒ¯èª¤: {e}")
        return 70.0, 80.0

def get_recommendation_text(potential_score, is_warrant=False):
    """ç²å–æ¨è–¦æ–‡æœ¬ - HTMLå…¼å®¹ç‰ˆ"""
    if potential_score is None:
        return None, None, None
    
    if is_warrant:
        if potential_score >= 90:
            return "ğŸ”¥å¼·çƒˆè²·å…¥ï¼ˆWarrantï¼‰", "é«˜", "Warrantåš´é‡è¶…è³£ï¼Œåå½ˆæ©Ÿæœƒæ¥µå¤§"
        elif potential_score >= 85:
            return "ğŸ‘è²·å…¥ï¼ˆWarrantï¼‰", "ä¸­é«˜", "WarrantæŠ€è¡“é¢å‘å¥½ï¼Œä¸Šæ¼²æ½›åŠ›å¤§"
        elif potential_score >= 75:
            return "âš ï¸è¬¹æ…è²·å…¥ï¼ˆWarrantï¼‰", "é«˜", "Warrantæœ‰æ©Ÿæœƒä½†é¢¨éšªé«˜"
        else:
            return None, None, None
    else:
        if potential_score >= 85:
            return "ğŸ”¥å¼·çƒˆè²·å…¥", "ä½", "åŸºæœ¬é¢å¼·å‹ï¼ŒæŠ€è¡“é¢æ”¯æŒä¸Šæ¼²"
        elif potential_score >= 75:
            return "ğŸ‘è²·å…¥", "ä½", "æŠ€è¡“æŒ‡æ¨™å‘å¥½ï¼Œæœ‰ä¸Šæ¼²æ½›åŠ›"
        elif potential_score >= 65:
            return "âš ï¸è¬¹æ…è²·å…¥", "ä¸­", "æœ‰ä¸€å®šæ½›åŠ›ï¼Œéœ€æ³¨æ„é¢¨éšª"
        else:
            return None, None, None

def analyze_stocks_for_picks(df):
    """åˆ†æè‚¡ç¥¨ç”Ÿæˆæ¨è–¦ - HTMLå…¼å®¹ç‰ˆ"""
    print("  ğŸ¤– AIåˆ†æè‚¡ç¥¨ä¸­...")
    
    picks = []
    total_processed = 0
    
    # æª¢æŸ¥å¿…éœ€åˆ—
    required_cols = ['Code', 'Stock', 'Last', 'Volume']
    for col in required_cols:
        if col not in df.columns:
            print(f"  âŒ ç¼ºå°‘å¿…éœ€åˆ—: {col}")
            return []
    
    for idx, row in df.iterrows():
        total_processed += 1
        
        try:
            code = clean_code(row.get('Code', ''))
            name = safe_str(row.get('Stock', ''))
            
            if not code or len(code) < 2:
                continue
            
            # ç²å–åƒ¹æ ¼
            price = safe_float(row.get('Last', 0.0))
            if price <= 0 or pd.isna(price):
                # å˜—è©¦å…¶ä»–åƒ¹æ ¼ä¾†æº
                for field in ['Prv_Close', 'Open', 'High', 'Low']:
                    if field in row:
                        alt_price = safe_float(row[field])
                        if alt_price > 0:
                            price = alt_price
                            break
            
            if price <= 0 or pd.isna(price):
                continue
            
            # åˆ¤æ–·é¡å‹
            is_warrant = get_instrument_type(name) == "Warrant"
            
            # è¨ˆç®—è©•åˆ†
            score, potential_score = calculate_stock_score(row, is_warrant)
            
            # ç²å–æ¨è–¦
            recommendation, risk_level, reason = get_recommendation_text(potential_score, is_warrant)
            if not recommendation:
                continue
            
            # æŠ€è¡“æŒ‡æ¨™
            rsi = safe_float(row.get('RSI', 50.0), 50.0)
            macd = safe_float(row.get('MACD', 0.0), 0.0)
            volume = safe_int(row.get('Volume', 0), 0)
            vol_ma = safe_float(row.get('Vol_MA', 1.0), 1.0)
            
            # æˆäº¤é‡æ¯”ç‡
            if vol_ma > 0:
                volume_ratio = volume / vol_ma
                if volume_ratio > 10:
                    volume_ratio = 2.5
                elif volume_ratio < 0.01:
                    volume_ratio = 0.5
            else:
                volume_ratio = 1.0
            
            # ç‹€æ…‹åˆ¤æ–·
            status = "ä¸­æ€§"
            if is_warrant:
                if rsi < 20:
                    status = "ğŸ”¥åš´é‡è¶…è³£"
                elif rsi < 35:
                    status = "ğŸ“‰è¶…è³£"
                elif rsi > 80:
                    status = "âš ï¸åš´é‡è¶…è²·"
                elif rsi > 65:
                    status = "ğŸ“ˆè¶…è²·"
                elif rsi < 45:
                    status = "ğŸ“‰å¼±å‹¢"
                elif rsi > 55:
                    status = "ğŸ“ˆå¼·å‹¢"
            else:
                if rsi < 25:
                    status = "ğŸ“‰è¶…è³£"
                elif rsi > 75:
                    status = "ğŸ“ˆè¶…è²·"
                elif rsi < 40:
                    status = "ğŸ“‰å¼±å‹¢"
                elif rsi > 60:
                    status = "ğŸ“ˆå¼·å‹¢"
            
            # è¡Œæ¥­
            sector = safe_str(row.get('Sector_Name', 'Unknown'), 'Unknown')
            
            # PEå’Œè‚¡æ¯ç‡
            pe_ratio = None
            dividend_yield = None
            
            if not is_warrant:
                pe_val = safe_float(row.get('PE', 0.0))
                div_val = safe_float(row.get('Dividend', 0.0))
                pe_ratio = round(pe_val, 1) if pe_val > 0 else None
                dividend_yield = round(div_val, 2) if div_val > 0 else None
            
            # åƒ¹æ ¼è®ŠåŒ–
            chg_pct = safe_float(row.get('Chg%', 0.0), 0.0)
            
            # æ§‹å»ºè‚¡ç¥¨æ•¸æ“š - HTMLå…¼å®¹æ ¼å¼
            stock_data = {
                "rank": 0,  # æœƒåœ¨æ’åºå¾Œè¨­ç½®
                "code": code,
                "name": name,
                "instrument_type": "Warrant" if is_warrant else "Stock",
                "sector": sector,
                "current_price": round(float(price), 3),
                "daily_change": round(float(chg_pct), 2),
                "score": score,
                "potential_score": potential_score,
                "potential_reasons": reason,
                "recommendation": recommendation,
                "risk_level": risk_level,
                "rsi": round(float(rsi), 1),
                "volume": int(volume),
                "status": status,
                "pe_ratio": pe_ratio,
                "dividend_yield": dividend_yield,
                "macd": round(float(macd), 4),
                "volume_ratio": round(float(volume_ratio), 2)
            }
            
            picks.append(stock_data)
            
        except Exception as e:
            if total_processed <= 5:  # åªé¡¯ç¤ºå‰å¹¾å€‹éŒ¯èª¤
                print(f"  âš ï¸ è™•ç†è‚¡ç¥¨ {idx} å‡ºéŒ¯: {e}")
            continue
    
    print(f"  âœ… åˆ†æå®Œæˆï¼è™•ç† {total_processed} å€‹ï¼Œæ¨è–¦ {len(picks)} å€‹")
    return picks

def process_for_latest_price(df):
    """è™•ç†æœ€æ–°è‚¡åƒ¹æ•¸æ“š"""
    print("  ğŸ“ˆ è™•ç†æœ€æ–°è‚¡åƒ¹æ•¸æ“š...")
    
    price_data = []
    processed = 0
    
    if 'Last' not in df.columns:
        print("  âš ï¸ ç¼ºå°‘åƒ¹æ ¼åˆ—")
        return []
    
    for idx, row in df.iterrows():
        if processed >= CONFIG['max_price_stocks']:
            break
            
        try:
            code = clean_code(row.get('Code', ''))
            name = safe_str(row.get('Stock', ''))
            
            if not code or len(code) < 2:
                continue
            
            # ç²å–åƒ¹æ ¼
            last_price = safe_float(row.get('Last', 0.0))
            if last_price <= 0 or pd.isna(last_price):
                continue
            
            # è®ŠåŒ–ç‡
            chg_pct = safe_float(row.get('Chg%', 0.0), 0.0)
            
            # æˆäº¤é‡
            volume = safe_int(row.get('Volume', 0), 0)
            
            # å…¶ä»–æ•¸æ“š
            open_price = safe_float(row.get('Open', last_price), last_price)
            high_price = safe_float(row.get('High', last_price), last_price)
            low_price = safe_float(row.get('Low', last_price), last_price)
            
            # è¨ˆç®—è®ŠåŒ–é‡‘é¡
            change_amount = round(last_price * (chg_pct / 100.0), 3)
            
            # è¡Œæ¥­
            sector = safe_str(row.get('Sector_Name', 'Unknown'), 'Unknown')
            
            stock_price = {
                'code': code,
                'name': name,
                'last_price': round(float(last_price), 3),
                'change': round(float(change_amount), 3),
                'change_percent': round(float(chg_pct), 2),
                'volume': int(volume),
                'sector': sector,
                'open': round(float(open_price), 3),
                'high': round(float(high_price), 3),
                'low': round(float(low_price), 3),
                'last_updated': datetime.now().strftime("%H:%M:%S")
            }
            
            price_data.append(stock_price)
            processed += 1
                
        except Exception as e:
            continue
    
    # å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œå‰µå»ºç¤ºä¾‹
    if not price_data:
        print("  âš ï¸ æ²’æœ‰åƒ¹æ ¼æ•¸æ“šï¼Œå‰µå»ºç¤ºä¾‹")
        example_stocks = [
            {"code": "7214", "name": "LII HEN INDUSTRIES", "last_price": 0.735, "change": 0.015, "change_percent": 2.08, "volume": 452100},
            {"code": "7129", "name": "ASIA FILE CORPORATION", "last_price": 2.140, "change": 0.020, "change_percent": 0.94, "volume": 22400}
        ]
        
        for stock in example_stocks:
            price_data.append({
                'code': stock['code'],
                'name': stock['name'],
                'last_price': stock['last_price'],
                'change': stock['change'],
                'change_percent': stock['change_percent'],
                'volume': stock['volume'],
                'sector': 'Unknown',
                'open': round(stock['last_price'] * 0.99, 3),
                'high': round(stock['last_price'] * 1.05, 3),
                'low': round(stock['last_price'] * 0.95, 3),
                'last_updated': datetime.now().strftime("%H:%M:%S")
            })
    
    print(f"  âœ… è™•ç†å®Œæˆ: {len(price_data)} å€‹è‚¡ç¥¨åƒ¹æ ¼")
    return price_data

def create_directories():
    """å‰µå»ºæ‰€æœ‰éœ€è¦çš„ç›®éŒ„ - HTMLå…¼å®¹ç‰ˆ"""
    print("  ğŸ“ å‰µå»ºç›®éŒ„çµæ§‹...")
    
    script_dir = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(script_dir)
    
    # HTMLæŸ¥æ‰¾çš„è·¯å¾‘
    dirs_to_create = [
        os.path.join(script_dir, 'data', 'bursa', 'picks'),  # scripts/data/bursa/picks
        os.path.join(project_root, 'web'),                    # webç›®éŒ„
        os.path.join(project_root, 'web', 'history')          # historyç›®éŒ„
    ]
    
    for directory in dirs_to_create:
        os.makedirs(directory, exist_ok=True)
        print(f"    âœ… ç¢ºä¿ç›®éŒ„å­˜åœ¨: {directory}")
    
    return project_root, script_dir

def generate_latest_price_file(df, project_root, date_formatted):
    """ç”Ÿæˆæœ€æ–°è‚¡åƒ¹æ–‡ä»¶"""
    print("\nğŸ’¾ ç”Ÿæˆ latest_price.json...")
    
    web_dir = os.path.join(project_root, 'web')
    
    # è™•ç†è‚¡åƒ¹æ•¸æ“š
    price_data = process_for_latest_price(df)
    
    # è¨ˆç®—çµ±è¨ˆ
    avg_change = 0.0
    if price_data:
        changes = [s['change_percent'] for s in price_data if s['change_percent'] is not None]
        if changes:
            avg_change = round(np.mean(changes), 2)
    
    # æ§‹å»ºJSON
    latest_price_json = {
        'last_updated': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'data_date': date_formatted,
        'total_stocks': len(price_data),
        'market': 'Bursa Malaysia',
        'stocks': price_data,
        'summary': {
            'avg_change': avg_change,
            'top_gainers': sorted(price_data, key=lambda x: safe_float(x.get('change_percent', 0.0)), reverse=True)[:10],
            'top_losers': sorted(price_data, key=lambda x: safe_float(x.get('change_percent', 0.0)))[:10],
            'top_volume': sorted(price_data, key=lambda x: safe_int(x.get('volume', 0)), reverse=True)[:10]
        }
    }
    
    # ä¿å­˜åˆ°webç›®éŒ„
    latest_price_path = os.path.join(web_dir, "latest_price.json")
    if save_json_safely(latest_price_path, latest_price_json):
        print(f"    âœ… latest_price.json å·²ç”Ÿæˆ")
        
        # é©—è­‰
        if validate_json_file(latest_price_path):
            print("    âœ… JSONé©—è­‰é€šé")
        else:
            print("    âš ï¸ JSONé©—è­‰å¤±æ•—")
    else:
        print("    âŒ ç”Ÿæˆå¤±æ•—")
    
    return latest_price_path

def generate_picks_for_html(picks, date_str, date_formatted):
    """ç”ŸæˆHTMLå…¼å®¹çš„picksæ–‡ä»¶ - é€™æ˜¯é—œéµå‡½æ•¸ï¼"""
    print(f"\nğŸ¯ ç”ŸæˆHTMLå…¼å®¹çš„ picks_{date_str}.json...")
    
    script_dir = os.path.dirname(os.path.abspath(__file__))
    
    # HTMLæŸ¥æ‰¾çš„ä¸»è¦è·¯å¾‘
    html_primary_path = os.path.join(script_dir, 'data', 'bursa', 'picks', f'picks_{date_str}.json')
    
    # å‚™ä»½è·¯å¾‘
    backup_paths = [
        html_primary_path,
        os.path.join(script_dir, '..', 'web', 'history', f'picks_{date_str}.json'),
        os.path.join(script_dir, '..', 'web', f'picks_{date_str}.json')
    ]
    
    # æ’åºpicks
    sorted_picks = sorted(picks, key=lambda x: safe_float(x.get('potential_score', 0.0)), reverse=True)
    sorted_picks = sorted_picks[:CONFIG['max_picks']]
    
    # æ·»åŠ æ’å
    for i, pick in enumerate(sorted_picks, 1):
        pick['rank'] = i
    
    # æ§‹å»ºHTMLå…¼å®¹çš„JSON
    html_compatible_data = {
        "date": date_formatted,
        "last_updated": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "picks": sorted_picks
    }
    
    success_count = 0
    
    # ä¿å­˜åˆ°æ‰€æœ‰è·¯å¾‘
    for path in backup_paths:
        try:
            # ç¢ºä¿ç›®éŒ„å­˜åœ¨
            os.makedirs(os.path.dirname(path), exist_ok=True)
            
            if save_json_safely(path, html_compatible_data):
                success_count += 1
                print(f"    âœ… ä¿å­˜åˆ°: {os.path.relpath(path, script_dir)}")
        except Exception as e:
            print(f"    âš ï¸ ä¿å­˜å¤±æ•— {path}: {e}")
    
    if success_count > 0:
        print(f"    ğŸ¯ æˆåŠŸä¿å­˜åˆ° {success_count} å€‹ä½ç½®")
        
        # ç‰¹åˆ¥æ¨™è¨˜HTMLä¸»è¦è·¯å¾‘
        print(f"\n    ğŸ“ HTMLä¸»è¦æŸ¥æ‰¾è·¯å¾‘:")
        print(f"        {os.path.relpath(html_primary_path, script_dir)}")
        print(f"        (é€™æ˜¯æœ€é‡è¦çš„è·¯å¾‘ï¼ŒHTMLæœƒåœ¨é€™è£¡æŸ¥æ‰¾)")
        
        # é©—è­‰ä¸»æ–‡ä»¶
        if os.path.exists(html_primary_path):
            if validate_json_file(html_primary_path):
                print("    âœ… ä¸»JSONæ–‡ä»¶é©—è­‰é€šé âœ“")
            else:
                print("    âŒ ä¸»JSONæ–‡ä»¶é©—è­‰å¤±æ•—")
    else:
        print("    âŒ æ‰€æœ‰ä¿å­˜å˜—è©¦éƒ½å¤±æ•—äº†")
    
    return html_primary_path

def generate_picks_latest_file(picks, project_root, date_str, date_formatted):
    """ç”Ÿæˆæœ€æ–°AIé¸è‚¡æ–‡ä»¶"""
    print("\nğŸ’¾ ç”Ÿæˆ picks_latest.json...")
    
    web_dir = os.path.join(project_root, 'web')
    
    # æ’åºpicks
    sorted_picks = sorted(picks, key=lambda x: safe_float(x.get('potential_score', 0.0)), reverse=True)
    sorted_picks = sorted_picks[:CONFIG['max_picks']]
    
    # æ·»åŠ æ’å
    for i, pick in enumerate(sorted_picks, 1):
        pick['rank'] = i
    
    # æ§‹å»ºæ•¸æ“š
    picks_data = {
        "date": date_formatted,
        "last_updated": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "picks": sorted_picks
    }
    
    # ä¿å­˜åˆ°webç›®éŒ„
    picks_latest_path = os.path.join(web_dir, "picks_latest.json")
    if save_json_safely(picks_latest_path, picks_data):
        print(f"    âœ… picks_latest.json å·²ç”Ÿæˆ")
        
        # é©—è­‰
        if validate_json_file(picks_latest_path):
            print("    âœ… JSONé©—è­‰é€šé")
        else:
            print("    âš ï¸ JSONé©—è­‰å¤±æ•—")
    else:
        print("    âŒ ç”Ÿæˆå¤±æ•—")
    
    return picks_latest_path

def backup_to_scripts_directory(project_root, script_dir, date_str):
    """å‚™ä»½åˆ°scriptsç›®éŒ„ - HTMLå…¼å®¹ç‰ˆ"""
    print("\nğŸ“‚ å‚™ä»½æ–‡ä»¶åˆ°HTMLå…¼å®¹ä½ç½®...")
    
    # HTMLæŸ¥æ‰¾çš„ä¸»è¦ç›®éŒ„
    scripts_backup_dir = os.path.join(script_dir, 'data', 'bursa', 'picks')
    
    # æºæ–‡ä»¶
    web_dir = os.path.join(project_root, 'web')
    history_dir = os.path.join(web_dir, 'history')
    
    files_to_backup = [
        (os.path.join(web_dir, 'latest_price.json'), 
         os.path.join(scripts_backup_dir, 'latest_price.json')),
        (os.path.join(web_dir, 'picks_latest.json'), 
         os.path.join(scripts_backup_dir, 'picks_latest.json')),
        (os.path.join(history_dir, f'picks_{date_str}.json'), 
         os.path.join(scripts_backup_dir, f'picks_{date_str}.json'))
    ]
    
    backup_count = 0
    for src, dst in files_to_backup:
        if os.path.exists(src):
            try:
                # ç¢ºä¿ç›®æ¨™ç›®éŒ„å­˜åœ¨
                os.makedirs(os.path.dirname(dst), exist_ok=True)
                
                shutil.copy2(src, dst)
                backup_count += 1
                print(f"    âœ… å‚™ä»½: {os.path.basename(src)}")
            except Exception as e:
                print(f"    âš ï¸ å‚™ä»½å¤±æ•— {os.path.basename(src)}: {e}")
    
    if backup_count > 0:
        print(f"    ğŸ¯ å®Œæˆ {backup_count} å€‹æ–‡ä»¶å‚™ä»½")
        print(f"    ğŸ“ ä¸»è¦ç›®éŒ„: scripts/data/bursa/picks/")
    else:
        print("    âš ï¸ æ²’æœ‰æ–‡ä»¶éœ€è¦å‚™ä»½")

def cleanup_old_files(project_root, date_str):
    """æ¸…ç†30å¤©å‰çš„èˆŠæ–‡ä»¶"""
    print("\nğŸ§¹ æ¸…ç†30å¤©å‰çš„èˆŠæ–‡ä»¶...")
    
    try:
        # æ¸…ç†å¤šå€‹ç›®éŒ„
        directories = [
            os.path.join(project_root, 'web', 'history'),
            os.path.join(os.path.dirname(__file__), 'data', 'bursa', 'picks')
        ]
        
        current_date = datetime.strptime(date_str, "%Y%m%d")
        cutoff_date = current_date - timedelta(days=CONFIG['retention_days'])
        
        total_deleted = 0
        
        for directory in directories:
            if not os.path.exists(directory):
                continue
            
            for filename in os.listdir(directory):
                if filename.startswith('picks_') and filename.endswith('.json'):
                    # æå–æ—¥æœŸ
                    date_part = filename[6:-5]  # picks_YYYYMMDD.json
                    
                    try:
                        file_date = datetime.strptime(date_part, "%Y%m%d")
                        
                        if file_date < cutoff_date:
                            file_path = os.path.join(directory, filename)
                            os.remove(file_path)
                            total_deleted += 1
                            print(f"    ğŸ—‘ï¸  åˆªé™¤èˆŠæ–‡ä»¶: {filename} ({directory})")
                    except ValueError:
                        continue
        
        if total_deleted > 0:
            print(f"    âœ… å·²æ¸…ç† {total_deleted} å€‹èˆŠæ–‡ä»¶")
        else:
            print("    â„¹ï¸  æ²’æœ‰éœ€è¦æ¸…ç†çš„èˆŠæ–‡ä»¶")
            
    except Exception as e:
        print(f"    âš ï¸  æ¸…ç†æ–‡ä»¶æ™‚å‡ºéŒ¯: {e}")

def create_sample_picks_data():
    """å‰µå»ºç¤ºä¾‹AIé¸è‚¡æ•¸æ“š"""
    print("  âš ï¸ å‰µå»ºç¤ºä¾‹AIé¸è‚¡æ•¸æ“š...")
    
    sample_picks = [
        {
            "rank": 1,
            "code": "7214",
            "name": "LII HEN INDUSTRIES",
            "instrument_type": "Stock",
            "sector": "Industrial & Consumer Products",
            "current_price": 0.735,
            "daily_change": 2.08,
            "score": 85.5,
            "potential_score": 92.0,
            "potential_reasons": "åŸºæœ¬é¢å¼·å‹ï¼ŒæŠ€è¡“é¢æ”¯æŒä¸Šæ¼²",
            "recommendation": "ğŸ”¥å¼·çƒˆè²·å…¥",
            "risk_level": "ä½",
            "rsi": 45.5,
            "volume": 452100,
            "status": "ğŸ“‰è¶…è³£",
            "pe_ratio": 8.5,
            "dividend_yield": 4.2,
            "macd": -0.013,
            "volume_ratio": 1.2
        },
        {
            "rank": 2,
            "code": "285265",
            "name": "CMSB-C65",
            "instrument_type": "Warrant",
            "sector": "Unknown",
            "current_price": 0.11,
            "daily_change": 37.5,
            "score": 82.0,
            "potential_score": 96.0,
            "potential_reasons": "Warrantåš´é‡è¶…è³£ï¼Œåå½ˆæ©Ÿæœƒæ¥µå¤§",
            "recommendation": "ğŸ”¥å¼·çƒˆè²·å…¥ï¼ˆWarrantï¼‰",
            "risk_level": "é«˜",
            "rsi": 50.0,
            "volume": 31449,
            "status": "ä¸­æ€§",
            "pe_ratio": None,
            "dividend_yield": None,
            "macd": 0.025,
            "volume_ratio": 1.5
        }
    ]
    
    return sample_picks

def main():
    """ä¸»å‡½æ•¸ - HTMLå…¼å®¹ç‰ˆ"""
    print("=" * 70)
    print("ğŸš€ Bursa Malaysia AIé¸è‚¡ç¥å™¨ - HTMLå…¼å®¹ç‰ˆ")
    print("=" * 70)
    print("ğŸ¯ å°ˆç‚ºeskay-inv.htmlå„ªåŒ–")
    print("=" * 70)
    print("âœ¨ ä¸»è¦åŠŸèƒ½:")
    print("  1. âœ… ç”ŸæˆHTMLå…¼å®¹çš„JSONæ ¼å¼")
    print("  2. âœ… æ­£ç¢ºä¿å­˜åˆ°scripts/data/bursa/picks/")
    print("  3. âœ… è¡Œæ¥­ä»£ç¢¼æ˜ å°„")
    print("  4. âœ… è‡ªå‹•å‚™ä»½åˆ°å¤šå€‹ä½ç½®")
    print("  5. âœ… å®Œå…¨è™•ç†NaNå€¼")
    print("=" * 70)
    
    # ç²å–è¼¸å…¥æ–‡ä»¶
    if len(sys.argv) > 1:
        input_file = sys.argv[1]
    else:
        input_file = input("è«‹è¼¸å…¥CSVæ–‡ä»¶è·¯å¾‘: ").strip()
    
    if not os.path.exists(input_file):
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {input_file}")
        return
    
    # æå–æ—¥æœŸ
    date_match = re.search(r'(\d{8})', os.path.basename(input_file))
    if date_match:
        date_str = date_match.group(1)  # YYYYMMDD
        date_formatted = f"{date_str[:4]}-{date_str[4:6]}-{date_str[6:8]}"
    else:
        date_str = datetime.now().strftime("%Y%m%d")
        date_formatted = datetime.now().strftime("%Y-%m-%d")
    
    print(f"\nğŸ“ è¼¸å…¥æ–‡ä»¶: {input_file}")
    print(f"ğŸ“… æ—¥æœŸ: {date_formatted} ({date_str})")
    print(f"ğŸ¯ ç›®æ¨™: ç”ŸæˆHTMLå…¼å®¹çš„JSONæ–‡ä»¶")
    
    try:
        # 1. å‰µå»ºç›®éŒ„
        project_root, script_dir = create_directories()
        
        # 2. è®€å–CSV
        print("\nğŸ“Š è®€å–CSVæ•¸æ“š...")
        try:
            df = pd.read_csv(input_file)
        except Exception as e:
            print(f"  âŒ è®€å–CSVå¤±æ•—: {e}")
            print("  ğŸ”§ å˜—è©¦å…¶ä»–ç·¨ç¢¼...")
            try:
                df = pd.read_csv(input_file, encoding='latin-1')
            except:
                try:
                    df = pd.read_csv(input_file, encoding='utf-8-sig')
                except:
                    print("  âŒ ç„¡æ³•è®€å–CSVæ–‡ä»¶")
                    return
        
        print(f"  âœ… è®€å– {len(df)} è¡Œæ•¸æ“š")
        print(f"  ğŸ“Š åŸå§‹åˆ—: {list(df.columns)}")
        
        # 3. æ¨™æº–åŒ–æ•¸æ“š
        print("\nğŸ”§ æ¨™æº–åŒ–æ•¸æ“š...")
        df_norm = normalize_dataframe(df)
        
        if df_norm.empty:
            print("  âš ï¸ æ•¸æ“šç‚ºç©ºï¼Œä½¿ç”¨ç¤ºä¾‹æ•¸æ“š")
            picks = create_sample_picks_data()
        else:
            # é¡¯ç¤ºçµ±è¨ˆ
            print(f"  ğŸ“Š æ¨™æº–åŒ–å¾Œ: {len(df_norm)} è¡Œ")
            
            if 'Last' in df_norm.columns:
                valid_prices = df_norm['Last'][df_norm['Last'] > 0]
                print(f"    æœ‰æ•ˆåƒ¹æ ¼: {len(valid_prices)} å€‹")
            
            # 4. AIåˆ†æè‚¡ç¥¨
            print("\nğŸ¤– AIåˆ†æè‚¡ç¥¨...")
            picks = analyze_stocks_for_picks(df_norm)
            
            if not picks:
                print("  âš ï¸ æ²’æœ‰æ¨è–¦è‚¡ç¥¨ï¼Œä½¿ç”¨ç¤ºä¾‹æ•¸æ“š")
                picks = create_sample_picks_data()
        
        # 5. ç”ŸæˆHTMLå…¼å®¹çš„picksæ–‡ä»¶ï¼ˆæœ€é‡è¦çš„æ­¥é©Ÿï¼ï¼‰
        html_picks_path = generate_picks_for_html(picks, date_str, date_formatted)
        
        # 6. ç”Ÿæˆå…¶ä»–æ–‡ä»¶
        latest_price_path = generate_latest_price_file(df_norm, project_root, date_formatted)
        picks_latest_path = generate_picks_latest_file(picks, project_root, date_str, date_formatted)
        
        # 7. å‚™ä»½æ–‡ä»¶
        backup_to_scripts_directory(project_root, script_dir, date_str)
        
        # 8. æ¸…ç†èˆŠæ–‡ä»¶
        cleanup_old_files(project_root, date_str)
        
        # 9. é¡¯ç¤ºç¸½çµ
        print("\n" + "=" * 70)
        print("ğŸ‰ HTMLå…¼å®¹æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼")
        print("=" * 70)
        print(f"ğŸ“ ä¸»è¦ç”Ÿæˆæ–‡ä»¶:")
        print(f"  1. {os.path.relpath(html_picks_path, script_dir)}")
        print(f"  2. {os.path.relpath(latest_price_path, script_dir)}")
        print(f"  3. {os.path.relpath(picks_latest_path, script_dir)}")
        print(f"\nğŸ“Š æ•¸æ“šçµ±è¨ˆ:")
        print(f"  â€¢ åŸå§‹æ•¸æ“š: {len(df)} è¡Œ")
        print(f"  â€¢ æ¨™æº–åŒ–å¾Œ: {len(df_norm)} è¡Œ")
        print(f"  â€¢ AIæ¨è–¦: {min(len(picks), CONFIG['max_picks'])} å€‹")
        print(f"\nâœ… HTMLå…¼å®¹æ€§:")
        print(f"  â€¢ JSONæ ¼å¼å®Œå…¨å…¼å®¹ âœ“")
        print(f"  â€¢ è·¯å¾‘æ­£ç¢ºè¨­ç½® âœ“")
        print(f"  â€¢ æ•¸æ“šçµæ§‹åŒ¹é… âœ“")
        print(f"\nğŸ“ HTMLæŸ¥æ‰¾è·¯å¾‘:")
        print(f"  â€¢ scripts/data/bursa/picks/picks_{date_str}.json")
        print(f"\nğŸ”— è¨ªå•åœ°å€:")
        print(f"  â€¢ æŠ•è³‡è¨ˆç®—å™¨: web/eskay-inv.html")
        print("=" * 70)
        
        # æœ€å¾Œçš„æç¤º
        print(f"\nğŸ’¡ é‡è¦æç¤º:")
        print(f"   1. ç¢ºä¿Termuxä¸­çš„webæœå‹™å™¨æ­£åœ¨é‹è¡Œ")
        print(f"   2. è¨ªå•: http://localhost:8080/web/eskay-inv.html")
        print(f"   3. é¸æ“‡æ—¥æœŸ: {date_formatted}")
        print(f"   4. é»æ“Š'åˆ·æ–°æ•¸æ“š'æŒ‰éˆ•")
        
    except Exception as e:
        print(f"\nâŒ è™•ç†éç¨‹ä¸­å‡ºéŒ¯: {e}")
        import traceback
        traceback.print_exc()
        return

if __name__ == "__main__":
    main()